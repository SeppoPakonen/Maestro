@startuml
!include _shared.puml

title AST/TU Refactor/Transform/Autocomplete Operations

start
BRANCH_GUARD("operational rule")
:ENTRY_WF_07;

:Select package for TU analysis;
:maestro tu build;
:maestro tu query/rename/transform/autocomplete;

:Parse source files with AST flags;
:Generate AST representation;

:Store AST in cache;
:Build symbol index;
:Resolve cross-references;

note right
  Prerequisites:
  - Repo Resolve (WF-05)
  - RepoConf config selection
  - Build OK
end note

:Build index from AST output;

note left: TU Generation Loop
repeat
  :Parse file with AST flags;
  :Generate AST;
  :Store AST in index;
  if (TU build fails?) then (yes)
    note right: Hard stop if TU build fails
    stop
  endif
repeat while (more translation units?)

:Merge ASTs into index;

note left: Branching to Operations
if (Rename operation?) then (yes)
  :Query symbol references;
  :Get reference list;
  :Apply renames to files;
  :Verify rename;
  if (Verification passes?) then (yes)
    :Success;
  else (no)
    note right: HARD STOP - verification failed
    stop
  endif
elseif (Transform operation?) then (yes)
  :Analyze dependencies;
  :Get dependency graph;
  note right: Pre-step: Normalize memory model
  :Transform files;
  :Update includes;
  :Transform complete;
elseif (Autocomplete operation?) then (yes)
  :Request completions;
  :Map cursor to AST node;
  :Get scope and symbols;
  :Completions list;
endif

note right
  All operations have hard stops
  for TU build failures,
  symbol ambiguities,
  and verification failures
end note

:EXIT_WF_07;
stop

@enduml