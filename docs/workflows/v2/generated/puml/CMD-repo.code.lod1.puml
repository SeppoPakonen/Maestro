@startuml
!theme plain
skinparam backgroundColor #FFFFFF
skinparam defaultFontName Arial
skinparam ArrowColor #333333
skinparam NoteBorderColor #CCCCCC
skinparam NoteBackgroundColor #FFFFCC

title CMD-repo - repo deep internal flow (observed) (LOD1: Code Functions)

note right
  **Source:** [[docs/workflows/v2/ir/cmd/CMD-repo.code.yaml docs/workflows/v2/ir/cmd/CMD-repo.code.yaml]]
end note

rectangle "Main command handler\n(maestro.commands.repo)" as handle_repo_command
rectangle "Repository scanner\n(maestro.repo.scanner)" as scan_upp_repo_v2
rectangle "Write scan results\n(maestro.commands.repo)" as write_repo_artifacts
rectangle "Load repo index\n(maestro.commands.repo)" as load_repo_index
rectangle "Find repo root\n(maestro.commands.repo)" as find_repo_root
rectangle "Update global index\n(maestro.global_index)" as update_global_repo_index
rectangle "Build hierarchy\n(maestro.commands.repo)" as build_repo_hierarchy
rectangle "Load hierarchy\n(maestro.commands.repo)" as load_hierarchy
rectangle "Load hierarchy overrides\n(maestro.commands.repo)" as load_hierarchy_overrides
rectangle "Merge hierarchy overrides\n(maestro.commands.repo)" as merge_hierarchy_overrides
rectangle "Package subcommands\n(maestro.commands.repo)" as handle_repo_pkg_*
rectangle "Hierarchy subcommands\n(maestro.commands.repo)" as handle_repo_hier_*
rectangle "Rules subcommands\n(maestro.commands.repo)" as handle_repo_rules_*
rectangle "Conventions subcommands\n(maestro.commands.repo)" as handle_repo_conventions_*
handle_repo_command --> find_repo_root
handle_repo_command --> scan_upp_repo_v2
scan_upp_repo_v2 --> write_repo_artifacts
handle_repo_command --> load_repo_index
handle_repo_refresh_all --> update_global_repo_index
handle_repo_command --> build_repo_hierarchy
build_repo_hierarchy --> load_hierarchy
handle_repo_command --> load_hierarchy_overrides
handle_repo_command --> merge_hierarchy_overrides
handle_repo_command --> handle_repo_pkg_*
handle_repo_command --> handle_repo_hier_*
handle_repo_command --> handle_repo_rules_*
handle_repo_command --> handle_repo_conventions_*
handle_repo_hier_* --> editor

note left
  **Evidence:**
  * [[v1/internal/deep/cmd_repo_deep.md cmd_repo_deep.md]]
  * [[v1/internal/deep/cmd_repo_deep.puml cmd_repo_deep.puml]]
end note

note right #FFE6E6
  **âš  Ledger Hints:**
  * Observed .maestro directory usage in cmd_repo deep flow; violates FORBID_REPO_DO
  
  [[../../IMPLEMENTATION_LEDGER.md IMPLEMENTATION_LEDGER]]
  [[../../reports/ledger_candidates.md Ledger Candidates]]
end note

@enduml
