# WF-14: Branch Safety Guardrails â€” Branch-bound State

## Short Intent
This workflow documents the branch safety guardrails that prevent branch switching during active work sessions.

## Preconditions
- Repository is a Git repo
- Work sessions are stored in repo truth
- User can identify the work session ID

## Steps Table

| Step | Command | Why | Gates |
|------|---------|-----|-------|
| 1 | `maestro work` | Start a work session and capture branch identity | GIT_REPO_GATE |
| 2 | `git checkout feature/other-branch` | Simulate a branch switch during active work | BRANCH_SWITCH_FORBIDDEN |
| 3 | `maestro work --resume "<session_id>"` | Attempt to resume on a different branch (should hard stop) | BRANCH_IDENTITY_GATE |

## Expected Internal Flow (Coarse)

- Work session captures branch and commit identity
- Branch switch creates mismatch against stored identity
- Resume detects mismatch and blocks continuation

## Data Touches

### Stores Read
- `REPO_TRUTH_DOCS_MAESTRO` - Read session metadata

### Stores Write
- `REPO_TRUTH_DOCS_MAESTRO` - Store session identity snapshot

## Open Questions / Unknowns

- Is `maestro work --resume` the correct resume flag?
- What is the exact gate name for branch mismatch enforcement?
- Does `maestro work` store session identity in `./docs/maestro/session_store.json` or another file?

## Trace Block

```yaml
trace:
  - user: "maestro work"
    gates: ["GIT_REPO_GATE"]
    stores_write: ["REPO_TRUTH_DOCS_MAESTRO"]
    internal: ["UNKNOWN"]
  - user: "git checkout feature/other-branch"
    gates: ["BRANCH_SWITCH_FORBIDDEN"]
    internal: ["UNKNOWN"]
  - user: "maestro work --resume \"<session_id>\""
    gates: ["BRANCH_IDENTITY_GATE"]
    stores_read: ["REPO_TRUTH_DOCS_MAESTRO"]
    internal: ["UNKNOWN"]
```
