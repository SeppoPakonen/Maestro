# WF-15: Work â†” wsession Cookie Protocol (File-based Polling)

## Short Intent
This workflow documents how `maestro work` and `maestro wsession` communicate using a cookie-based, file-backed protocol.

## Preconditions
- Repository is adopted
- Work session storage is available under repo truth
- User can capture the session cookie

## Steps Table

| Step | Command | Why | Gates |
|------|---------|-----|-------|
| 1 | `maestro work` | Start a work session and obtain the cookie | WSESSION_COOKIE_REQUIRED |
| 2 | `maestro wsession log --cookie "<session_id>" --message "status ping"` | Send a breadcrumb message into the work session inbox | WSESSION_COOKIE_REQUIRED |
| 3 | `maestro wsession list --cookie "<session_id>"` | Poll for breadcrumbs for the work session | WSESSION_COOKIE_REQUIRED |
| 4 | `maestro wsession ack --cookie "<session_id>" --breadcrumb "<id>"` | Acknowledge a processed breadcrumb | WSESSION_COOKIE_REQUIRED |

## Expected Internal Flow (Coarse)

- `maestro work` creates a session cookie and inbox
- `maestro wsession` uses the cookie to write breadcrumbs
- Work process polls the inbox and validates breadcrumb schema
- Valid breadcrumbs update session state

## Data Touches

### Stores Read
- `REPO_TRUTH_DOCS_MAESTRO` - Read session state and inbox

### Stores Write
- `REPO_TRUTH_DOCS_MAESTRO` - Write breadcrumbs and session updates

## Open Questions / Unknowns

- Is `maestro wsession log` the correct subcommand for writing breadcrumbs?
- Is `maestro wsession list` the correct polling command?
- Is there a formal `ack` command for breadcrumbs?
- Does the cookie live in `docs/sessions/<id>/` or another directory?

## Trace Block

```yaml
trace:
  - user: "maestro work"
    gates: ["WSESSION_COOKIE_REQUIRED"]
    stores_write: ["REPO_TRUTH_DOCS_MAESTRO"]
    internal: ["UNKNOWN"]
  - user: "maestro wsession log --cookie \"<session_id>\" --message \"status ping\""
    gates: ["WSESSION_COOKIE_REQUIRED"]
    stores_write: ["REPO_TRUTH_DOCS_MAESTRO"]
    internal: ["UNKNOWN"]
  - user: "maestro wsession list --cookie \"<session_id>\""
    gates: ["WSESSION_COOKIE_REQUIRED"]
    stores_read: ["REPO_TRUTH_DOCS_MAESTRO"]
    internal: ["UNKNOWN"]
  - user: "maestro wsession ack --cookie \"<session_id>\" --breadcrumb \"<id>\""
    gates: ["WSESSION_COOKIE_REQUIRED"]
    stores_write: ["REPO_TRUTH_DOCS_MAESTRO"]
    internal: ["UNKNOWN"]
```
