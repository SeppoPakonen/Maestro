# WF-09: Storage Contract â€” Repo Truth vs Home Hub

## Short Intent
This workflow captures how Maestro selects the storage backend (repo truth vs home hub) and enforces the hard stop if `./.maestro` exists.

## Preconditions
- Repository exists (adopted or read-only)
- User has permission to read the repository
- `./.maestro` must not exist

## Steps Table

| Step | Command | Why | Gates |
|------|---------|-----|-------|
| 1 | `maestro init --readonly` | Enter read-only mode to exercise home hub storage | READONLY_GUARD, FORBID_DOT_MAESTRO |
| 2 | `maestro repo resolve --level lite --readonly` | Populate home hub with repo model data | REPO_RESOLVE_LITE, READONLY_GUARD, FORBID_DOT_MAESTRO |
| 3 | `maestro issue list --readonly` | Read issue data from the home hub store | READONLY_GUARD, FORBID_DOT_MAESTRO |
| 4 | `maestro init` | Adopt the repository and enable repo truth storage | REPOCONF_GATE, FORBID_DOT_MAESTRO |
| 5 | `maestro repo resolve --level lite` | Populate repo truth under `./docs/maestro/` | REPO_RESOLVE_LITE, FORBID_DOT_MAESTRO |
| 6 | `maestro task list` | Read task data from repo truth | REPOCONF_GATE, FORBID_DOT_MAESTRO |

## Expected Internal Flow (Coarse)

- Hard stop if `./.maestro` exists
- If `./docs/maestro/` is missing, fall back to home hub storage
- Read-only commands persist results under the home hub registry
- Adopted repos store state under `./docs/maestro/`

## Data Touches

### Stores Read
- `REPO_TRUTH_DOCS_MAESTRO` - When adopted, read repo truth state
- `HOME_HUB_REPO` - When read-only, read home hub state

### Stores Write
- `HOME_HUB_REPO` - Read-only scans and results
- `REPO_TRUTH_DOCS_MAESTRO` - Adopted repo truth data

## Open Questions / Unknowns

- Does `maestro init --readonly` exist, or is there another read-only entrypoint?
- Is `maestro issue list --readonly` the correct command for home hub inspection?
- Is `maestro task list` the correct command for repo truth task listing?
- Should the hard stop gate name be `FORBID_DOT_MAESTRO` or something else?

## Trace Block

```yaml
trace:
  - user: "maestro init --readonly"
    gates: ["READONLY_GUARD", "FORBID_DOT_MAESTRO"]
    stores_write: ["HOME_HUB_REPO"]
    internal: ["UNKNOWN"]
  - user: "maestro repo resolve --level lite --readonly"
    gates: ["REPO_RESOLVE_LITE", "READONLY_GUARD", "FORBID_DOT_MAESTRO"]
    stores_write: ["HOME_HUB_REPO"]
    internal: ["UNKNOWN"]
  - user: "maestro issue list --readonly"
    gates: ["READONLY_GUARD", "FORBID_DOT_MAESTRO"]
    stores_read: ["HOME_HUB_REPO"]
    internal: ["UNKNOWN"]
  - user: "maestro init"
    gates: ["REPOCONF_GATE", "FORBID_DOT_MAESTRO"]
    stores_write: ["REPO_TRUTH_DOCS_MAESTRO"]
    internal: ["UNKNOWN"]
  - user: "maestro repo resolve --level lite"
    gates: ["REPO_RESOLVE_LITE", "FORBID_DOT_MAESTRO"]
    stores_write: ["REPO_TRUTH_DOCS_MAESTRO"]
    internal: ["UNKNOWN"]
  - user: "maestro task list"
    gates: ["REPOCONF_GATE", "FORBID_DOT_MAESTRO"]
    stores_read: ["REPO_TRUTH_DOCS_MAESTRO"]
    internal: ["UNKNOWN"]
```
