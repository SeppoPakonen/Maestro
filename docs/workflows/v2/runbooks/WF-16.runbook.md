# WF-16: wsession Modes â€” Log-only vs Mutation API (Opt-in)

## Short Intent
This workflow describes the default log-only behavior of `maestro wsession` and the opt-in mutation mode.

## Preconditions
- Repository is adopted
- Work session cookie is available
- Mutation mode is explicitly enabled for the session

## Steps Table

| Step | Command | Why | Gates |
|------|---------|-----|-------|
| 1 | `maestro work-run --enable-mutation` | Start a work session with mutation enabled | WSESSION_MUTATION_MODE_OPTIN |
| 2 | `maestro wsession log --cookie "<session_id>" --message "status only"` | Append a log-only breadcrumb | WSESSION_COOKIE_REQUIRED |
| 3 | `maestro wsession mutate --cookie "<session_id>" --operation "task.add" --payload '{"title":"Bootstrap"}'` | Apply a mutation operation | WSESSION_MUTATION_MODE_OPTIN, BRANCH_GUARD |
| 4 | `maestro wsession mutate --cookie "<session_id>" --operation "task.add" --payload '{}'` | Demonstrate schema rejection for invalid mutation | WSESSION_MUTATION_MODE_OPTIN, OP_SCHEMA_GATE |

## Expected Internal Flow (Coarse)

- Work run establishes cookie with mutation capability
- Log-only mode appends breadcrumbs without state mutation
- Mutation mode validates branch identity, schema, and referential integrity
- Valid mutations update repo truth and append audit trail

## Data Touches

### Stores Read
- `REPO_TRUTH_DOCS_MAESTRO` - Read session state and referenced entities

### Stores Write
- `REPO_TRUTH_DOCS_MAESTRO` - Write mutations and audit events

## Open Questions / Unknowns

- Is `maestro work-run --enable-mutation` the correct flag for mutation mode?
- Is `maestro wsession mutate` the correct subcommand for mutations?
- What is the canonical schema for mutation payloads?
- Should referential integrity failures surface as a separate gate name?

## Trace Block

```yaml
trace:
  - user: "maestro work-run --enable-mutation"
    gates: ["WSESSION_MUTATION_MODE_OPTIN"]
    stores_write: ["REPO_TRUTH_DOCS_MAESTRO"]
    internal: ["UNKNOWN"]
  - user: "maestro wsession log --cookie \"<session_id>\" --message \"status only\""
    gates: ["WSESSION_COOKIE_REQUIRED"]
    stores_write: ["REPO_TRUTH_DOCS_MAESTRO"]
    internal: ["UNKNOWN"]
  - user: "maestro wsession mutate --cookie \"<session_id>\" --operation \"task.add\" --payload '{\"title\":\"Bootstrap\"}'"
    gates: ["WSESSION_MUTATION_MODE_OPTIN", "BRANCH_GUARD"]
    stores_write: ["REPO_TRUTH_DOCS_MAESTRO"]
    internal: ["UNKNOWN"]
  - user: "maestro wsession mutate --cookie \"<session_id>\" --operation \"task.add\" --payload '{}'"
    gates: ["WSESSION_MUTATION_MODE_OPTIN", "OP_SCHEMA_GATE"]
    stores_write: ["REPO_TRUTH_DOCS_MAESTRO"]
    internal: ["UNKNOWN"]
```
