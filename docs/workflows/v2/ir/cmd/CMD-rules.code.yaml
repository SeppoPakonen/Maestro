id: CMD-rules
layer: "code"
title: "rules deep internal flow (observed)"
status: "partial"
confidence: "high"
storage_backend: "unknown"

calls:
  - maestro.main.main
  - maestro.modules.command_handlers.handle_rules_list
  - maestro.modules.command_handlers.handle_rules_file
  - maestro.session_model.load_session
  - maestro.session_model.save_session
  - maestro.modules.utils.print_header
  - subprocess.run
  - os.environ.get

stores:
  - docs/sessions/<session-name>/session.json
  - docs/sessions/<session-name>/rules.txt

nodes:
  - id: "main_entry"
    type: "function"
    module: "maestro.main"
    function: "main"
    label: "maestro main entrypoint"
  - id: "handle_rules_list"
    type: "function"
    module: "maestro.modules.command_handlers"
    function: "handle_rules_list"
    label: "Handle rules list command"
  - id: "handle_rules_file"
    type: "function"
    module: "maestro.modules.command_handlers"
    function: "handle_rules_file"
    label: "Handle rules file command"
  - id: "load_session"
    type: "function"
    module: "maestro.session_model"
    function: "load_session"
    label: "Load session data"
  - id: "save_session"
    type: "function"
    module: "maestro.session_model"
    function: "save_session"
    label: "Save session data"
  - id: "get_maestro_dir"
    type: "function"
    module: "maestro.modules.utils"
    function: "get_maestro_dir"
    label: "Get maestro directory"
  - id: "session_class"
    type: "class"
    module: "maestro.session_model"
    class: "Session"
    label: "Session class"
  - id: "file_system"
    type: "actor"
    label: "File System"
  - id: "user_editor"
    type: "actor"
    label: "User's $EDITOR"
  - id: "subprocess_actor"
    type: "actor"
    label: "subprocess module"
  - id: "docs_sessions_dir"
    type: "datastore"
    label: "docs/sessions/<name>/ directory"

edges:
  - from: "main_entry"
    to: "handle_rules_list"
    type: "call"
  - from: "main_entry"
    to: "handle_rules_file"
    type: "call"
  - from: "handle_rules_list"
    to: "load_session"
    type: "call"
  - from: "load_session"
    to: "docs_sessions_dir"
    type: "data"
  - from: "handle_rules_list"
    to: "file_system"
    type: "data"
  - from: "handle_rules_file"
    to: "load_session"
    type: "call"
  - from: "handle_rules_file"
    to: "get_maestro_dir"
    type: "call"
  - from: "handle_rules_file"
    to: "file_system"
    type: "data"
  - from: "handle_rules_file"
    to: "save_session"
    type: "call"
  - from: "handle_rules_file"
    to: "subprocess_actor"
    type: "call"
  - from: "user_editor"
    to: "handle_rules_file"
    type: "call"
  - from: "session_class"
    to: "save_session"
    type: "call"
  - from: "docs_sessions_dir"
    to: "file_system"
    type: "data"
  - from: "subprocess_actor"
    to: "user_editor"
    type: "call"

evidence:
  - v1/internal/deep/cmd_rules_deep.puml
  - maestro/modules/command_handlers.py
  - maestro/session_model.py

ledger_hints:
  - "Observed rules.txt persistence as plain text file in session directory; verify this aligns with intended storage contract and doesn't conflict with JSON-only repo truth requirements"
