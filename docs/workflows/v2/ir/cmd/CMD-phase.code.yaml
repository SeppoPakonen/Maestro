id: "CMD-phase"
layer: "code"
title: "phase deep internal flow (observed)"
status: "partial"
confidence: "high"
storage_backend: "mixed"

calls:
  - maestro.main.main
  - maestro.commands.phase.handle_phase_command
  - maestro.commands.phase.list_phases
  - maestro.commands.phase.show_phase
  - maestro.commands.phase.add_phase
  - maestro.commands.phase.remove_phase
  - maestro.commands.phase.edit_phase
  - maestro.commands.phase.set_phase_status
  - maestro.commands.phase.set_phase_context
  - maestro.commands.discuss.handle_phase_discuss
  - maestro.data.common_utils.get_all_tracks_with_phases_and_tasks
  - maestro.data.markdown_parser.parse_todo_md
  - maestro.data.markdown_parser.parse_done_md
  - maestro.data.markdown_parser.parse_phase_md
  - maestro.data.markdown_writer.extract_phase_block
  - maestro.data.markdown_writer.replace_phase_block
  - maestro.tracks.json_store.JsonStore
  - maestro.tracks.json_store.load_phase
  - maestro.tracks.json_store.save_phase
  - maestro.tracks.json_store.load_track
  - maestro.tracks.json_store.save_track
  - maestro.config.settings.get_settings
  - maestro.commands.status_utils.normalize_status

stores:
  - docs/todo.md
  - docs/done.md
  - docs/phases/<id>.md
  - .maestro/tracks/*.json
  - $HOME/.maestro/settings.json

nodes:
  - id: "main_entry"
    type: "function"
    module: "maestro/main.py"
    function: "main"
  - id: "handle_phase_command"
    type: "function"
    module: "maestro/commands/phase.py"
    function: "handle_phase_command"
  - id: "list_phases"
    type: "function"
    module: "maestro/commands/phase.py"
    function: "list_phases"
  - id: "show_phase"
    type: "function"
    module: "maestro/commands/phase.py"
    function: "show_phase"
  - id: "add_phase"
    type: "function"
    module: "maestro/commands/phase.py"
    function: "add_phase"
  - id: "remove_phase"
    type: "function"
    module: "maestro/commands/phase.py"
    function: "remove_phase"
  - id: "edit_phase"
    type: "function"
    module: "maestro/commands/phase.py"
    function: "edit_phase"
  - id: "set_phase_status"
    type: "function"
    module: "maestro/commands/phase.py"
    function: "set_phase_status"
  - id: "set_phase_context"
    type: "function"
    module: "maestro/commands/phase.py"
    function: "set_phase_context"
  - id: "handle_phase_discuss"
    type: "function"
    module: "maestro/commands/discuss.py"
    function: "handle_phase_discuss"
  - id: "get_all_tracks"
    type: "function"
    module: "maestro/data/common_utils.py"
    function: "get_all_tracks_with_phases_and_tasks"
  - id: "parse_todo_md"
    type: "function"
    module: "maestro/data/markdown_parser.py"
    function: "parse_todo_md"
  - id: "parse_phase_md"
    type: "function"
    module: "maestro/data/markdown_parser.py"
    function: "parse_phase_md"
  - id: "extract_phase_block"
    type: "function"
    module: "maestro/data/markdown_writer.py"
    function: "extract_phase_block"
  - id: "replace_phase_block"
    type: "function"
    module: "maestro/data/markdown_writer.py"
    function: "replace_phase_block"
  - id: "json_store"
    type: "class"
    module: "maestro/tracks/json_store.py"
    class: "JsonStore"
  - id: "load_phase"
    type: "function"
    module: "maestro/tracks/json_store.py"
    function: "load_phase"
  - id: "save_phase"
    type: "function"
    module: "maestro/tracks/json_store.py"
    function: "save_phase"
  - id: "load_track"
    type: "function"
    module: "maestro/tracks/json_store.py"
    function: "load_track"
  - id: "save_track"
    type: "function"
    module: "maestro/tracks/json_store.py"
    function: "save_track"
  - id: "get_settings"
    type: "function"
    module: "maestro/config/settings.py"
    function: "get_settings"
  - id: "normalize_status"
    type: "function"
    module: "maestro/commands/status_utils.py"
    function: "normalize_status"
  - id: "docs_todo_md"
    type: "datastore"
    path: "docs/todo.md"
  - id: "docs_done_md"
    type: "datastore"
    path: "docs/done.md"
  - id: "docs_phases_md"
    type: "datastore"
    path: "docs/phases/<id>.md"
  - id: "maestro_tracks_json"
    type: "datastore"
    path: ".maestro/tracks/*.json"
  - id: "settings_json"
    type: "datastore"
    path: "$HOME/.maestro/settings.json"
  - id: "editor"
    type: "actor"
    label: "User's $EDITOR"
  - id: "file_system"
    type: "actor"
    label: "File System"

edges:
  - from: "main_entry"
    to: "handle_phase_command"
  - from: "handle_phase_command"
    to: "list_phases"
  - from: "handle_phase_command"
    to: "show_phase"
  - from: "handle_phase_command"
    to: "add_phase"
  - from: "handle_phase_command"
    to: "remove_phase"
  - from: "handle_phase_command"
    to: "edit_phase"
  - from: "handle_phase_command"
    to: "set_phase_status"
  - from: "handle_phase_command"
    to: "set_phase_context"
  - from: "handle_phase_command"
    to: "handle_phase_discuss"
  - from: "list_phases"
    to: "get_all_tracks"
  - from: "list_phases"
    to: "get_settings"
  - from: "show_phase"
    to: "file_system"
  - from: "show_phase"
    to: "parse_phase_md"
  - from: "show_phase"
    to: "parse_todo_md"
  - from: "add_phase"
    to: "get_settings"
  - from: "add_phase"
    to: "json_store"
  - from: "add_phase"
    to: "load_track"
  - from: "add_phase"
    to: "load_phase"
  - from: "add_phase"
    to: "save_phase"
  - from: "add_phase"
    to: "save_track"
  - from: "remove_phase"
    to: "json_store"
  - from: "remove_phase"
    to: "load_phase"
  - from: "remove_phase"
    to: "load_track"
  - from: "remove_phase"
    to: "save_track"
  - from: "remove_phase"
    to: "file_system"
  - from: "edit_phase"
    to: "file_system"
  - from: "edit_phase"
    to: "extract_phase_block"
  - from: "edit_phase"
    to: "replace_phase_block"
  - from: "edit_phase"
    to: "editor"
  - from: "set_phase_status"
    to: "normalize_status"
  - from: "set_phase_status"
    to: "json_store"
  - from: "set_phase_status"
    to: "load_phase"
  - from: "set_phase_status"
    to: "save_phase"
  - from: "set_phase_context"
    to: "parse_todo_md"
  - from: "set_phase_context"
    to: "parse_phase_md"
  - from: "set_phase_context"
    to: "get_settings"
  - from: "set_phase_context"
    to: "settings_json"

evidence:
  - "v1/internal/deep/cmd_phase_deep.puml"
  - "maestro/commands/phase.py"
  - "maestro/data/markdown_parser.py"
  - "maestro/data/markdown_writer.py"
  - "maestro/tracks/json_store.py"

ledger_hints:
  - "Observed DataMarkdown persistence in cmd_phase deep flow; v2 repo truth uses JSON. Replace/remove DataMarkdown codepaths and update docs/tests."
  - "Observed .maestro directory usage in cmd_phase deep flow; violates FORBID_REPO_DOT_MAESTRO invariant; migrate to ./docs/maestro/."
  - "Observed markdown file persistence for repo truth in cmd_phase deep flow; violates REPO_TRUTH_FORMAT_IS_JSON invariant; migrate to JSON-only storage."
