id: "CMD-plan"
layer: "code"
title: "plan deep internal flow (observed)"
status: "partial"
confidence: "high"
storage_backend: "markdown"

calls:
  - maestro.main.main
  - maestro.commands.plan.add_plan_parser
  - maestro.commands.plan.handle_plan_add
  - maestro.commands.plan.handle_plan_list
  - maestro.commands.plan.handle_plan_remove
  - maestro.commands.plan.handle_plan_show
  - maestro.commands.plan.handle_plan_add_item
  - maestro.commands.plan.handle_plan_remove_item
  - maestro.commands.plan.handle_plan_discuss
  - maestro.commands.plan.handle_plan_explore
  - maestro.plans.PlanStore
  - maestro.plan_ops.commands.add_plan_ops_parser
  - maestro.plan_ops.commands.handle_plan_ops_validate
  - maestro.plan_ops.commands.handle_plan_ops_preview
  - maestro.plan_ops.commands.handle_plan_ops_apply
  - maestro.plan_ops.decoder.decode_plan_ops_json
  - maestro.plan_ops.schemas.validate_plan_ops_result
  - maestro.plan_ops.translator.actions_to_ops
  - maestro.plan_ops.executor.PlanOpsExecutor
  - maestro.plan_explore.session.create_explore_session
  - maestro.plan_explore.session.resume_explore_session
  - maestro.plan_explore.session.save_explore_session
  - maestro.plan_explore.session.add_iteration_to_session
  - maestro.ai.manager.AiEngineManager
  - maestro.ai.chat.run_interactive_chat
  - maestro.project_ops.decoder.decode_project_ops_json
  - maestro.project_ops.translator.actions_to_ops
  - maestro.project_ops.executor.ProjectOpsExecutor
  - maestro.data.markdown_parser.parse_todo_md

stores:
  - docs/plans.md
  - docs/todo.md
  - docs/sessions/explore/<session-id>/explore_session.json

nodes:
  - id: "main_entry"
    type: "function"
    module: "maestro/main.py"
    function: "main"
  - id: "plan_command_dispatcher"
    type: "function"
    module: "maestro/commands/plan.py"
    function: "add_plan_parser"
  - id: "handle_plan_add"
    type: "function"
    module: "maestro/commands/plan.py"
    function: "handle_plan_add"
  - id: "handle_plan_list"
    type: "function"
    module: "maestro/commands/plan.py"
    function: "handle_plan_list"
  - id: "handle_plan_remove"
    type: "function"
    module: "maestro/commands/plan.py"
    function: "handle_plan_remove"
  - id: "handle_plan_show"
    type: "function"
    module: "maestro/commands/plan.py"
    function: "handle_plan_show"
  - id: "handle_plan_add_item"
    type: "function"
    module: "maestro/commands/plan.py"
    function: "handle_plan_add_item"
  - id: "handle_plan_remove_item"
    type: "function"
    module: "maestro/commands/plan.py"
    function: "handle_plan_remove_item"
  - id: "handle_plan_discuss"
    type: "function"
    module: "maestro/commands/plan.py"
    function: "handle_plan_discuss"
  - id: "handle_plan_explore"
    type: "function"
    module: "maestro/commands/plan.py"
    function: "handle_plan_explore"
  - id: "plan_store"
    type: "class"
    module: "maestro/plans.py"
    class: "PlanStore"
  - id: "plan_ops_parser"
    type: "function"
    module: "maestro/plan_ops/commands.py"
    function: "add_plan_ops_parser"
  - id: "handle_plan_ops_validate"
    type: "function"
    module: "maestro/plan_ops/commands.py"
    function: "handle_plan_ops_validate"
  - id: "handle_plan_ops_preview"
    type: "function"
    module: "maestro/plan_ops/commands.py"
    function: "handle_plan_ops_preview"
  - id: "handle_plan_ops_apply"
    type: "function"
    module: "maestro/plan_ops/commands.py"
    function: "handle_plan_ops_apply"
  - id: "decode_plan_ops_json"
    type: "function"
    module: "maestro/plan_ops/decoder.py"
    function: "decode_plan_ops_json"
  - id: "validate_plan_ops_result"
    type: "function"
    module: "maestro/plan_ops/schemas.py"
    function: "validate_plan_ops_result"
  - id: "actions_to_ops"
    type: "function"
    module: "maestro/plan_ops/translator.py"
    function: "actions_to_ops"
  - id: "plan_ops_executor"
    type: "class"
    module: "maestro/plan_ops/executor.py"
    class: "PlanOpsExecutor"
  - id: "explore_session"
    type: "class"
    module: "maestro/plan_explore/session.py"
    class: "ExploreSession"
  - id: "ai_engine_manager"
    type: "class"
    module: "maestro/ai/manager.py"
    class: "AiEngineManager"
  - id: "decode_project_ops_json"
    type: "function"
    module: "maestro/project_ops/decoder.py"
    function: "decode_project_ops_json"
  - id: "project_ops_executor"
    type: "class"
    module: "maestro/project_ops/executor.py"
    class: "ProjectOpsExecutor"
  - id: "parse_todo_md"
    type: "function"
    module: "maestro/data/markdown_parser.py"
    function: "parse_todo_md"
  - id: "docs_plans_md"
    type: "datastore"
    path: "docs/plans.md"
  - id: "docs_todo_md"
    type: "datastore"
    path: "docs/todo.md"
  - id: "explore_session_json"
    type: "datastore"
    path: "docs/sessions/explore/<session-id>/explore_session.json"

edges:
  - from: "main_entry"
    to: "plan_command_dispatcher"
  - from: "plan_command_dispatcher"
    to: "handle_plan_add"
  - from: "plan_command_dispatcher"
    to: "handle_plan_list"
  - from: "plan_command_dispatcher"
    to: "handle_plan_remove"
  - from: "plan_command_dispatcher"
    to: "handle_plan_show"
  - from: "plan_command_dispatcher"
    to: "handle_plan_add_item"
  - from: "plan_command_dispatcher"
    to: "handle_plan_remove_item"
  - from: "plan_command_dispatcher"
    to: "handle_plan_discuss"
  - from: "plan_command_dispatcher"
    to: "handle_plan_explore"
  - from: "handle_plan_add"
    to: "plan_store"
  - from: "handle_plan_list"
    to: "plan_store"
  - from: "handle_plan_remove"
    to: "plan_store"
  - from: "handle_plan_show"
    to: "plan_store"
  - from: "handle_plan_add_item"
    to: "plan_store"
  - from: "handle_plan_remove_item"
    to: "plan_store"
  - from: "handle_plan_discuss"
    to: "ai_engine_manager"
  - from: "handle_plan_discuss"
    to: "decode_plan_ops_json"
  - from: "decode_plan_ops_json"
    to: "validate_plan_ops_result"
  - from: "decode_plan_ops_json"
    to: "actions_to_ops"
  - from: "actions_to_ops"
    to: "plan_ops_executor"
  - from: "handle_plan_explore"
    to: "explore_session"
  - from: "handle_plan_explore"
    to: "ai_engine_manager"
  - from: "handle_plan_explore"
    to: "decode_project_ops_json"
  - from: "decode_project_ops_json"
    to: "project_ops_executor"
  - from: "handle_plan_explore"
    to: "parse_todo_md"
  - from: "plan_store"
    to: "docs_plans_md"
  - from: "parse_todo_md"
    to: "docs_todo_md"
  - from: "explore_session"
    to: "explore_session_json"

evidence:
  - "maestro/commands/plan.py"
  - "maestro/plans.py"
  - "maestro/plan_ops/commands.py"
  - "maestro/plan_ops/decoder.py"
  - "maestro/plan_ops/schemas.py"
  - "maestro/plan_ops/translator.py"
  - "maestro/plan_ops/executor.py"
  - "maestro/plan_explore/session.py"
  - "maestro/ai/manager.py"
  - "maestro/project_ops/decoder.py"
  - "maestro/project_ops/executor.py"
  - "maestro/data/markdown_parser.py"

ledger_hints:
  - "Observed DataMarkdown persistence in cmd_plan deep flow; v2 repo truth uses JSON. Replace/remove DataMarkdown codepaths and update docs/tests."
