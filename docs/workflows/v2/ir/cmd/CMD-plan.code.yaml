id: "CMD-plan"
layer: "code"
title: "plan deep internal flow (observed)"
status: "partial"
confidence: "high"
storage_backend: "markdown"

calls:
  - "maestro.main.main"
  - "maestro.commands.plan.add_plan_parser"
  - "maestro.commands.plan.handle_plan_*"
  - "maestro.plans.PlanStore"
  - "maestro.plan_ops.commands.add_plan_ops_parser"
  - "maestro.plan_ops.commands.handle_plan_ops_*"
  - "maestro.plan_ops.decoder.decode_plan_ops_json"
  - "maestro.plan_ops.schemas.validate_plan_ops_result"
  - "maestro.plan_ops.translator.actions_to_ops"
  - "maestro.plan_ops.executor.PlanOpsExecutor"
  - "maestro.plan_explore.session.*"
  - "maestro.ai.manager.AiEngineManager"
  - "maestro.ai.chat.run_interactive_chat"
  - "maestro.project_ops.decoder.decode_project_ops_json"
  - "maestro.project_ops.translator.actions_to_ops"
  - "maestro.project_ops.executor.ProjectOpsExecutor"
  - "maestro.data.markdown_parser.parse_todo_md"

stores:
  - "docs/plans.md"
  - "docs/todo.md"
  - "docs/sessions/explore/<session-id>/explore_session.json"

nodes:
  - id: "main_entry"
    type: "function"
    module: "maestro/main.py"
    function: "main"
  - id: "plan_command_handler"
    type: "function"
    module: "maestro/commands/plan.py"
    function: "handle_plan_*"
  - id: "plan_store"
    type: "class"
    module: "maestro/plans.py"
    class: "PlanStore"
  - id: "plan_ops_handler"
    type: "function"
    module: "maestro/plan_ops/commands.py"
    function: "handle_plan_ops_*"
  - id: "plan_ops_decoder"
    type: "function"
    module: "maestro/plan_ops/decoder.py"
    function: "decode_plan_ops_json"
  - id: "plan_ops_executor"
    type: "class"
    module: "maestro/plan_ops/executor.py"
    class: "PlanOpsExecutor"
  - id: "plan_explore_handler"
    type: "function"
    module: "maestro/commands/plan.py"
    function: "handle_plan_explore"
  - id: "explore_session"
    type: "class"
    module: "maestro/plan_explore/session.py"
    class: "ExploreSession"
  - id: "ai_engine_manager"
    type: "class"
    module: "maestro/ai/manager.py"
    class: "AiEngineManager"
  - id: "project_ops_executor"
    type: "class"
    module: "maestro/project_ops/executor.py"
    class: "ProjectOpsExecutor"
  - id: "docs_plans_md"
    type: "datastore"
    path: "docs/plans.md"
  - id: "docs_todo_md"
    type: "datastore"
    path: "docs/todo.md"
  - id: "explore_session_json"
    type: "datastore"
    path: "docs/sessions/explore/<session-id>/explore_session.json"

edges:
  - from: "main_entry"
    to: "plan_command_handler"
  - from: "plan_command_handler"
    to: "plan_store"
  - from: "plan_command_handler"
    to: "plan_ops_handler"
  - from: "plan_ops_handler"
    to: "plan_ops_decoder"
  - from: "plan_ops_decoder"
    to: "plan_ops_executor"
  - from: "plan_command_handler"
    to: "plan_explore_handler"
  - from: "plan_explore_handler"
    to: "explore_session"
  - from: "plan_explore_handler"
    to: "ai_engine_manager"
  - from: "plan_explore_handler"
    to: "project_ops_executor"
  - from: "plan_store"
    to: "docs_plans_md"
  - from: "plan_explore_handler"
    to: "docs_todo_md"
  - from: "explore_session"
    to: "explore_session_json"

evidence:
  - "v1/internal/deep/cmd_plan_deep.puml"
  - "maestro/commands/plan.py"
  - "maestro/plans.py"
  - "maestro/plan_ops/commands.py"
  - "maestro/plan_ops/decoder.py"
  - "maestro/plan_ops/executor.py"
  - "maestro/plan_explore/session.py"
  - "maestro/ai/manager.py"
  - "maestro/project_ops/executor.py"
  - "maestro/data/markdown_parser.py"

ledger_hints:
  - "Observed DataMarkdown persistence in cmd_plan deep flow; v2 repo truth uses JSON. Replace/remove DataMarkdown codepaths and update docs/tests."
  - "Plan storage uses docs/plans.md which violates REPO_TRUTH_FORMAT_IS_JSON invariant; migrate to JSON format."
