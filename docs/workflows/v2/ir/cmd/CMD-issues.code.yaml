id: "CMD-issues"
layer: "code"
title: "issues deep internal flow (observed)"
status: "partial"
confidence: "high"
storage_backend: "markdown"

calls:
  - maestro.main.main
  - maestro.commands.issues.handle_issues_command
  - maestro.commands.issues._handle_list
  - maestro.commands.issues._handle_show
  - maestro.commands.issues._handle_state
  - maestro.commands.issues._handle_rollback
  - maestro.commands.issues._handle_react
  - maestro.commands.issues._handle_analyze
  - maestro.commands.issues._handle_decide
  - maestro.commands.issues._handle_fix
  - maestro.commands.issues._find_repo_root
  - maestro.commands.issues._find_issue_path
  - maestro.commands.issues._extract_confidence
  - maestro.commands.issues._first_sentence
  - maestro.commands.issues._create_fix_session
  - maestro.issues.issue_store.list_issues
  - maestro.issues.issue_store.load_issue
  - maestro.issues.issue_store.update_issue_state
  - maestro.issues.issue_store.rollback_issue_state
  - maestro.issues.issue_store.update_issue_metadata
  - maestro.issues.issue_store.update_issue_priority
  - maestro.issues.issue_store.update_issue_section
  - maestro.issues.issue_store.generate_issue_id
  - maestro.issues.issue_store.write_issue
  - maestro.issues.model.IssueRecord
  - maestro.issues.model.can_transition
  - maestro.solutions.solution_store.match_solutions
  - maestro.ai.client.ExternalCommandClient

stores:
  - docs/issues/<id>.md
  - docs/solutions/<id>.md
  - docs/sessions/<id>-fix-<timestamp>.md

nodes:
  - id: "main_entry"
    type: "function"
    module: "maestro/main.py"
    function: "main"
  - id: "handle_issues_command"
    type: "function"
    module: "maestro/commands/issues.py"
    function: "handle_issues_command"
  - id: "find_repo_root"
    type: "function"
    module: "maestro/commands/issues.py"
    function: "_find_repo_root"
  - id: "handle_list"
    type: "function"
    module: "maestro/commands/issues.py"
    function: "_handle_list"
  - id: "handle_show"
    type: "function"
    module: "maestro/commands/issues.py"
    function: "_handle_show"
  - id: "handle_state"
    type: "function"
    module: "maestro/commands/issues.py"
    function: "_handle_state"
  - id: "handle_rollback"
    type: "function"
    module: "maestro/commands/issues.py"
    function: "_handle_rollback"
  - id: "handle_react"
    type: "function"
    module: "maestro/commands/issues.py"
    function: "_handle_react"
  - id: "handle_analyze"
    type: "function"
    module: "maestro/commands/issues.py"
    function: "_handle_analyze"
  - id: "handle_decide"
    type: "function"
    module: "maestro/commands/issues.py"
    function: "_handle_decide"
  - id: "handle_fix"
    type: "function"
    module: "maestro/commands/issues.py"
    function: "_handle_fix"
  - id: "list_issues"
    type: "function"
    module: "maestro/issues/issue_store.py"
    function: "list_issues"
  - id: "load_issue"
    type: "function"
    module: "maestro/issues/issue_store.py"
    function: "load_issue"
  - id: "update_issue_state"
    type: "function"
    module: "maestro/issues/issue_store.py"
    function: "update_issue_state"
  - id: "rollback_issue_state"
    type: "function"
    module: "maestro/issues/issue_store.py"
    function: "rollback_issue_state"
  - id: "update_issue_metadata"
    type: "function"
    module: "maestro/issues/issue_store.py"
    function: "update_issue_metadata"
  - id: "update_issue_priority"
    type: "function"
    module: "maestro/issues/issue_store.py"
    function: "update_issue_priority"
  - id: "update_issue_section"
    type: "function"
    module: "maestro/issues/issue_store.py"
    function: "update_issue_section"
  - id: "match_solutions"
    type: "function"
    module: "maestro/solutions/solution_store.py"
    function: "match_solutions"
  - id: "external_command_client"
    type: "class"
    module: "maestro/ai/client.py"
    class: "ExternalCommandClient"
  - id: "issue_record"
    type: "class"
    module: "maestro/issues/model.py"
    class: "IssueRecord"
  - id: "can_transition"
    type: "function"
    module: "maestro/issues/model.py"
    function: "can_transition"
  - id: "docs_issues_md"
    type: "datastore"
    path: "docs/issues/<id>.md"
  - id: "docs_solutions_md"
    type: "datastore"
    path: "docs/solutions/<id>.md"
  - id: "docs_sessions_md"
    type: "datastore"
    path: "docs/sessions/<id>-fix-<timestamp>.md"
  - id: "file_system"
    type: "actor"
    label: "File System"

edges:
  - from: "main_entry"
    to: "handle_issues_command"
    type: "call"
  - from: "handle_issues_command"
    to: "find_repo_root"
    type: "call"
  - from: "handle_issues_command"
    to: "handle_list"
    type: "call"
  - from: "handle_issues_command"
    to: "handle_show"
    type: "call"
  - from: "handle_issues_command"
    to: "handle_state"
    type: "call"
  - from: "handle_issues_command"
    to: "handle_rollback"
    type: "call"
  - from: "handle_issues_command"
    to: "handle_react"
    type: "call"
  - from: "handle_issues_command"
    to: "handle_analyze"
    type: "call"
  - from: "handle_issues_command"
    to: "handle_decide"
    type: "call"
  - from: "handle_issues_command"
    to: "handle_fix"
    type: "call"
  - from: "handle_list"
    to: "list_issues"
    type: "call"
  - from: "list_issues"
    to: "docs_issues_md"
    type: "data"
  - from: "handle_show"
    to: "load_issue"
    type: "call"
  - from: "load_issue"
    to: "docs_issues_md"
    type: "data"
  - from: "handle_state"
    to: "update_issue_state"
    type: "call"
  - from: "update_issue_state"
    to: "can_transition"
    type: "call"
  - from: "handle_rollback"
    to: "rollback_issue_state"
    type: "call"
  - from: "handle_react"
    to: "match_solutions"
    type: "call"
  - from: "handle_react"
    to: "update_issue_state"
    type: "call"
  - from: "handle_react"
    to: "update_issue_metadata"
    type: "call"
  - from: "handle_react"
    to: "update_issue_section"
    type: "call"
  - from: "match_solutions"
    to: "docs_solutions_md"
    type: "data"
  - from: "handle_analyze"
    to: "external_command_client"
    type: "call"
  - from: "handle_analyze"
    to: "update_issue_state"
    type: "call"
  - from: "handle_analyze"
    to: "update_issue_metadata"
    type: "call"
  - from: "handle_analyze"
    to: "update_issue_section"
    type: "call"
  - from: "handle_decide"
    to: "update_issue_state"
    type: "call"
  - from: "handle_decide"
    to: "update_issue_metadata"
    type: "call"
  - from: "handle_decide"
    to: "update_issue_section"
    type: "call"
  - from: "handle_decide"
    to: "update_issue_priority"
    type: "call"
  - from: "handle_fix"
    to: "update_issue_state"
    type: "call"
  - from: "handle_fix"
    to: "update_issue_metadata"
    type: "call"
  - from: "handle_fix"
    to: "update_issue_section"
    type: "call"
  - from: "handle_fix"
    to: "docs_sessions_md"
    type: "data"
  - from: "docs_issues_md"
    to: "file_system"
    type: "data"
  - from: "docs_solutions_md"
    to: "file_system"
    type: "data"
  - from: "docs_sessions_md"
    to: "file_system"
    type: "data"

evidence:
  - "maestro/commands/issues.py"
  - "maestro/issues/issue_store.py"
  - "maestro/issues/model.py"
  - "maestro/solutions/solution_store.py"
  - "maestro/ai/client.py"

ledger_hints:
  - "Observed DataMarkdown persistence in cmd_issues deep flow; v2 repo truth uses JSON. Replace/remove DataMarkdown codepaths and update docs/tests."
  - "Observed .maestro directory usage in _find_repo_root; v2 spec uses ./docs/maestro/ for repo truth. This may violate FORBID_REPO_DOT_MAESTRO invariant."
  - "Observed markdown file persistence for repo truth in issues flow; v2 spec requires JSON. This violates REPO_TRUTH_FORMAT_IS_JSON invariant."
