id: "CMD-issues"
layer: "code"
title: "issues deep internal flow (observed)"
status: "incorrect"
confidence: "high"
storage_backend: "markdown"

calls:
  - maestro.main.main
  - maestro.commands.issues.handle_issues_command
  - maestro.commands.issues._handle_list
  - maestro.commands.issues._handle_show
  - maestro.commands.issues._handle_state
  - maestro.commands.issues._handle_rollback
  - maestro.commands.issues._handle_react
  - maestro.commands.issues._handle_analyze
  - maestro.commands.issues._handle_decide
  - maestro.commands.issues._handle_fix
  - maestro.commands.issues._find_repo_root
  - maestro.commands.issues._find_issue_path
  - maestro.commands.issues._extract_confidence
  - maestro.commands.issues._first_sentence
  - maestro.commands.issues._create_fix_session
  - maestro.issues.issue_store.list_issues
  - maestro.issues.issue_store.load_issue
  - maestro.issues.issue_store.update_issue_state
  - maestro.issues.issue_store.rollback_issue_state
  - maestro.issues.issue_store.update_issue_metadata
  - maestro.issues.issue_store.update_issue_priority
  - maestro.issues.issue_store.update_issue_section
  - maestro.issues.issue_store.write_issue
  - maestro.issues.issue_store.generate_issue_id
  - maestro.issues.model.can_transition
  - maestro.solutions.solution_store.match_solutions
  - maestro.ai.client.ExternalCommandClient

stores:
  - docs/issues/*.md
  - docs/solutions/*.md
  - docs/sessions/*.md

nodes:
  - id: "main_entry"
    type: "function"
    module: "maestro/main.py"
    function: "main"
    label: "main()"
  - id: "handle_issues_command"
    type: "function"
    module: "maestro/commands/issues.py"
    function: "handle_issues_command"
    label: "handle_issues_command()"
  - id: "find_repo_root"
    type: "function"
    module: "maestro/commands/issues.py"
    function: "_find_repo_root"
    label: "_find_repo_root()"
  - id: "handle_list"
    type: "function"
    module: "maestro/commands/issues.py"
    function: "_handle_list"
    label: "_handle_list()"
  - id: "handle_show"
    type: "function"
    module: "maestro/commands/issues.py"
    function: "_handle_show"
    label: "_handle_show()"
  - id: "handle_state"
    type: "function"
    module: "maestro/commands/issues.py"
    function: "_handle_state"
    label: "_handle_state()"
  - id: "handle_rollback"
    type: "function"
    module: "maestro/commands/issues.py"
    function: "_handle_rollback"
    label: "_handle_rollback()"
  - id: "handle_react"
    type: "function"
    module: "maestro/commands/issues.py"
    function: "_handle_react"
    label: "_handle_react()"
  - id: "handle_analyze"
    type: "function"
    module: "maestro/commands/issues.py"
    function: "_handle_analyze"
    label: "_handle_analyze()"
  - id: "handle_decide"
    type: "function"
    module: "maestro/commands/issues.py"
    function: "_handle_decide"
    label: "_handle_decide()"
  - id: "handle_fix"
    type: "function"
    module: "maestro/commands/issues.py"
    function: "_handle_fix"
    label: "_handle_fix()"
  - id: "list_issues"
    type: "function"
    module: "maestro/issues/issue_store.py"
    function: "list_issues"
    label: "list_issues()"
  - id: "load_issue"
    type: "function"
    module: "maestro/issues/issue_store.py"
    function: "load_issue"
    label: "load_issue()"
  - id: "update_issue_state"
    type: "function"
    module: "maestro/issues/issue_store.py"
    function: "update_issue_state"
    label: "update_issue_state()"
  - id: "rollback_issue_state"
    type: "function"
    module: "maestro/issues/issue_store.py"
    function: "rollback_issue_state"
    label: "rollback_issue_state()"
  - id: "update_issue_metadata"
    type: "function"
    module: "maestro/issues/issue_store.py"
    function: "update_issue_metadata"
    label: "update_issue_metadata()"
  - id: "update_issue_priority"
    type: "function"
    module: "maestro/issues/issue_store.py"
    function: "update_issue_priority"
    label: "update_issue_priority()"
  - id: "update_issue_section"
    type: "function"
    module: "maestro/issues/issue_store.py"
    function: "update_issue_section"
    label: "update_issue_section()"
  - id: "can_transition"
    type: "function"
    module: "maestro/issues/model.py"
    function: "can_transition"
    label: "can_transition()"
  - id: "match_solutions"
    type: "function"
    module: "maestro/solutions/solution_store.py"
    function: "match_solutions"
    label: "match_solutions()"
  - id: "external_command_client"
    type: "class"
    module: "maestro/ai/client.py"
    class: "ExternalCommandClient"
    label: "ExternalCommandClient"
  - id: "docs_issues_md"
    type: "datastore"
    label: "docs/issues/*.md"
  - id: "docs_solutions_md"
    type: "datastore"
    label: "docs/solutions/*.md"
  - id: "docs_sessions_md"
    type: "datastore"
    label: "docs/sessions/*.md"
  - id: "file_system"
    type: "actor"
    label: "File System"
  - id: "external_ai"
    type: "actor"
    label: "External AI Service"

edges:
  - from: "main_entry"
    to: "handle_issues_command"
  - from: "handle_issues_command"
    to: "find_repo_root"
  - from: "handle_issues_command"
    to: "handle_list"
  - from: "handle_issues_command"
    to: "handle_show"
  - from: "handle_issues_command"
    to: "handle_state"
  - from: "handle_issues_command"
    to: "handle_rollback"
  - from: "handle_issues_command"
    to: "handle_react"
  - from: "handle_issues_command"
    to: "handle_analyze"
  - from: "handle_issues_command"
    to: "handle_decide"
  - from: "handle_issues_command"
    to: "handle_fix"
  - from: "handle_list"
    to: "list_issues"
  - from: "list_issues"
    to: "docs_issues_md"
  - from: "handle_show"
    to: "load_issue"
  - from: "load_issue"
    to: "docs_issues_md"
  - from: "handle_state"
    to: "update_issue_state"
  - from: "update_issue_state"
    to: "can_transition"
  - from: "handle_rollback"
    to: "rollback_issue_state"
  - from: "handle_react"
    to: "match_solutions"
  - from: "match_solutions"
    to: "docs_solutions_md"
  - from: "handle_analyze"
    to: "external_command_client"
  - from: "external_command_client"
    to: "external_ai"
  - from: "handle_fix"
    to: "update_issue_section"
  - from: "update_issue_section"
    to: "docs_sessions_md"
  - from: "docs_issues_md"
    to: "file_system"
  - from: "docs_solutions_md"
    to: "file_system"
  - from: "docs_sessions_md"
    to: "file_system"

evidence:
  - path: "maestro/commands/issues.py"
    type: "source_code"
  - path: "maestro/issues/issue_store.py"
    type: "source_code"
  - path: "maestro/issues/model.py"
    type: "source_code"
  - path: "maestro/solutions/solution_store.py"
    type: "source_code"
  - path: "maestro/ai/client.py"
    type: "source_code"
  - path: "v1/internal/deep/cmd_issues_deep.puml"
    type: "v1_diagram"

ledger_hints:
  - "Observed DataMarkdown persistence in cmd_issues deep flow; v2 repo truth uses JSON. Replace/remove DataMarkdown codepaths and update docs/tests."
  - "Uses ./docs/issues/*.md, ./docs/solutions/*.md, and ./docs/sessions/*.md for persistence; violates REPO_TRUTH_FORMAT_IS_JSON invariant as these are markdown files."
