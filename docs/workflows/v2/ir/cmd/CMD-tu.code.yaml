id: "CMD-tu"
layer: "code"
title: "tu deep internal flow (observed)"
status: "partial"
confidence: "high"
storage_backend: "unknown"

calls:
  - maestro.main.main
  - maestro.commands.tu.add_tu_parser
  - maestro.commands.tu.handle_tu_command
  - maestro.commands.tu.handle_tu_build_command
  - maestro.commands.tu.handle_tu_info_command
  - maestro.commands.tu.handle_tu_query_command
  - maestro.commands.tu.handle_tu_complete_command
  - maestro.commands.tu.handle_tu_references_command
  - maestro.commands.tu.handle_tu_lsp_command
  - maestro.commands.tu.handle_tu_cache_clear_command
  - maestro.commands.tu.handle_tu_cache_stats_command
  - maestro.commands.tu.handle_tu_transform_command
  - maestro.commands.tu.handle_tu_print_ast_command
  - maestro.commands.tu.handle_tu_draft_command
  - maestro.commands.tu.detect_language_from_path
  - maestro.commands.tu.get_parser_by_language
  - maestro.commands.tu.get_files_by_language
  - maestro.tu.TUBuilder
  - maestro.tu.SymbolIndex
  - maestro.tu.CompletionProvider
  - maestro.tu.lsp_server.MaestroLSPServer
  - maestro.tu.transformers.UppConventionTransformer
  - maestro.tu.ASTPrinter
  - maestro.tu.code_generator.CodeGenerator

stores:
  - .maestro/tu/cache/
  - .maestro/tu/analysis/symbols.db
  - .maestro/tu/draft/
  - docs/todo-classes.md
  - Source code files

nodes:
  - id: "main_entry"
    type: "function"
    module: "maestro/main.py"
    function: "main"
  - id: "add_tu_parser"
    type: "function"
    module: "maestro/commands/tu.py"
    function: "add_tu_parser"
  - id: "handle_tu_command"
    type: "function"
    module: "maestro/commands/tu.py"
    function: "handle_tu_command"
  - id: "handle_tu_build_command"
    type: "function"
    module: "maestro/commands/tu.py"
    function: "handle_tu_build_command"
  - id: "handle_tu_info_command"
    type: "function"
    module: "maestro/commands/tu.py"
    function: "handle_tu_info_command"
  - id: "handle_tu_query_command"
    type: "function"
    module: "maestro/commands/tu.py"
    function: "handle_tu_query_command"
  - id: "handle_tu_complete_command"
    type: "function"
    module: "maestro/commands/tu.py"
    function: "handle_tu_complete_command"
  - id: "handle_tu_references_command"
    type: "function"
    module: "maestro/commands/tu.py"
    function: "handle_tu_references_command"
  - id: "handle_tu_lsp_command"
    type: "function"
    module: "maestro/commands/tu.py"
    function: "handle_tu_lsp_command"
  - id: "handle_tu_cache_clear_command"
    type: "function"
    module: "maestro/commands/tu.py"
    function: "handle_tu_cache_clear_command"
  - id: "handle_tu_cache_stats_command"
    type: "function"
    module: "maestro/commands/tu.py"
    function: "handle_tu_cache_stats_command"
  - id: "handle_tu_transform_command"
    type: "function"
    module: "maestro/commands/tu.py"
    function: "handle_tu_transform_command"
  - id: "handle_tu_print_ast_command"
    type: "function"
    module: "maestro/commands/tu.py"
    function: "handle_tu_print_ast_command"
  - id: "handle_tu_draft_command"
    type: "function"
    module: "maestro/commands/tu.py"
    function: "handle_tu_draft_command"
  - id: "detect_language_from_path"
    type: "function"
    module: "maestro/commands/tu.py"
    function: "detect_language_from_path"
  - id: "get_parser_by_language"
    type: "function"
    module: "maestro/commands/tu.py"
    function: "get_parser_by_language"
  - id: "get_files_by_language"
    type: "function"
    module: "maestro/commands/tu.py"
    function: "get_files_by_language"
  - id: "tu_builder"
    type: "class"
    module: "maestro/tu/tu_builder.py"
    class: "TUBuilder"
  - id: "symbol_index"
    type: "class"
    module: "maestro/tu/indexing.py"
    class: "SymbolIndex"
  - id: "completion_provider"
    type: "class"
    module: "maestro/tu/indexing.py"
    class: "CompletionProvider"
  - id: "maestro_lsp_server"
    type: "class"
    module: "maestro/tu/lsp_server.py"
    class: "MaestroLSPServer"
  - id: "upp_convention_transformer"
    type: "class"
    module: "maestro/tu/transformers.py"
    class: "UppConventionTransformer"
  - id: "ast_printer"
    type: "class"
    module: "maestro/tu/ast.py"
    class: "ASTPrinter"
  - id: "code_generator"
    type: "class"
    module: "maestro/tu/code_generator.py"
    class: "CodeGenerator"
  - id: "source_files"
    type: "datastore"
    description: "Source code files"
  - id: "tu_cache_dir"
    type: "datastore"
    path: ".maestro/tu/cache/"
  - id: "symbol_index_db"
    type: "datastore"
    path: ".maestro/tu/analysis/symbols.db"
  - id: "tu_draft_dir"
    type: "datastore"
    path: ".maestro/tu/draft/"
  - id: "docs_todo_classes_md"
    type: "datastore"
    path: "docs/todo-classes.md"
  - id: "file_system"
    type: "actor"
    description: "File System"
  - id: "shutil"
    type: "actor"
    description: "shutil module"
  - id: "json"
    type: "actor"
    description: "json module"

edges:
  - from: "main_entry"
    to: "add_tu_parser"
    type: "call"
  - from: "handle_tu_command"
    to: "handle_tu_build_command"
    type: "call"
  - from: "handle_tu_command"
    to: "handle_tu_info_command"
    type: "call"
  - from: "handle_tu_command"
    to: "handle_tu_query_command"
    type: "call"
  - from: "handle_tu_command"
    to: "handle_tu_complete_command"
    type: "call"
  - from: "handle_tu_command"
    to: "handle_tu_references_command"
    type: "call"
  - from: "handle_tu_command"
    to: "handle_tu_lsp_command"
    type: "call"
  - from: "handle_tu_command"
    to: "handle_tu_cache_clear_command"
    type: "call"
  - from: "handle_tu_command"
    to: "handle_tu_cache_stats_command"
    type: "call"
  - from: "handle_tu_command"
    to: "handle_tu_transform_command"
    type: "call"
  - from: "handle_tu_command"
    to: "handle_tu_print_ast_command"
    type: "call"
  - from: "handle_tu_command"
    to: "handle_tu_draft_command"
    type: "call"
  - from: "handle_tu_build_command"
    to: "get_files_by_language"
    type: "call"
  - from: "handle_tu_build_command"
    to: "detect_language_from_path"
    type: "call"
  - from: "handle_tu_build_command"
    to: "get_parser_by_language"
    type: "call"
  - from: "handle_tu_build_command"
    to: "tu_builder"
    type: "call"
  - from: "handle_tu_query_command"
    to: "symbol_index"
    type: "call"
  - from: "handle_tu_complete_command"
    to: "completion_provider"
    type: "call"
  - from: "handle_tu_references_command"
    to: "symbol_index"
    type: "call"
  - from: "handle_tu_lsp_command"
    to: "maestro_lsp_server"
    type: "call"
  - from: "handle_tu_cache_clear_command"
    to: "shutil"
    type: "call"
  - from: "handle_tu_transform_command"
    to: "get_files_by_language"
    type: "call"
  - from: "handle_tu_transform_command"
    to: "detect_language_from_path"
    type: "call"
  - from: "handle_tu_transform_command"
    to: "get_parser_by_language"
    type: "call"
  - from: "handle_tu_transform_command"
    to: "tu_builder"
    type: "call"
  - from: "handle_tu_transform_command"
    to: "upp_convention_transformer"
    type: "call"
  - from: "handle_tu_print_ast_command"
    to: "get_parser_by_language"
    type: "call"
  - from: "handle_tu_print_ast_command"
    to: "ast_printer"
    type: "call"
  - from: "handle_tu_draft_command"
    to: "get_files_by_language"
    type: "call"
  - from: "handle_tu_draft_command"
    to: "detect_language_from_path"
    type: "call"
  - from: "handle_tu_draft_command"
    to: "get_parser_by_language"
    type: "call"
  - from: "handle_tu_draft_command"
    to: "code_generator"
    type: "call"

evidence:
  - v1/internal/deep/cmd_tu_deep.puml
  - maestro/commands/tu.py
  - maestro/tu/tu_builder.py
  - maestro/tu/indexing.py
  - maestro/tu/lsp_server.py
  - maestro/tu/transformers.py
  - maestro/tu/ast.py
  - maestro/tu/code_generator.py

ledger_hints:
  - "Observed .maestro directory usage for TU cache and analysis; violates FORBID_REPO_DOT_MAESTRO invariant; migrate to ./docs/maestro/ structure"
