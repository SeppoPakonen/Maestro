id: "CMD-init"
layer: "code"
title: "init deep internal flow (observed)"
status: "partial"
confidence: "medium"
storage_backend: "markdown"

calls:
  - maestro.main.main
  - maestro.modules.cli_parser.create_main_parser
  - maestro.commands.init.add_init_parser
  - maestro.commands.init.handle_init_command
  - pathlib.Path.mkdir
  - pathlib.Path.exists
  - builtins.open
  - file.write

stores:
  - docs/Settings.md
  - docs/RepoRules.md
  - docs/
  - docs/tracks/
  - docs/phases/
  - docs/tasks/
  - docs/sessions/

nodes:
  - id: "main_entry"
    type: "function"
    label: "maestro.main.main"
    module: "maestro.main"
    function: "main"
  - id: "create_parser"
    type: "function"
    label: "maestro.modules.cli_parser.create_main_parser"
    module: "maestro.modules.cli_parser"
    function: "create_main_parser"
  - id: "add_init_parser"
    type: "function"
    label: "maestro.commands.init.add_init_parser"
    module: "maestro.commands.init"
    function: "add_init_parser"
  - id: "handle_init_command"
    type: "function"
    label: "maestro.commands.init.handle_init_command"
    module: "maestro.commands.init"
    function: "handle_init_command"
  - id: "pathlib_mkdir"
    type: "function"
    label: "pathlib.Path.mkdir"
    module: "pathlib"
    function: "mkdir"
  - id: "pathlib_exists"
    type: "function"
    label: "pathlib.Path.exists"
    module: "pathlib"
    function: "exists"
  - id: "builtin_open"
    type: "function"
    label: "builtins.open"
    module: "builtins"
    function: "open"
  - id: "file_write"
    type: "function"
    label: "file.write"
    module: "builtins"
    function: "write"
  - id: "stdout_print"
    type: "actor"
    label: "stdout"
    description: "Prints status messages to user"
  - id: "local_filesystem"
    type: "datastore"
    label: "Local Filesystem"
    description: "File system operations for creating directories and files"

edges:
  - from: "main_entry"
    to: "create_parser"
    type: "call"
    label: "Initializes parser"
  - from: "create_parser"
    to: "add_init_parser"
    type: "call"
    label: "Adds 'init' command to parser"
  - from: "main_entry"
    to: "handle_init_command"
    type: "call"
    label: "Dispatches 'init' command"
  - from: "handle_init_command"
    to: "pathlib_mkdir"
    type: "call"
    label: "Creates docs/ and subdirectories"
  - from: "pathlib_mkdir"
    to: "local_filesystem"
    type: "data"
    label: "Creates directories"
  - from: "handle_init_command"
    to: "pathlib_exists"
    type: "call"
    label: "Checks if docs/Settings.md exists"
  - from: "pathlib_exists"
    to: "local_filesystem"
    type: "data"
    label: "Reads file existence"
  - from: "handle_init_command"
    to: "pathlib_exists"
    type: "call"
    label: "Checks if docs/RepoRules.md exists"
  - from: "handle_init_command"
    to: "builtin_open"
    type: "call"
    label: "Creates docs/Settings.md or docs/RepoRules.md"
  - from: "builtin_open"
    to: "file_write"
    type: "call"
    label: "Writes file content"
  - from: "file_write"
    to: "local_filesystem"
    type: "data"
    label: "Writes file"
  - from: "handle_init_command"
    to: "stdout_print"
    type: "call"
    label: "Prints status messages"

evidence:
  - path: "maestro/commands/init.py"
    type: "source_code"
    description: "Contains the handle_init_command function and add_init_parser"
  - path: "maestro/main.py"
    type: "source_code"
    description: "Contains the main entry point"
  - path: "maestro/modules/cli_parser.py"
    type: "source_code"
    description: "Contains the create_main_parser function"
  - path: "v1/internal/deep/cmd_init_deep.puml"
    type: "v1_diagram"
    description: "PlantUML diagram showing the deep internal flow for init command"

ledger_hints:
  - "Observed DataMarkdown persistence in cmd_init deep flow; v2 repo truth uses JSON. Replace/remove DataMarkdown codepaths and update docs/tests."
