id: "CMD-track"
layer: "code"
title: "track deep internal flow (observed)"
status: "partial"
confidence: "high"
storage_backend: "mixed"

calls:
  - "maestro.main.main"
  - "maestro.commands.track.handle_track_command"
  - "maestro.commands.track.list_tracks"
  - "maestro.commands.track.show_track"
  - "maestro.commands.track.show_track_details"
  - "maestro.commands.track.add_track"
  - "maestro.commands.track.remove_track"
  - "maestro.commands.track.edit_track"
  - "maestro.commands.track.set_track_status"
  - "maestro.commands.track.set_track_context"
  - "maestro.commands.discuss.handle_track_discuss"
  - "maestro.commands.track.resolve_track_identifier"
  - "maestro.data.common_utils.resolve_identifier_by_type"
  - "maestro.data.common_utils.get_all_tracks_with_phases_and_tasks"
  - "maestro.data.markdown_writer.extract_track_block"
  - "maestro.data.markdown_writer.replace_track_block"
  - "maestro.data.markdown_writer.update_track_metadata"
  - "maestro.data.markdown_writer.update_track_heading_status"
  - "maestro.display.table_renderer.render_track_table"
  - "maestro.display.table_renderer.render_phase_table"
  - "maestro.tracks.json_store.JsonStore"
  - "maestro.tracks.json_store.load_track"
  - "maestro.tracks.json_store.save_track"
  - "maestro.tracks.json_store.load_index"
  - "maestro.tracks.json_store.save_index"
  - "maestro.tracks.models.Track"
  - "maestro.config.settings.get_settings"
  - "maestro.commands.status_utils.normalize_status"
  - "maestro.commands.track._slugify_track_id"
  - "maestro.commands.track._ensure_todo_file"
  - "maestro.commands.track._parse_todo_safe"

stores:
  - "docs/todo.md"
  - "docs/done.md"
  - ".maestro/tracks/*.json"
  - ".maestro/tracks/index.json"
  - "$HOME/.maestro/settings.json"

nodes:
  - id: "main_entry"
    type: "function"
    module: "maestro/main.py"
    function: "main"
    label: "main()"
  - id: "handle_track_command"
    type: "function"
    module: "maestro/commands/track.py"
    function: "handle_track_command"
    label: "handle_track_command()"
  - id: "list_tracks"
    type: "function"
    module: "maestro/commands/track.py"
    function: "list_tracks"
    label: "list_tracks()"
  - id: "show_track"
    type: "function"
    module: "maestro/commands/track.py"
    function: "show_track"
    label: "show_track()"
  - id: "show_track_details"
    type: "function"
    module: "maestro/commands/track.py"
    function: "show_track_details"
    label: "show_track_details()"
  - id: "add_track"
    type: "function"
    module: "maestro/commands/track.py"
    function: "add_track"
    label: "add_track()"
  - id: "remove_track"
    type: "function"
    module: "maestro/commands/track.py"
    function: "remove_track"
    label: "remove_track()"
  - id: "edit_track"
    type: "function"
    module: "maestro/commands/track.py"
    function: "edit_track"
    label: "edit_track()"
  - id: "set_track_status"
    type: "function"
    module: "maestro/commands/track.py"
    function: "set_track_status"
    label: "set_track_status()"
  - id: "set_track_context"
    type: "function"
    module: "maestro/commands/track.py"
    function: "set_track_context"
    label: "set_track_context()"
  - id: "handle_track_discuss"
    type: "function"
    module: "maestro/commands/discuss.py"
    function: "handle_track_discuss"
    label: "handle_track_discuss()"
  - id: "resolve_track_identifier"
    type: "function"
    module: "maestro/commands/track.py"
    function: "resolve_track_identifier"
    label: "resolve_track_identifier()"
  - id: "resolve_identifier_by_type"
    type: "function"
    module: "maestro/data/common_utils.py"
    function: "resolve_identifier_by_type"
    label: "resolve_identifier_by_type()"
  - id: "get_all_tracks"
    type: "function"
    module: "maestro/data/common_utils.py"
    function: "get_all_tracks_with_phases_and_tasks"
    label: "get_all_tracks_with_phases_and_tasks()"
  - id: "extract_track_block"
    type: "function"
    module: "maestro/data/markdown_writer.py"
    function: "extract_track_block"
    label: "extract_track_block()"
  - id: "replace_track_block"
    type: "function"
    module: "maestro/data/markdown_writer.py"
    function: "replace_track_block"
    label: "replace_track_block()"
  - id: "update_track_metadata"
    type: "function"
    module: "maestro/data/markdown_writer.py"
    function: "update_track_metadata"
    label: "update_track_metadata()"
  - id: "update_track_heading_status"
    type: "function"
    module: "maestro/data/markdown_writer.py"
    function: "update_track_heading_status"
    label: "update_track_heading_status()"
  - id: "render_track_table"
    type: "function"
    module: "maestro/display/table_renderer.py"
    function: "render_track_table"
    label: "render_track_table()"
  - id: "render_phase_table"
    type: "function"
    module: "maestro/display/table_renderer.py"
    function: "render_phase_table"
    label: "render_phase_table()"
  - id: "json_store"
    type: "class"
    module: "maestro/tracks/json_store.py"
    class: "JsonStore"
    label: "JsonStore"
  - id: "load_track"
    type: "function"
    module: "maestro/tracks/json_store.py"
    function: "load_track"
    label: "load_track()"
  - id: "save_track"
    type: "function"
    module: "maestro/tracks/json_store.py"
    function: "save_track"
    label: "save_track()"
  - id: "load_index"
    type: "function"
    module: "maestro/tracks/json_store.py"
    function: "load_index"
    label: "load_index()"
  - id: "save_index"
    type: "function"
    module: "maestro/tracks/json_store.py"
    function: "save_index"
    label: "save_index()"
  - id: "track_class"
    type: "class"
    module: "maestro/tracks/models.py"
    class: "Track"
    label: "Track"
  - id: "get_settings"
    type: "function"
    module: "maestro/config/settings.py"
    function: "get_settings"
    label: "get_settings()"
  - id: "normalize_status"
    type: "function"
    module: "maestro/commands/status_utils.py"
    function: "normalize_status"
    label: "normalize_status()"
  - id: "_slugify_track_id"
    type: "function"
    module: "maestro/commands/track.py"
    function: "_slugify_track_id"
    label: "_slugify_track_id()"
  - id: "_ensure_todo_file"
    type: "function"
    module: "maestro/commands/track.py"
    function: "_ensure_todo_file"
    label: "_ensure_todo_file()"
  - id: "_parse_todo_safe"
    type: "function"
    module: "maestro/commands/track.py"
    function: "_parse_todo_safe"
    label: "_parse_todo_safe()"
  - id: "docs_todo_md"
    type: "datastore"
    label: "docs/todo.md"
  - id: "docs_done_md"
    type: "datastore"
    label: "docs/done.md"
  - id: "maestro_tracks_json"
    type: "datastore"
    label: ".maestro/tracks/*.json"
  - id: "maestro_tracks_index_json"
    type: "datastore"
    label: ".maestro/tracks/index.json"
  - id: "settings_json"
    type: "datastore"
    label: "$HOME/.maestro/settings.json"
  - id: "editor"
    type: "actor"
    label: "User's $EDITOR"
  - id: "file_system"
    type: "actor"
    label: "File System"

edges:
  - from: "main_entry"
    to: "handle_track_command"
    type: "call"
  - from: "handle_track_command"
    to: "list_tracks"
    type: "call"
  - from: "handle_track_command"
    to: "show_track"
    type: "call"
  - from: "handle_track_command"
    to: "show_track_details"
    type: "call"
  - from: "handle_track_command"
    to: "add_track"
    type: "call"
  - from: "handle_track_command"
    to: "remove_track"
    type: "call"
  - from: "handle_track_command"
    to: "edit_track"
    type: "call"
  - from: "handle_track_command"
    to: "set_track_status"
    type: "call"
  - from: "handle_track_command"
    to: "set_track_context"
    type: "call"
  - from: "handle_track_command"
    to: "handle_track_discuss"
    type: "call"
  - from: "list_tracks"
    to: "get_all_tracks"
    type: "call"
  - from: "list_tracks"
    to: "render_track_table"
    type: "call"
  - from: "show_track"
    to: "resolve_track_identifier"
    type: "call"
  - from: "show_track"
    to: "_parse_todo_safe"
    type: "call"
  - from: "show_track"
    to: "get_settings"
    type: "call"
  - from: "show_track"
    to: "render_phase_table"
    type: "call"
  - from: "show_track_details"
    to: "resolve_track_identifier"
    type: "call"
  - from: "show_track_details"
    to: "_parse_todo_safe"
    type: "call"
  - from: "add_track"
    to: "json_store"
    type: "call"
  - from: "add_track"
    to: "_slugify_track_id"
    type: "call"
  - from: "add_track"
    to: "track_class"
    type: "call"
  - from: "add_track"
    to: "save_track"
    type: "call"
  - from: "add_track"
    to: "load_track"
    type: "call"
  - from: "remove_track"
    to: "json_store"
    type: "call"
  - from: "remove_track"
    to: "resolve_track_identifier"
    type: "call"
  - from: "remove_track"
    to: "load_track"
    type: "call"
  - from: "remove_track"
    to: "load_index"
    type: "call"
  - from: "remove_track"
    to: "save_index"
    type: "call"
  - from: "remove_track"
    to: "file_system"
    type: "call"
  - from: "edit_track"
    to: "resolve_track_identifier"
    type: "call"
  - from: "edit_track"
    to: "extract_track_block"
    type: "call"
  - from: "edit_track"
    to: "editor"
    type: "call"
  - from: "edit_track"
    to: "replace_track_block"
    type: "call"
  - from: "set_track_status"
    to: "resolve_track_identifier"
    type: "call"
  - from: "set_track_status"
    to: "normalize_status"
    type: "call"
  - from: "set_track_status"
    to: "update_track_metadata"
    type: "call"
  - from: "set_track_status"
    to: "update_track_heading_status"
    type: "call"
  - from: "set_track_context"
    to: "resolve_track_identifier"
    type: "call"
  - from: "set_track_context"
    to: "get_settings"
    type: "call"
  - from: "resolve_track_identifier"
    to: "resolve_identifier_by_type"
    type: "call"

evidence:
  - "maestro/commands/track.py"
  - "maestro/data/common_utils.py"
  - "maestro/data/markdown_writer.py"
  - "maestro/display/table_renderer.py"
  - "maestro/tracks/json_store.py"
  - "maestro/tracks/models.py"
  - "maestro/config/settings.py"
  - "maestro/commands/status_utils.py"
  - "maestro/commands/discuss.py"

ledger_hints:
  - "Observed DataMarkdown persistence in cmd_track deep flow; v2 repo truth uses JSON. Replace/remove DataMarkdown codepaths and update docs/tests."
  - "Observed ./.maestro directory usage in track command flow; contradicts FORBID_REPO_DOT_MAESTRO invariant. Migrate to ./docs/maestro/ for repo truth."
