id: "CMD-ops"
layer: "code"
title: "ops deep internal flow (observed)"
status: "partial"
confidence: "high"
storage_backend: "mixed"

calls:
  - "maestro.main.main"
  - "maestro.project_ops.commands.add_project_ops_parser"
  - "maestro.project_ops.commands.handle_project_ops_validate"
  - "maestro.project_ops.commands.handle_project_ops_preview"
  - "maestro.project_ops.commands.handle_project_ops_apply"
  - "maestro.project_ops.decoder.decode_project_ops_json"
  - "maestro.project_ops.schemas.validate_project_ops_result"
  - "maestro.project_ops.translator.actions_to_ops"
  - "maestro.project_ops.executor.ProjectOpsExecutor"
  - "maestro.project_ops.executor.preview_ops"
  - "maestro.project_ops.executor.apply_ops"
  - "maestro.data.markdown_writer.insert_track_block"
  - "maestro.data.markdown_writer.insert_phase_block"
  - "maestro.data.markdown_writer.insert_task_block"
  - "maestro.data.markdown_writer.update_task_metadata"
  - "maestro.data.markdown_writer.update_phase_metadata"
  - "maestro.data.markdown_writer.update_track_metadata"
  - "maestro.tracks.json_store.JsonStore"
  - "maestro.tracks.json_store.save_track"
  - "maestro.tracks.json_store.save_phase"
  - "maestro.tracks.json_store.save_task"
  - "maestro.tracks.json_store.load_track"
  - "maestro.tracks.json_store.load_phase"
  - "maestro.tracks.json_store.load_task"
  - "maestro.tracks.json_store.load_index"
  - "maestro.tracks.json_store.save_index"
  - "maestro.tracks.models.Track"
  - "maestro.tracks.models.Phase"
  - "maestro.tracks.models.Task"

stores:
  - "docs/todo.md"
  - ".maestro/tracks/*.json"

nodes:
  - id: "main_entry"
    type: "function"
    module: "maestro/main.py"
    function: "main"
  - id: "add_project_ops_parser"
    type: "function"
    module: "maestro/project_ops/commands.py"
    function: "add_project_ops_parser"
  - id: "handle_project_ops_validate"
    type: "function"
    module: "maestro/project_ops/commands.py"
    function: "handle_project_ops_validate"
  - id: "handle_project_ops_preview"
    type: "function"
    module: "maestro/project_ops/commands.py"
    function: "handle_project_ops_preview"
  - id: "handle_project_ops_apply"
    type: "function"
    module: "maestro/project_ops/commands.py"
    function: "handle_project_ops_apply"
  - id: "decode_project_ops_json"
    type: "function"
    module: "maestro/project_ops/decoder.py"
    function: "decode_project_ops_json"
  - id: "validate_project_ops_result"
    type: "function"
    module: "maestro/project_ops/schemas.py"
    function: "validate_project_ops_result"
  - id: "actions_to_ops"
    type: "function"
    module: "maestro/project_ops/translator.py"
    function: "actions_to_ops"
  - id: "project_ops_executor"
    type: "class"
    module: "maestro/project_ops/executor.py"
    class: "ProjectOpsExecutor"
  - id: "preview_ops"
    type: "function"
    module: "maestro/project_ops/executor.py"
    function: "preview_ops"
  - id: "apply_ops"
    type: "function"
    module: "maestro/project_ops/executor.py"
    function: "apply_ops"
  - id: "insert_track_block"
    type: "function"
    module: "maestro/data/markdown_writer.py"
    function: "insert_track_block"
  - id: "insert_phase_block"
    type: "function"
    module: "maestro/data/markdown_writer.py"
    function: "insert_phase_block"
  - id: "insert_task_block"
    type: "function"
    module: "maestro/data/markdown_writer.py"
    function: "insert_task_block"
  - id: "update_task_metadata"
    type: "function"
    module: "maestro/data/markdown_writer.py"
    function: "update_task_metadata"
  - id: "update_phase_metadata"
    type: "function"
    module: "maestro/data/markdown_writer.py"
    function: "update_phase_metadata"
  - id: "update_track_metadata"
    type: "function"
    module: "maestro/data/markdown_writer.py"
    function: "update_track_metadata"
  - id: "json_store"
    type: "class"
    module: "maestro/tracks/json_store.py"
    class: "JsonStore"
  - id: "save_track"
    type: "function"
    module: "maestro/tracks/json_store.py"
    function: "save_track"
  - id: "save_phase"
    type: "function"
    module: "maestro/tracks/json_store.py"
    function: "save_phase"
  - id: "save_task"
    type: "function"
    module: "maestro/tracks/json_store.py"
    function: "save_task"
  - id: "load_track"
    type: "function"
    module: "maestro/tracks/json_store.py"
    function: "load_track"
  - id: "load_phase"
    type: "function"
    module: "maestro/tracks/json_store.py"
    function: "load_phase"
  - id: "load_task"
    type: "function"
    module: "maestro/tracks/json_store.py"
    function: "load_task"
  - id: "load_index"
    type: "function"
    module: "maestro/tracks/json_store.py"
    function: "load_index"
  - id: "save_index"
    type: "function"
    module: "maestro/tracks/json_store.py"
    function: "save_index"
  - id: "track_class"
    type: "class"
    module: "maestro/tracks/models.py"
    class: "Track"
  - id: "phase_class"
    type: "class"
    module: "maestro/tracks/models.py"
    class: "Phase"
  - id: "task_class"
    type: "class"
    module: "maestro/tracks/models.py"
    class: "Task"
  - id: "file_system"
    type: "actor"
    label: "File System"
  - id: "docs_todo_md"
    type: "datastore"
    path: "docs/todo.md"
  - id: "maestro_tracks_json"
    type: "datastore"
    path: ".maestro/tracks/*.json"

edges:
  - from: "main_entry"
    to: "add_project_ops_parser"
  - from: "main_entry"
    to: "handle_project_ops_validate"
  - from: "main_entry"
    to: "handle_project_ops_preview"
  - from: "main_entry"
    to: "handle_project_ops_apply"
  - from: "handle_project_ops_validate"
    to: "decode_project_ops_json"
  - from: "decode_project_ops_json"
    to: "validate_project_ops_result"
  - from: "handle_project_ops_preview"
    to: "decode_project_ops_json"
  - from: "handle_project_ops_preview"
    to: "actions_to_ops"
  - from: "handle_project_ops_preview"
    to: "preview_ops"
  - from: "preview_ops"
    to: "project_ops_executor"
  - from: "handle_project_ops_apply"
    to: "decode_project_ops_json"
  - from: "handle_project_ops_apply"
    to: "actions_to_ops"
  - from: "handle_project_ops_apply"
    to: "apply_ops"
  - from: "apply_ops"
    to: "project_ops_executor"
  - from: "apply_ops"
    to: "insert_track_block"
  - from: "apply_ops"
    to: "insert_phase_block"
  - from: "apply_ops"
    to: "insert_task_block"
  - from: "apply_ops"
    to: "update_task_metadata"
  - from: "apply_ops"
    to: "update_phase_metadata"
  - from: "apply_ops"
    to: "update_track_metadata"
  - from: "apply_ops"
    to: "save_track"
  - from: "apply_ops"
    to: "save_phase"
  - from: "apply_ops"
    to: "save_task"
  - from: "apply_ops"
    to: "load_track"
  - from: "apply_ops"
    to: "load_phase"
  - from: "apply_ops"
    to: "load_task"
  - from: "apply_ops"
    to: "load_index"
  - from: "apply_ops"
    to: "save_index"
  - from: "insert_track_block"
    to: "file_system"
  - from: "insert_phase_block"
    to: "file_system"
  - from: "insert_task_block"
    to: "file_system"
  - from: "update_task_metadata"
    to: "file_system"
  - from: "update_phase_metadata"
    to: "file_system"
  - from: "update_track_metadata"
    to: "file_system"
  - from: "save_track"
    to: "file_system"
  - from: "save_phase"
    to: "file_system"
  - from: "save_task"
    to: "file_system"
  - from: "load_index"
    to: "file_system"
  - from: "save_index"
    to: "file_system"
  - from: "file_system"
    to: "docs_todo_md"
  - from: "file_system"
    to: "maestro_tracks_json"

evidence:
  - "maestro/project_ops/commands.py"
  - "maestro/project_ops/decoder.py"
  - "maestro/project_ops/schemas.py"
  - "maestro/project_ops/translator.py"
  - "maestro/project_ops/executor.py"
  - "maestro/data/markdown_writer.py"
  - "maestro/tracks/json_store.py"
  - "maestro/tracks/models.py"
  - "v1/internal/deep/cmd_ops_deep.puml"

ledger_hints:
  - "Observed DataMarkdown persistence in cmd_ops deep flow; v2 repo truth uses JSON. Replace/remove DataMarkdown codepaths and update docs/tests."
  - "Observed .maestro directory usage in ops command flow; violates FORBID_REPO_DOT_MAESTRO invariant; migrate to ./docs/maestro/ for repo truth."
