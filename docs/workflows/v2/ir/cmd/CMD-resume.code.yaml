id: "CMD-resume"
layer: "code"
title: "resume deep internal flow (observed)"
status: "partial"
confidence: "medium"
storage_backend: "json"

calls:
  - "maestro/main.py::main()"
  - "maestro/modules/command_handlers.py::handle_resume_session()"
  - "maestro/modules/command_handlers.py::load_session()"
  - "maestro/modules/command_handlers.py::save_session()"
  - "maestro/modules/command_handlers.py::update_subtask_summary_paths()"
  - "maestro/modules/command_handlers.py::has_legacy_plan()"
  - "maestro/modules/command_handlers.py::migrate_session_if_needed()"
  - "maestro/modules/command_handlers.py::load_rules()"
  - "maestro/modules/command_handlers.py::get_maestro_dir()"
  - "maestro/modules/command_handlers.py::build_prompt()"
  - "maestro/modules/command_handlers.py::save_prompt_for_traceability()"
  - "maestro/modules/command_handlers.py::save_ai_output()"
  - "maestro/modules/command_handlers.py::log_verbose()"
  - "maestro/engines.py::get_engine()"
  - "maestro/session_model.py::Session"
  - "maestro/session_model.py::Subtask"
  - "maestro/session_model.py::PlanNode"

stores:
  - "docs/sessions/<name>/session.json"
  - "docs/sessions/<name>/rules.txt"
  - "docs/sessions/<name>/partials/worker_*.partial.txt"
  - "docs/sessions/<name>/inputs/worker_*.prompt.txt"
  - "docs/sessions/<name>/outputs/worker_*.stdout.txt"
  - "docs/sessions/<name>/outputs/<subtask.id>.summary.txt"

nodes:
  - id: "main_entry"
    type: "function"
    module: "maestro/main.py"
    function: "main()"
  - id: "handle_resume_session"
    type: "function"
    module: "maestro/modules/command_handlers.py"
    function: "handle_resume_session()"
  - id: "load_session"
    type: "function"
    module: "maestro/modules/command_handlers.py"
    function: "load_session()"
  - id: "save_session"
    type: "function"
    module: "maestro/modules/command_handlers.py"
    function: "save_session()"
  - id: "update_subtask_summary_paths"
    type: "function"
    module: "maestro/modules/command_handlers.py"
    function: "update_subtask_summary_paths()"
  - id: "has_legacy_plan"
    type: "function"
    module: "maestro/modules/command_handlers.py"
    function: "has_legacy_plan()"
  - id: "migrate_session_if_needed"
    type: "function"
    module: "maestro/modules/command_handlers.py"
    function: "migrate_session_if_needed()"
  - id: "load_rules"
    type: "function"
    module: "maestro/modules/command_handlers.py"
    function: "load_rules()"
  - id: "get_maestro_dir"
    type: "function"
    module: "maestro/modules/command_handlers.py"
    function: "get_maestro_dir()"
  - id: "build_prompt"
    type: "function"
    module: "maestro/modules/command_handlers.py"
    function: "build_prompt()"
  - id: "save_prompt_for_traceability"
    type: "function"
    module: "maestro/modules/command_handlers.py"
    function: "save_prompt_for_traceability()"
  - id: "get_engine"
    type: "function"
    module: "maestro/engines.py"
    function: "get_engine()"
  - id: "session_class"
    type: "class"
    module: "maestro/session_model.py"
    class: "Session"
  - id: "subtask_class"
    type: "class"
    module: "maestro/session_model.py"
    class: "Subtask"
  - id: "plan_node_class"
    type: "class"
    module: "maestro/session_model.py"
    class: "PlanNode"
  - id: "docs_sessions_dir"
    type: "datastore"
    path: "docs/sessions/<name>/"
  - id: "file_system"
    type: "actor"
  - id: "external_ai"
    type: "actor"

edges:
  - from: "main_entry"
    to: "handle_resume_session"
  - from: "handle_resume_session"
    to: "load_session"
  - from: "load_session"
    to: "docs_sessions_dir"
  - from: "handle_resume_session"
    to: "update_subtask_summary_paths"
  - from: "handle_resume_session"
    to: "has_legacy_plan"
  - from: "handle_resume_session"
    to: "migrate_session_if_needed"
  - from: "handle_resume_session"
    to: "load_rules"
  - from: "load_rules"
    to: "docs_sessions_dir"
  - from: "handle_resume_session"
    to: "session_class"
  - from: "handle_resume_session"
    to: "get_maestro_dir"
  - from: "get_maestro_dir"
    to: "file_system"
  - from: "handle_resume_session"
    to: "build_prompt"
  - from: "handle_resume_session"
    to: "save_prompt_for_traceability"
  - from: "save_prompt_for_traceability"
    to: "docs_sessions_dir"
  - from: "handle_resume_session"
    to: "get_engine"
  - from: "handle_resume_session"
    to: "external_ai"
  - from: "handle_resume_session"
    to: "session_class"
  - from: "handle_resume_session"
    to: "save_session"
  - from: "save_session"
    to: "docs_sessions_dir"
  - from: "session_class"
    to: "load_session"
  - from: "session_class"
    to: "save_session"

evidence:
  - "v1/internal/deep/cmd_resume_deep.puml"

ledger_hints:
  - "Observed JSON persistence in docs/sessions/<name>/ directory structure; aligns with REPO_TRUTH_FORMAT_IS_JSON invariant"
