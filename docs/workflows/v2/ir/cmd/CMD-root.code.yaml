id: "CMD-root"
layer: "code"
title: "root deep internal flow (observed)"
status: "partial"
confidence: "medium"
storage_backend: "json"

calls:
  - maestro.main.main
  - maestro.modules.command_handlers.handle_root_set
  - maestro.modules.command_handlers.handle_root_get
  - maestro.modules.command_handlers.handle_root_refine
  - maestro.modules.command_handlers.handle_root_discuss
  - maestro.modules.command_handlers.handle_root_show
  - maestro.session_model.load_session
  - maestro.session_model.save_session
  - maestro.modules.utils.handle_refine_root
  - maestro.engines.get_engine
  - maestro.modules.command_handlers.get_maestro_dir
  - maestro.modules.command_handlers.update_subtask_summary_paths

stores:
  - docs/sessions/<session-name>/session.json
  - .maestro/conversations/

nodes:
  - id: "main_entry"
    type: "function"
    module: "maestro.main"
    function: "main"
  - id: "handle_root_set"
    type: "function"
    module: "maestro.modules.command_handlers"
    function: "handle_root_set"
  - id: "handle_root_get"
    type: "function"
    module: "maestro.modules.command_handlers"
    function: "handle_root_get"
  - id: "handle_root_refine"
    type: "function"
    module: "maestro.modules.command_handlers"
    function: "handle_root_refine"
  - id: "handle_root_discuss"
    type: "function"
    module: "maestro.modules.command_handlers"
    function: "handle_root_discuss"
  - id: "handle_root_show"
    type: "function"
    module: "maestro.modules.command_handlers"
    function: "handle_root_show"
  - id: "load_session"
    type: "function"
    module: "maestro.session_model"
    function: "load_session"
  - id: "save_session"
    type: "function"
    module: "maestro.session_model"
    function: "save_session"
  - id: "session_class"
    type: "class"
    module: "maestro.session_model"
    class: "Session"
  - id: "handle_refine_root"
    type: "function"
    module: "maestro.modules.utils"
    function: "handle_refine_root"
  - id: "get_engine"
    type: "function"
    module: "maestro.engines"
    function: "get_engine"
  - id: "get_maestro_dir"
    type: "function"
    module: "maestro.modules.command_handlers"
    function: "get_maestro_dir"
  - id: "docs_sessions_dir"
    type: "datastore"
    path: "docs/sessions/<session-name>/"
  - id: "conversations_dir"
    type: "datastore"
    path: ".maestro/conversations/"
  - id: "user_actor"
    type: "actor"
  - id: "external_ai"
    type: "actor"

edges:
  - from: "main_entry"
    to: "handle_root_set"
  - from: "main_entry"
    to: "handle_root_get"
  - from: "main_entry"
    to: "handle_root_refine"
  - from: "main_entry"
    to: "handle_root_discuss"
  - from: "main_entry"
    to: "handle_root_show"
  - from: "handle_root_set"
    to: "load_session"
  - from: "handle_root_get"
    to: "load_session"
  - from: "handle_root_refine"
    to: "load_session"
  - from: "handle_root_discuss"
    to: "load_session"
  - from: "handle_root_show"
    to: "load_session"
  - from: "load_session"
    to: "docs_sessions_dir"
  - from: "handle_root_set"
    to: "session_class"
  - from: "handle_root_set"
    to: "save_session"
  - from: "save_session"
    to: "docs_sessions_dir"
  - from: "handle_root_refine"
    to: "handle_refine_root"
  - from: "handle_refine_root"
    to: "get_engine"
  - from: "get_engine"
    to: "external_ai"
  - from: "handle_root_discuss"
    to: "get_maestro_dir"
  - from: "get_maestro_dir"
    to: "conversations_dir"
  - from: "handle_root_discuss"
    to: "user_actor"
  - from: "handle_root_discuss"
    to: "get_engine"
  - from: "handle_root_discuss"
    to: "session_class"
  - from: "handle_root_discuss"
    to: "save_session"
  - from: "handle_root_discuss"
    to: "conversations_dir"

evidence:
  - "v1/internal/deep/cmd_root_deep.puml"
  - "maestro/modules/command_handlers.py"
  - "maestro/session_model.py"

ledger_hints:
  - "Observed .maestro/conversations/ directory usage in cmd_root deep flow; v2 spec uses only ./docs/maestro/ for persistence. Enforce REPO_TRUTH_IS_DOCS_MAESTRO and remove .maestro usage."
