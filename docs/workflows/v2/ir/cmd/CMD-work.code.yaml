id: "CMD-work"
layer: "code"
title: "work deep internal flow (observed)"
status: "partial"
confidence: "high"
storage_backend: "json"

calls:
  - maestro.main.main
  - maestro.commands.work.add_work_parser
  - maestro.commands.work.handle_work_any
  - maestro.commands.work.handle_work_any_pick
  - maestro.commands.work.handle_work_track
  - maestro.commands.work.handle_work_phase
  - maestro.commands.work.handle_work_issue
  - maestro.commands.work.handle_work_task
  - maestro.commands.work.handle_work_discuss
  - maestro.commands.work.handle_work_analyze
  - maestro.commands.work.handle_work_fix
  - maestro.commands.work.load_available_work
  - maestro.commands.work.ai_select_work_items
  - maestro.commands.work.simple_priority_sort
  - maestro.commands.work._run_ai_interaction_with_breadcrumb
  - maestro.commands.work._safe_generate
  - maestro.commands.work.load_issues
  - maestro.commands.work._load_task_entries
  - maestro.work_session.create_session
  - maestro.work_session.complete_session
  - maestro.work_session.save_session
  - maestro.work_session.is_breadcrumb_enabled
  - maestro.work_session.load_breadcrumb_settings
  - maestro.breadcrumb.create_breadcrumb
  - maestro.breadcrumb.write_breadcrumb
  - maestro.breadcrumb.estimate_tokens
  - maestro.breadcrumb.calculate_cost
  - maestro.ai.task_sync.build_task_prompt
  - maestro.ai.task_sync.build_task_queue
  - maestro.ai.task_sync.find_task_context
  - maestro.ai.task_sync.task_is_done
  - maestro.ai.task_sync.write_sync_state
  - maestro.engines.get_engine
  - maestro.data.parse_todo_md
  - maestro.data.parse_phase_md
  - maestro.commands.discuss.handle_track_discuss
  - maestro.commands.discuss.handle_phase_discuss
  - maestro.commands.discuss.handle_task_discuss
  - maestro.workers.track_worker.execute_track_work
  - maestro.workers.phase_worker.execute_phase_work
  - maestro.workers.issue_worker.execute_issue_work

stores:
  - docs/todo.md
  - docs/issues/*.md
  - docs/phases/*.md
  - docs/ai_sync.json
  - docs/sessions/*.json
  - docs/sessions/*/breadcrumbs.jsonl

nodes:
  - id: "main_entry"
    type: "function"
    label: "maestro.main.main"
    module: "maestro/main.py"
  - id: "add_work_parser"
    type: "function"
    label: "add_work_parser"
    module: "maestro/commands/work.py"
  - id: "handle_work_any"
    type: "function"
    label: "handle_work_any"
    module: "maestro/commands/work.py"
  - id: "handle_work_any_pick"
    type: "function"
    label: "handle_work_any_pick"
    module: "maestro/commands/work.py"
  - id: "handle_work_track"
    type: "function"
    label: "handle_work_track"
    module: "maestro/commands/work.py"
  - id: "handle_work_phase"
    type: "function"
    label: "handle_work_phase"
    module: "maestro/commands/work.py"
  - id: "handle_work_issue"
    type: "function"
    label: "handle_work_issue"
    module: "maestro/commands/work.py"
  - id: "handle_work_task"
    type: "function"
    label: "handle_work_task"
    module: "maestro/commands/work.py"
  - id: "handle_work_discuss"
    type: "function"
    label: "handle_work_discuss"
    module: "maestro/commands/work.py"
  - id: "handle_work_analyze"
    type: "function"
    label: "handle_work_analyze"
    module: "maestro/commands/work.py"
  - id: "handle_work_fix"
    type: "function"
    label: "handle_work_fix"
    module: "maestro/commands/work.py"
  - id: "load_available_work"
    type: "function"
    label: "load_available_work"
    module: "maestro/commands/work.py"
  - id: "ai_select_work_items"
    type: "function"
    label: "ai_select_work_items"
    module: "maestro/commands/work.py"
  - id: "simple_priority_sort"
    type: "function"
    label: "simple_priority_sort"
    module: "maestro/commands/work.py"
  - id: "_run_ai_interaction_with_breadcrumb"
    type: "function"
    label: "_run_ai_interaction_with_breadcrumb"
    module: "maestro/commands/work.py"
  - id: "_safe_generate"
    type: "function"
    label: "_safe_generate"
    module: "maestro/commands/work.py"
  - id: "load_issues"
    type: "function"
    label: "load_issues"
    module: "maestro/commands/work.py"
  - id: "_load_task_entries"
    type: "function"
    label: "_load_task_entries"
    module: "maestro/commands/work.py"
  - id: "work_session_class"
    type: "class"
    label: "WorkSession"
    module: "maestro/work_session.py"
  - id: "create_session"
    type: "function"
    label: "create_session"
    module: "maestro/work_session.py"
  - id: "complete_session"
    type: "function"
    label: "complete_session"
    module: "maestro/work_session.py"
  - id: "save_session"
    type: "function"
    label: "save_session"
    module: "maestro/work_session.py"
  - id: "is_breadcrumb_enabled"
    type: "function"
    label: "is_breadcrumb_enabled"
    module: "maestro/work_session.py"
  - id: "load_breadcrumb_settings"
    type: "function"
    label: "load_breadcrumb_settings"
    module: "maestro/work_session.py"
  - id: "create_breadcrumb"
    type: "function"
    label: "create_breadcrumb"
    module: "maestro/breadcrumb.py"
  - id: "write_breadcrumb"
    type: "function"
    label: "write_breadcrumb"
    module: "maestro/breadcrumb.py"
  - id: "estimate_tokens"
    type: "function"
    label: "estimate_tokens"
    module: "maestro/breadcrumb.py"
  - id: "calculate_cost"
    type: "function"
    label: "calculate_cost"
    module: "maestro/breadcrumb.py"
  - id: "build_task_prompt"
    type: "function"
    label: "build_task_prompt"
    module: "maestro/ai/task_sync.py"
  - id: "build_task_queue"
    type: "function"
    label: "build_task_queue"
    module: "maestro/ai/task_sync.py"
  - id: "find_task_context"
    type: "function"
    label: "find_task_context"
    module: "maestro/ai/task_sync.py"
  - id: "task_is_done"
    type: "function"
    label: "task_is_done"
    module: "maestro/ai/task_sync.py"
  - id: "write_sync_state"
    type: "function"
    label: "write_sync_state"
    module: "maestro/ai/task_sync.py"
  - id: "get_engine"
    type: "function"
    label: "get_engine"
    module: "maestro/engines.py"
  - id: "parse_todo_md"
    type: "function"
    label: "parse_todo_md"
    module: "maestro/data/markdown_parser.py"
  - id: "parse_phase_md"
    type: "function"
    label: "parse_phase_md"
    module: "maestro/data/markdown_parser.py"
  - id: "handle_track_discuss"
    type: "function"
    label: "handle_track_discuss"
    module: "maestro/commands/discuss.py"
  - id: "handle_phase_discuss"
    type: "function"
    label: "handle_phase_discuss"
    module: "maestro/commands/discuss.py"
  - id: "handle_task_discuss"
    type: "function"
    label: "handle_task_discuss"
    module: "maestro/commands/discuss.py"
  - id: "execute_track_work"
    type: "function"
    label: "execute_track_work"
    module: "maestro/workers/track_worker.py"
  - id: "execute_phase_work"
    type: "function"
    label: "execute_phase_work"
    module: "maestro/workers/phase_worker.py"
  - id: "execute_issue_work"
    type: "function"
    label: "execute_issue_work"
    module: "maestro/workers/issue_worker.py"
  - id: "file_system"
    type: "actor"
    label: "File System"
  - id: "external_ai"
    type: "actor"
    label: "External AI Service"
  - id: "user"
    type: "actor"
    label: "User (for interactive selection)"
  - id: "git"
    type: "actor"
    label: "Git CLI (for analyze context)"
  - id: "docs_todo_md"
    type: "datastore"
    label: "docs/todo.md"
  - id: "docs_issues_md"
    type: "datastore"
    label: "docs/issues/<id>.md"
  - id: "docs_phases_md"
    type: "datastore"
    label: "docs/phases/<id>.md"
  - id: "docs_sessions_dir"
    type: "datastore"
    label: "docs/sessions/"
  - id: "docs_ai_sync_json"
    type: "datastore"
    label: "docs/ai_sync.json"

edges:
  - from: "main_entry"
    to: "add_work_parser"
    label: "Adds 'work' command and subparsers"
  - from: "handle_work_any"
    to: "load_available_work"
    label: "gets items"
  - from: "handle_work_any"
    to: "ai_select_work_items"
    label: "AI chooses best"
  - from: "handle_work_any"
    to: "create_session"
    label: "starts session"
  - from: "handle_work_any"
    to: "execute_track_work"
    label: "executes work"
  - from: "handle_work_any"
    to: "execute_phase_work"
    label: "executes work"
  - from: "handle_work_any"
    to: "execute_issue_work"
    label: "executes work"
  - from: "handle_work_any_pick"
    to: "load_available_work"
    label: "loads items"
  - from: "handle_work_any_pick"
    to: "ai_select_work_items"
    label: "AI recommends top N"
  - from: "handle_work_any_pick"
    to: "user"
    label: "selects item"
  - from: "handle_work_any_pick"
    to: "create_session"
    label: "starts session"
  - from: "handle_work_any_pick"
    to: "execute_track_work"
    label: "executes work"
  - from: "handle_work_any_pick"
    to: "execute_phase_work"
    label: "executes work"
  - from: "handle_work_any_pick"
    to: "execute_issue_work"
    label: "executes work"
  - from: "handle_work_track"
    to: "load_available_work"
    label: "loads items"
  - from: "handle_work_track"
    to: "create_session"
    label: "starts session"
  - from: "handle_work_track"
    to: "execute_track_work"
    label: "executes work"
  - from: "handle_work_phase"
    to: "load_available_work"
    label: "loads items"
  - from: "handle_work_phase"
    to: "create_session"
    label: "starts session"
  - from: "handle_work_phase"
    to: "execute_phase_work"
    label: "executes work"
  - from: "handle_work_issue"
    to: "load_available_work"
    label: "loads items"
  - from: "handle_work_issue"
    to: "create_session"
    label: "starts session"
  - from: "handle_work_issue"
    to: "execute_issue_work"
    label: "executes work"
  - from: "handle_work_task"
    to: "_load_task_entries"
    label: "loads tasks"
  - from: "handle_work_task"
    to: "find_task_context"
    label: "finds context"
  - from: "handle_work_task"
    to: "build_task_queue"
    label: "builds queue"
  - from: "handle_work_task"
    to: "write_sync_state"
    label: "writes sync state"
  - from: "handle_work_task"
    to: "create_session"
    label: "starts session"
  - from: "handle_work_task"
    to: "_run_ai_interaction_with_breadcrumb"
    label: "interacts with AI"
  - from: "handle_work_discuss"
    to: "handle_track_discuss"
    label: "delegates to specific discuss handler"
  - from: "handle_work_discuss"
    to: "handle_phase_discuss"
    label: "delegates to specific discuss handler"
  - from: "handle_work_discuss"
    to: "handle_task_discuss"
    label: "delegates to specific discuss handler"
  - from: "handle_work_analyze"
    to: "load_available_work"
    label: "gathers context for AI"
  - from: "handle_work_analyze"
    to: "get_engine"
    label: "selects AI engine"
  - from: "handle_work_analyze"
    to: "_run_ai_interaction_with_breadcrumb"
    label: "runs AI analysis"
  - from: "handle_work_fix"
    to: "load_available_work"
    label: "loads items"
  - from: "handle_work_fix"
    to: "create_session"
    label: "starts session"
  - from: "handle_work_fix"
    to: "_run_ai_interaction_with_breadcrumb"
    label: "interacts with AI"
  - from: "handle_work_fix"
    to: "get_engine"
    label: "selects AI engine for multi-phase workflow"
  - from: "create_session"
    to: "docs_sessions_dir"
    label: "creates session.json"
  - from: "_run_ai_interaction_with_breadcrumb"
    to: "_safe_generate"
    label: "generates AI response"
  - from: "_run_ai_interaction_with_breadcrumb"
    to: "create_breadcrumb"
    label: "creates breadcrumb"
  - from: "_run_ai_interaction_with_breadcrumb"
    to: "write_breadcrumb"
    label: "writes breadcrumb data"
  - from: "_run_ai_interaction_with_breadcrumb"
    to: "estimate_tokens"
    label: "estimates tokens"
  - from: "_run_ai_interaction_with_breadcrumb"
    to: "calculate_cost"
    label: "calculates cost"
  - from: "complete_session"
    to: "docs_sessions_dir"
    label: "updates session.json status"
  - from: "ai_select_work_items"
    to: "get_engine"
    label: "calls AI for selection"
  - from: "ai_select_work_items"
    to: "external_ai"
    label: "interacts with AI service"
  - from: "ai_select_work_items"
    to: "simple_priority_sort"
    label: "fallback if AI fails"
  - from: "_safe_generate"
    to: "get_engine"
    label: "generates content from AI"
  - from: "_safe_generate"
    to: "external_ai"
    label: "interacts with AI service"
  - from: "load_available_work"
    to: "docs_todo_md"
    label: "reads tracks/phases"
  - from: "load_available_work"
    to: "load_issues"
    label: "reads issues"
  - from: "load_issues"
    to: "docs_issues_md"
    label: "reads issues"
  - from: "_load_task_entries"
    to: "docs_phases_md"
    label: "reads tasks"
  - from: "write_sync_state"
    to: "docs_ai_sync_json"
    label: "updates sync state"
  - from: "handle_work_fix"
    to: "docs_sessions_dir"
    label: "creates session.json"

evidence:
  - "v1/internal/deep/cmd_work_deep.puml"
  - "maestro/commands/work.py"
  - "maestro/work_session.py"
  - "maestro/breadcrumb.py"
  - "maestro/ai/task_sync.py"
  - "maestro/engines.py"
  - "maestro/data/markdown_parser.py"
  - "maestro/commands/discuss.py"
  - "maestro/workers/track_worker.py"
  - "maestro/workers/phase_worker.py"
  - "maestro/workers/issue_worker.py"

ledger_hints:
  - "Observed DataMarkdown persistence in cmd_work deep flow; v2 repo truth uses JSON. Replace/remove DataMarkdown codepaths and update docs/tests."
