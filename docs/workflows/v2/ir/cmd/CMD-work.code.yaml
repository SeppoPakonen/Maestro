id: "CMD-work"
layer: "code"
title: "work deep internal flow (observed)"
status: "partial"
confidence: "high"
storage_backend: "mixed"

calls:
  - maestro.main.main
  - maestro.commands.work.handle_work_any
  - maestro.commands.work.handle_work_any_pick
  - maestro.commands.work.handle_work_track
  - maestro.commands.work.handle_work_phase
  - maestro.commands.work.handle_work_issue
  - maestro.commands.work.handle_work_task
  - maestro.commands.work.handle_work_discuss
  - maestro.commands.work.handle_work_analyze
  - maestro.commands.work.handle_work_fix
  - maestro.commands.work.load_available_work
  - maestro.commands.work.ai_select_work_items
  - maestro.commands.work.simple_priority_sort
  - maestro.commands.work._run_ai_interaction_with_breadcrumb
  - maestro.commands.work._safe_generate
  - maestro.commands.work.load_issues
  - maestro.commands.work._load_task_entries
  - maestro.work_session.create_session
  - maestro.work_session.complete_session
  - maestro.work_session.save_session
  - maestro.work_session.is_breadcrumb_enabled
  - maestro.breadcrumb.create_breadcrumb
  - maestro.breadcrumb.write_breadcrumb
  - maestro.breadcrumb.estimate_tokens
  - maestro.breadcrumb.calculate_cost
  - maestro.ai.task_sync.build_task_prompt
  - maestro.ai.task_sync.build_task_queue
  - maestro.ai.task_sync.find_task_context
  - maestro.ai.task_sync.task_is_done
  - maestro.ai.task_sync.write_sync_state
  - maestro.engines.get_engine
  - maestro.data.parse_todo_md
  - maestro.data.parse_phase_md
  - maestro.commands.discuss.handle_track_discuss
  - maestro.commands.discuss.handle_phase_discuss
  - maestro.commands.discuss.handle_task_discuss
  - maestro.workers.track_worker.execute_track_work
  - maestro.workers.phase_worker.execute_phase_work
  - maestro.workers.issue_worker.execute_issue_work

stores:
  - docs/todo.md
  - docs/issues/*.md
  - docs/phases/*.md
  - docs/ai_sync.json
  - docs/sessions/*.json
  - docs/sessions/*/breadcrumbs.jsonl

nodes:
  - id: "main_entry"
    type: "function"
    module: "maestro/main.py"
    function: "main"
  - id: "handle_work_any"
    type: "function"
    module: "maestro/commands/work.py"
    function: "handle_work_any"
  - id: "handle_work_any_pick"
    type: "function"
    module: "maestro/commands/work.py"
    function: "handle_work_any_pick"
  - id: "handle_work_track"
    type: "function"
    module: "maestro/commands/work.py"
    function: "handle_work_track"
  - id: "handle_work_phase"
    type: "function"
    module: "maestro/commands/work.py"
    function: "handle_work_phase"
  - id: "handle_work_issue"
    type: "function"
    module: "maestro/commands/work.py"
    function: "handle_work_issue"
  - id: "handle_work_task"
    type: "function"
    module: "maestro/commands/work.py"
    function: "handle_work_task"
  - id: "handle_work_discuss"
    type: "function"
    module: "maestro/commands/work.py"
    function: "handle_work_discuss"
  - id: "handle_work_analyze"
    type: "function"
    module: "maestro/commands/work.py"
    function: "handle_work_analyze"
  - id: "handle_work_fix"
    type: "function"
    module: "maestro/commands/work.py"
    function: "handle_work_fix"
  - id: "load_available_work"
    type: "function"
    module: "maestro/commands/work.py"
    function: "load_available_work"
  - id: "ai_select_work_items"
    type: "function"
    module: "maestro/commands/work.py"
    function: "ai_select_work_items"
  - id: "simple_priority_sort"
    type: "function"
    module: "maestro/commands/work.py"
    function: "simple_priority_sort"
  - id: "_run_ai_interaction_with_breadcrumb"
    type: "function"
    module: "maestro/commands/work.py"
    function: "_run_ai_interaction_with_breadcrumb"
  - id: "_safe_generate"
    type: "function"
    module: "maestro/commands/work.py"
    function: "_safe_generate"
  - id: "load_issues"
    type: "function"
    module: "maestro/commands/work.py"
    function: "load_issues"
  - id: "_load_task_entries"
    type: "function"
    module: "maestro/commands/work.py"
    function: "_load_task_entries"
  - id: "work_session_class"
    type: "class"
    module: "maestro/work_session.py"
    class: "WorkSession"
  - id: "create_session"
    type: "function"
    module: "maestro/work_session.py"
    function: "create_session"
  - id: "complete_session"
    type: "function"
    module: "maestro/work_session.py"
    function: "complete_session"
  - id: "save_session"
    type: "function"
    module: "maestro/work_session.py"
    function: "save_session"
  - id: "is_breadcrumb_enabled"
    type: "function"
    module: "maestro/work_session.py"
    function: "is_breadcrumb_enabled"
  - id: "create_breadcrumb"
    type: "function"
    module: "maestro/breadcrumb.py"
    function: "create_breadcrumb"
  - id: "write_breadcrumb"
    type: "function"
    module: "maestro/breadcrumb.py"
    function: "write_breadcrumb"
  - id: "estimate_tokens"
    type: "function"
    module: "maestro/breadcrumb.py"
    function: "estimate_tokens"
  - id: "calculate_cost"
    type: "function"
    module: "maestro/breadcrumb.py"
    function: "calculate_cost"
  - id: "build_task_prompt"
    type: "function"
    module: "maestro/ai/task_sync.py"
    function: "build_task_prompt"
  - id: "build_task_queue"
    type: "function"
    module: "maestro/ai/task_sync.py"
    function: "build_task_queue"
  - id: "find_task_context"
    type: "function"
    module: "maestro/ai/task_sync.py"
    function: "find_task_context"
  - id: "task_is_done"
    type: "function"
    module: "maestro/ai/task_sync.py"
    function: "task_is_done"
  - id: "write_sync_state"
    type: "function"
    module: "maestro/ai/task_sync.py"
    function: "write_sync_state"
  - id: "get_engine"
    type: "function"
    module: "maestro/engines.py"
    function: "get_engine"
  - id: "parse_todo_md"
    type: "function"
    module: "maestro/data/markdown_parser.py"
    function: "parse_todo_md"
  - id: "parse_phase_md"
    type: "function"
    module: "maestro/data/markdown_parser.py"
    function: "parse_phase_md"
  - id: "handle_track_discuss"
    type: "function"
    module: "maestro/commands/discuss.py"
    function: "handle_track_discuss"
  - id: "handle_phase_discuss"
    type: "function"
    module: "maestro/commands/discuss.py"
    function: "handle_phase_discuss"
  - id: "handle_task_discuss"
    type: "function"
    module: "maestro/commands/discuss.py"
    function: "handle_task_discuss"
  - id: "execute_track_work"
    type: "function"
    module: "maestro/workers/track_worker.py"
    function: "execute_track_work"
  - id: "execute_phase_work"
    type: "function"
    module: "maestro/workers/phase_worker.py"
    function: "execute_phase_work"
  - id: "execute_issue_work"
    type: "function"
    module: "maestro/workers/issue_worker.py"
    function: "execute_issue_work"
  - id: "external_ai_service"
    type: "actor"
    label: "External AI Service"
  - id: "user_actor"
    type: "actor"
    label: "User (for interactive selection)"
  - id: "git_cli"
    type: "actor"
    label: "Git CLI (for analyze context)"
  - id: "file_system"
    type: "actor"
    label: "File System"
  - id: "docs_todo_md"
    type: "datastore"
    path: "docs/todo.md"
  - id: "docs_issues_md"
    type: "datastore"
    path: "docs/issues/*.md"
  - id: "docs_phases_md"
    type: "datastore"
    path: "docs/phases/*.md"
  - id: "docs_sessions_dir"
    type: "datastore"
    path: "docs/sessions/"
  - id: "docs_ai_sync_json"
    type: "datastore"
    path: "docs/ai_sync.json"

edges:
  - from: "main_entry"
    to: "handle_work_any"
  - from: "main_entry"
    to: "handle_work_any_pick"
  - from: "main_entry"
    to: "handle_work_track"
  - from: "main_entry"
    to: "handle_work_phase"
  - from: "main_entry"
    to: "handle_work_issue"
  - from: "main_entry"
    to: "handle_work_task"
  - from: "main_entry"
    to: "handle_work_discuss"
  - from: "main_entry"
    to: "handle_work_analyze"
  - from: "main_entry"
    to: "handle_work_fix"
  - from: "handle_work_any"
    to: "load_available_work"
  - from: "handle_work_any"
    to: "ai_select_work_items"
  - from: "handle_work_any"
    to: "create_session"
  - from: "handle_work_any"
    to: "execute_track_work"
  - from: "handle_work_any"
    to: "execute_phase_work"
  - from: "handle_work_any"
    to: "execute_issue_work"
  - from: "handle_work_any_pick"
    to: "load_available_work"
  - from: "handle_work_any_pick"
    to: "ai_select_work_items"
  - from: "handle_work_any_pick"
    to: "user_actor"
  - from: "handle_work_any_pick"
    to: "create_session"
  - from: "handle_work_any_pick"
    to: "execute_track_work"
  - from: "handle_work_any_pick"
    to: "execute_phase_work"
  - from: "handle_work_any_pick"
    to: "execute_issue_work"
  - from: "handle_work_track"
    to: "load_available_work"
  - from: "handle_work_track"
    to: "create_session"
  - from: "handle_work_track"
    to: "execute_track_work"
  - from: "handle_work_phase"
    to: "load_available_work"
  - from: "handle_work_phase"
    to: "create_session"
  - from: "handle_work_phase"
    to: "execute_phase_work"
  - from: "handle_work_issue"
    to: "load_available_work"
  - from: "handle_work_issue"
    to: "create_session"
  - from: "handle_work_issue"
    to: "execute_issue_work"
  - from: "handle_work_task"
    to: "_load_task_entries"
  - from: "handle_work_task"
    to: "find_task_context"
  - from: "handle_work_task"
    to: "build_task_queue"
  - from: "handle_work_task"
    to: "write_sync_state"
  - from: "handle_work_task"
    to: "create_session"
  - from: "handle_work_task"
    to: "_run_ai_interaction_with_breadcrumb"
  - from: "handle_work_discuss"
    to: "handle_track_discuss"
  - from: "handle_work_discuss"
    to: "handle_phase_discuss"
  - from: "handle_work_discuss"
    to: "handle_task_discuss"
  - from: "handle_work_analyze"
    to: "load_available_work"
  - from: "handle_work_analyze"
    to: "get_engine"
  - from: "handle_work_analyze"
    to: "_run_ai_interaction_with_breadcrumb"
  - from: "handle_work_fix"
    to: "load_available_work"
  - from: "handle_work_fix"
    to: "create_session"
  - from: "handle_work_fix"
    to: "_run_ai_interaction_with_breadcrumb"
  - from: "handle_work_fix"
    to: "get_engine"
  - from: "load_available_work"
    to: "docs_todo_md"
  - from: "load_available_work"
    to: "load_issues"
  - from: "load_issues"
    to: "docs_issues_md"
  - from: "_load_task_entries"
    to: "docs_phases_md"
  - from: "create_session"
    to: "docs_sessions_dir"
  - from: "_run_ai_interaction_with_breadcrumb"
    to: "_safe_generate"
  - from: "_run_ai_interaction_with_breadcrumb"
    to: "create_breadcrumb"
  - from: "_run_ai_interaction_with_breadcrumb"
    to: "write_breadcrumb"
  - from: "_run_ai_interaction_with_breadcrumb"
    to: "estimate_tokens"
  - from: "_run_ai_interaction_with_breadcrumb"
    to: "calculate_cost"
  - from: "_run_ai_interaction_with_breadcrumb"
    to: "docs_sessions_dir"
  - from: "ai_select_work_items"
    to: "get_engine"
  - from: "ai_select_work_items"
    to: "external_ai_service"
  - from: "ai_select_work_items"
    to: "simple_priority_sort"
  - from: "_safe_generate"
    to: "get_engine"
  - from: "_safe_generate"
    to: "external_ai_service"
  - from: "write_sync_state"
    to: "docs_ai_sync_json"

evidence:
  - "maestro/commands/work.py"
  - "maestro/work_session.py"
  - "maestro/breadcrumb.py"
  - "maestro/ai/task_sync.py"
  - "maestro/engines.py"
  - "maestro/data/markdown_parser.py"
  - "maestro/commands/discuss.py"
  - "maestro/workers/track_worker.py"
  - "maestro/workers/phase_worker.py"
  - "maestro/workers/issue_worker.py"

ledger_hints:
  - "Observed DataMarkdown persistence in cmd_work deep flow; v2 repo truth uses JSON. Replace/remove DataMarkdown codepaths and update docs/tests."
