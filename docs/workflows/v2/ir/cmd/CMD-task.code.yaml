id: "CMD-task"
layer: "code"
title: "task deep internal flow (observed)"
status: "partial"
confidence: "high"
storage_backend: "mixed"

calls:
  - "maestro.commands.task.handle_task_command"
  - "maestro.commands.task.list_tasks"
  - "maestro.commands.task.show_task"
  - "maestro.commands.task.add_task"
  - "maestro.commands.task.remove_task"
  - "maestro.commands.task.edit_task"
  - "maestro.commands.task.set_task_status"
  - "maestro.commands.task.set_task_context"
  - "maestro.commands.discuss.handle_task_discuss"
  - "maestro.tracks.json_store.JsonStore"
  - "maestro.data.markdown_parser"
  - "maestro.data.markdown_writer"
  - "maestro.display.table_renderer.render_task_table"

stores:
  - "docs/phases/<phase_id>.md"
  - ".maestro/tracks/tasks/<task_id>.json"
  - ".maestro/tracks/phases/<phase_id>.json"
  - "settings.json"

nodes:
  - id: "handle_task_command"
    type: "function"
    module: "maestro.commands.task"
  - id: "list_tasks"
    type: "function"
    module: "maestro.commands.task"
  - id: "show_task"
    type: "function"
    module: "maestro.commands.task"
  - id: "add_task"
    type: "function"
    module: "maestro.commands.task"
  - id: "remove_task"
    type: "function"
    module: "maestro.commands.task"
  - id: "edit_task"
    type: "function"
    module: "maestro.commands.task"
  - id: "set_task_status"
    type: "function"
    module: "maestro.commands.task"
  - id: "set_task_context"
    type: "function"
    module: "maestro.commands.task"
  - id: "handle_task_discuss"
    type: "function"
    module: "maestro.commands.discuss"
  - id: "JsonStore"
    type: "class"
    module: "maestro.tracks.json_store"
  - id: "Task"
    type: "class"
    module: "maestro.tracks.models"
  - id: "Phase"
    type: "class"
    module: "maestro.tracks.models"
  - id: "Track"
    type: "class"
    module: "maestro.tracks.models"
  - id: "parse_todo_md"
    type: "function"
    module: "maestro.data.markdown_parser"
  - id: "parse_done_md"
    type: "function"
    module: "maestro.data.markdown_parser"
  - id: "parse_phase_md"
    type: "function"
    module: "maestro.data.markdown_parser"
  - id: "extract_task_block"
    type: "function"
    module: "maestro.data.markdown_writer"
  - id: "replace_task_block"
    type: "function"
    module: "maestro.data.markdown_writer"
  - id: "render_task_table"
    type: "function"
    module: "maestro.display.table_renderer"
  - id: "docs_phases_md"
    type: "datastore"
    path: "docs/phases/<phase_id>.md"
  - id: "maestro_tasks_json"
    type: "datastore"
    path: ".maestro/tracks/tasks/<task_id>.json"
  - id: "maestro_phases_json"
    type: "datastore"
    path: ".maestro/tracks/phases/<phase_id>.json"
  - id: "settings_json"
    type: "datastore"
    path: "settings.json"
  - id: "user_editor"
    type: "actor"
    description: "User's $EDITOR"

edges:
  - from: "handle_task_command"
    to: "list_tasks"
  - from: "handle_task_command"
    to: "show_task"
  - from: "handle_task_command"
    to: "add_task"
  - from: "handle_task_command"
    to: "remove_task"
  - from: "handle_task_command"
    to: "edit_task"
  - from: "handle_task_command"
    to: "set_task_status"
  - from: "handle_task_command"
    to: "set_task_context"
  - from: "handle_task_command"
    to: "handle_task_discuss"
  - from: "list_tasks"
    to: "render_task_table"
  - from: "add_task"
    to: "JsonStore"
  - from: "add_task"
    to: "Task"
  - from: "remove_task"
    to: "JsonStore"
  - from: "edit_task"
    to: "extract_task_block"
  - from: "edit_task"
    to: "replace_task_block"
  - from: "edit_task"
    to: "user_editor"
  - from: "set_task_status"
    to: "JsonStore"
  - from: "set_task_context"
    to: "settings_json"
  - from: "JsonStore"
    to: "maestro_tasks_json"
  - from: "JsonStore"
    to: "maestro_phases_json"
  - from: "extract_task_block"
    to: "docs_phases_md"
  - from: "replace_task_block"
    to: "docs_phases_md"

evidence:
  - "maestro/commands/task.py"
  - "maestro/data/markdown_parser.py"
  - "maestro/data/markdown_writer.py"
  - "maestro/tracks/json_store.py"
  - "maestro/tracks/models.py"
  - "maestro/display/table_renderer.py"
  - "maestro/config/settings.py"
  - "maestro/commands/discuss.py"

ledger_hints:
  - "Observed DataMarkdown persistence in cmd_task deep flow; v2 repo truth uses JSON. Replace/remove DataMarkdown codepaths and update docs/tests."
  - "Mentions .maestro directory usage which contradicts FORBID_REPO_DOT_MAESTRO invariant - needs migration to ./docs/maestro/"
  - "Shows mixed markdown/JSON persistence model which contradicts REPO_TRUTH_FORMAT_IS_JSON invariant"
