id: "CMD-discuss"
layer: "code"
title: "discuss deep internal flow (observed)"
status: "partial"
confidence: "high"
storage_backend: "markdown"

calls:
  - "maestro.main.main"
  - "maestro.commands.discuss.handle_discuss_command"
  - "maestro.commands.discuss.handle_track_discuss"
  - "maestro.commands.discuss.handle_phase_discuss"
  - "maestro.commands.discuss.handle_task_discuss"
  - "maestro.commands.discuss.choose_mode"
  - "maestro.commands.discuss.run_discussion_with_router"
  - "maestro.commands.discuss.apply_patch_operations"
  - "maestro.commands.discuss.save_discussion_artifacts"
  - "maestro.commands.discuss.update_artifact_status"
  - "maestro.ai.manager.AiEngineManager"
  - "maestro.ai.discussion_router.DiscussionRouter"
  - "maestro.ai.discussion_router.run_discussion"
  - "maestro.ai.contracts.JsonContract"
  - "maestro.ai.contracts.TrackContract"
  - "maestro.ai.contracts.PhaseContract"
  - "maestro.ai.contracts.TaskContract"
  - "maestro.ai.contracts.GlobalContract"
  - "maestro.ai.actions.ActionProcessor"
  - "maestro.ai.actions.PatchOperation"
  - "maestro.data.markdown_parser.parse_config_md"
  - "maestro.data.markdown_writer.insert_track_block"
  - "maestro.data.markdown_writer.insert_phase_block"
  - "maestro.data.markdown_writer.insert_task_block"
  - "maestro.data.markdown_writer.update_track_metadata"
  - "maestro.data.markdown_writer.update_phase_metadata"
  - "maestro.data.markdown_writer.update_task_metadata"
  - "maestro.discussion.DiscussionSession"
  - "maestro.discussion.create_discussion_session"
  - "maestro.work_session.create_session"
  - "maestro.breadcrumb.get_breadcrumb_summary"

stores:
  - "docs/config.md"
  - "docs/todo.md"
  - "docs/phases/*.md"
  - ".maestro/ai/artifacts/*"
  - "docs/state/work_sessions.json"

nodes:
  - id: "main_entry"
    type: "function"
    module: "maestro.main"
    function: "main"
  - id: "handle_discuss_command"
    type: "function"
    module: "maestro.commands.discuss"
    function: "handle_discuss_command"
  - id: "handle_track_discuss"
    type: "function"
    module: "maestro.commands.discuss"
    function: "handle_track_discuss"
  - id: "handle_phase_discuss"
    type: "function"
    module: "maestro.commands.discuss"
    function: "handle_phase_discuss"
  - id: "handle_task_discuss"
    type: "function"
    module: "maestro.commands.discuss"
    function: "handle_task_discuss"
  - id: "choose_mode"
    type: "function"
    module: "maestro.commands.discuss"
    function: "choose_mode"
  - id: "run_discussion_with_router"
    type: "function"
    module: "maestro.commands.discuss"
    function: "run_discussion_with_router"
  - id: "apply_patch_operations"
    type: "function"
    module: "maestro.commands.discuss"
    function: "apply_patch_operations"
  - id: "save_discussion_artifacts"
    type: "function"
    module: "maestro.commands.discuss"
    function: "save_discussion_artifacts"
  - id: "update_artifact_status"
    type: "function"
    module: "maestro.commands.discuss"
    function: "update_artifact_status"
  - id: "ai_engine_manager"
    type: "class"
    module: "maestro.ai.manager"
    class: "AiEngineManager"
  - id: "discussion_router"
    type: "class"
    module: "maestro.ai.discussion_router"
    class: "DiscussionRouter"
  - id: "run_discussion"
    type: "function"
    module: "maestro.ai.discussion_router"
    function: "run_discussion"
  - id: "json_contract"
    type: "class"
    module: "maestro.ai.contracts"
    class: "JsonContract"
  - id: "track_contract"
    type: "class"
    module: "maestro.ai.contracts"
    class: "TrackContract"
  - id: "phase_contract"
    type: "class"
    module: "maestro.ai.contracts"
    class: "PhaseContract"
  - id: "task_contract"
    type: "class"
    module: "maestro.ai.contracts"
    class: "TaskContract"
  - id: "global_contract"
    type: "class"
    module: "maestro.ai.contracts"
    class: "GlobalContract"
  - id: "action_processor"
    type: "class"
    module: "maestro.ai.actions"
    class: "ActionProcessor"
  - id: "patch_operation"
    type: "class"
    module: "maestro.ai.actions"
    class: "PatchOperation"
  - id: "parse_config_md"
    type: "function"
    module: "maestro.data.markdown_parser"
    function: "parse_config_md"
  - id: "insert_track_block"
    type: "function"
    module: "maestro.data.markdown_writer"
    function: "insert_track_block"
  - id: "insert_phase_block"
    type: "function"
    module: "maestro.data.markdown_writer"
    function: "insert_phase_block"
  - id: "insert_task_block"
    type: "function"
    module: "maestro.data.markdown_writer"
    function: "insert_task_block"
  - id: "update_track_metadata"
    type: "function"
    module: "maestro.data.markdown_writer"
    function: "update_track_metadata"
  - id: "update_phase_metadata"
    type: "function"
    module: "maestro.data.markdown_writer"
    function: "update_phase_metadata"
  - id: "update_task_metadata"
    type: "function"
    module: "maestro.data.markdown_writer"
    function: "update_task_metadata"
  - id: "discussion_session"
    type: "class"
    module: "maestro.discussion"
    class: "DiscussionSession"
  - id: "create_discussion_session"
    type: "function"
    module: "maestro.discussion"
    function: "create_discussion_session"
  - id: "create_session"
    type: "function"
    module: "maestro.work_session"
    function: "create_session"
  - id: "get_breadcrumb_summary"
    type: "function"
    module: "maestro.breadcrumb"
    function: "get_breadcrumb_summary"
  - id: "docs_config_md"
    type: "datastore"
    path: "docs/config.md"
  - id: "docs_todo_md"
    type: "datastore"
    path: "docs/todo.md"
  - id: "docs_phases_md"
    type: "datastore"
    path: "docs/phases/*.md"
  - id: "maestro_ai_artifacts"
    type: "datastore"
    path: ".maestro/ai/artifacts/*"
  - id: "work_sessions_json"
    type: "datastore"
    path: "docs/state/work_sessions.json"

edges:
  - from: "main_entry"
    to: "handle_discuss_command"
  - from: "handle_discuss_command"
    to: "choose_mode"
  - from: "handle_discuss_command"
    to: "run_discussion_with_router"
  - from: "handle_discuss_command"
    to: "apply_patch_operations"
  - from: "choose_mode"
    to: "parse_config_md"
  - from: "run_discussion_with_router"
    to: "ai_engine_manager"
  - from: "run_discussion_with_router"
    to: "discussion_router"
  - from: "run_discussion_with_router"
    to: "json_contract"
  - from: "run_discussion_with_router"
    to: "run_discussion"
  - from: "run_discussion_with_router"
    to: "save_discussion_artifacts"
  - from: "run_discussion_with_router"
    to: "update_artifact_status"
  - from: "run_discussion"
    to: "ai_engine_manager"
  - from: "run_discussion"
    to: "json_contract"
  - from: "run_discussion"
    to: "patch_operation"
  - from: "apply_patch_operations"
    to: "insert_track_block"
  - from: "apply_patch_operations"
    to: "insert_phase_block"
  - from: "apply_patch_operations"
    to: "insert_task_block"
  - from: "apply_patch_operations"
    to: "update_track_metadata"
  - from: "apply_patch_operations"
    to: "update_phase_metadata"
  - from: "apply_patch_operations"
    to: "update_task_metadata"
  - from: "save_discussion_artifacts"
    to: "maestro_ai_artifacts"
  - from: "update_artifact_status"
    to: "maestro_ai_artifacts"
  - from: "insert_track_block"
    to: "docs_todo_md"
  - from: "insert_phase_block"
    to: "docs_todo_md"
  - from: "insert_task_block"
    to: "docs_phases_md"
  - from: "update_track_metadata"
    to: "docs_todo_md"
  - from: "update_phase_metadata"
    to: "docs_todo_md"
  - from: "update_task_metadata"
    to: "docs_phases_md"
  - from: "create_discussion_session"
    to: "discussion_session"
  - from: "discussion_session"
    to: "create_session"
  - from: "discussion_session"
    to: "get_breadcrumb_summary"
  - from: "create_session"
    to: "work_sessions_json"

evidence:
  - "v1/internal/deep/cmd_discuss_deep.puml"
  - "maestro/commands/discuss.py"
  - "maestro/ai/discussion_router.py"
  - "maestro/data/markdown_writer.py"

ledger_hints:
  - "Observed DataMarkdown persistence in cmd_discuss deep flow; v2 repo truth uses JSON. Replace/remove DataMarkdown codepaths and update docs/tests."
