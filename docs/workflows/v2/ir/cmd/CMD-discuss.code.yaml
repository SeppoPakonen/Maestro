id: "CMD-discuss"
layer: "code"
title: "discuss deep internal flow (observed)"
status: "partial"
confidence: "high"
storage_backend: "markdown"

calls:
  - maestro.main.main
  - maestro.commands.discuss.handle_discuss_command
  - maestro.commands.discuss.handle_track_discuss
  - maestro.commands.discuss.handle_phase_discuss
  - maestro.commands.discuss.handle_task_discuss
  - maestro.commands.discuss.choose_mode
  - maestro.commands.discuss.run_discussion_with_router
  - maestro.commands.discuss.apply_patch_operations
  - maestro.commands.discuss.save_discussion_artifacts
  - maestro.commands.discuss.update_artifact_status
  - maestro.ai.manager.AiEngineManager
  - maestro.ai.discussion_router.DiscussionRouter
  - maestro.ai.discussion_router.run_discussion
  - maestro.data.parse_config_md
  - maestro.data.markdown_writer.insert_track_block
  - maestro.data.markdown_writer.insert_phase_block
  - maestro.data.markdown_writer.insert_task_block
  - maestro.data.markdown_writer.update_track_metadata
  - maestro.data.markdown_writer.update_phase_metadata
  - maestro.data.markdown_writer.update_task_metadata

stores:
  - docs/config.md
  - docs/todo.md
  - docs/phases/*.md
  - .maestro/ai/artifacts/
  - docs/state/work_sessions.json

nodes:
  - id: "main_entry"
    type: "function"
    module: "maestro/main.py"
    function: "main"
  - id: "handle_discuss_command"
    type: "function"
    module: "maestro/commands/discuss.py"
    function: "handle_discuss_command"
  - id: "choose_mode"
    type: "function"
    module: "maestro/commands/discuss.py"
    function: "choose_mode"
  - id: "run_discussion_with_router"
    type: "function"
    module: "maestro/commands/discuss.py"
    function: "run_discussion_with_router"
  - id: "ai_engine_manager"
    type: "class"
    module: "maestro/ai/manager.py"
    class: "AiEngineManager"
  - id: "discussion_router"
    type: "class"
    module: "maestro/ai/discussion_router.py"
    class: "DiscussionRouter"
  - id: "run_discussion"
    type: "function"
    module: "maestro/ai/discussion_router.py"
    function: "run_discussion"
  - id: "apply_patch_operations"
    type: "function"
    module: "maestro/commands/discuss.py"
    function: "apply_patch_operations"
  - id: "parse_config_md"
    type: "function"
    module: "maestro/data/markdown_parser.py"
    function: "parse_config_md"
  - id: "insert_track_block"
    type: "function"
    module: "maestro/data/markdown_writer.py"
    function: "insert_track_block"
  - id: "insert_phase_block"
    type: "function"
    module: "maestro/data/markdown_writer.py"
    function: "insert_phase_block"
  - id: "insert_task_block"
    type: "function"
    module: "maestro/data/markdown_writer.py"
    function: "insert_task_block"
  - id: "update_track_metadata"
    type: "function"
    module: "maestro/data/markdown_writer.py"
    function: "update_track_metadata"
  - id: "update_phase_metadata"
    type: "function"
    module: "maestro/data/markdown_writer.py"
    function: "update_phase_metadata"
  - id: "update_task_metadata"
    type: "function"
    module: "maestro/data/markdown_writer.py"
    function: "update_task_metadata"
  - id: "docs_config_md"
    type: "datastore"
    path: "docs/config.md"
  - id: "docs_todo_md"
    type: "datastore"
    path: "docs/todo.md"
  - id: "docs_phases_md"
    type: "datastore"
    path: "docs/phases/*.md"
  - id: "maestro_ai_artifacts"
    type: "datastore"
    path: ".maestro/ai/artifacts/"
  - id: "work_sessions_json"
    type: "datastore"
    path: "docs/state/work_sessions.json"

edges:
  - from: "main_entry"
    to: "handle_discuss_command"
  - from: "handle_discuss_command"
    to: "choose_mode"
  - from: "handle_discuss_command"
    to: "run_discussion_with_router"
  - from: "choose_mode"
    to: "parse_config_md"
  - from: "run_discussion_with_router"
    to: "ai_engine_manager"
  - from: "run_discussion_with_router"
    to: "discussion_router"
  - from: "discussion_router"
    to: "run_discussion"
  - from: "run_discussion_with_router"
    to: "apply_patch_operations"
  - from: "apply_patch_operations"
    to: "insert_track_block"
  - from: "apply_patch_operations"
    to: "insert_phase_block"
  - from: "apply_patch_operations"
    to: "insert_task_block"
  - from: "apply_patch_operations"
    to: "update_track_metadata"
  - from: "apply_patch_operations"
    to: "update_phase_metadata"
  - from: "apply_patch_operations"
    to: "update_task_metadata"
  - from: "insert_track_block"
    to: "docs_todo_md"
  - from: "insert_phase_block"
    to: "docs_todo_md"
  - from: "insert_task_block"
    to: "docs_phases_md"
  - from: "update_track_metadata"
    to: "docs_todo_md"
  - from: "update_phase_metadata"
    to: "docs_todo_md"
  - from: "update_task_metadata"
    to: "docs_phases_md"
  - from: "run_discussion_with_router"
    to: "maestro_ai_artifacts"
  - from: "apply_patch_operations"
    to: "work_sessions_json"

evidence:
  - "maestro/commands/discuss.py"
  - "maestro/ai/discussion_router.py"
  - "maestro/data/markdown_writer.py"
  - "maestro/data/markdown_parser.py"

ledger_hints:
  - "Observed DataMarkdown persistence in cmd_discuss deep flow; v2 repo truth uses JSON. Replace/remove DataMarkdown codepaths and update docs/tests."
