id: "CMD-repo"
layer: "code"
title: "repo deep internal flow (observed)"
status: "partial"
confidence: "high"
storage_backend: "json"

calls:
  - maestro.commands.repo.handle_repo_command
  - maestro.commands.repo.find_repo_root
  - maestro.repo.scanner.scan_upp_repo_v2
  - maestro.commands.repo.write_repo_artifacts
  - maestro.commands.repo.load_repo_index
  - maestro.commands.repo.build_repo_hierarchy
  - maestro.commands.repo.save_hierarchy
  - maestro.commands.repo.load_hierarchy
  - maestro.commands.repo.load_hierarchy_overrides
  - maestro.commands.repo.merge_hierarchy_overrides
  - maestro.commands.repo.print_hierarchy_tree
  - maestro.commands.repo.handle_repo_pkg_list
  - maestro.commands.repo.handle_repo_pkg_info
  - maestro.commands.repo.handle_repo_pkg_files
  - maestro.commands.repo.handle_repo_pkg_groups
  - maestro.commands.repo.handle_repo_pkg_search
  - maestro.commands.repo.handle_repo_pkg_tree
  - maestro.commands.repo.handle_repo_pkg_conf
  - maestro.commands.repo.handle_repo_refresh_all
  - maestro.commands.repo.handle_repo_hier_edit
  - maestro.commands.repo.handle_repo_hier
  - maestro.commands.repo.handle_repo_conventions_detect
  - maestro.commands.repo.handle_repo_conventions_show
  - maestro.commands.repo.handle_repo_rules_show
  - maestro.commands.repo.handle_repo_rules_edit
  - maestro.commands.repo.handle_repo_rules_inject
  - maestro.repo.build_config.get_package_config
  - maestro.repo.upp_conditions.match_when
  - maestro.global_index.update_global_repo_index

stores:
  - .maestro/repo/
  - docs/RepoRules.md
  - $HOME/.maestro/repos.json

nodes:
  - id: "main_entry"
    type: "function"
    module: "maestro/main.py"
    function: "main()"
  - id: "handle_repo_command"
    type: "function"
    module: "maestro/commands/repo.py"
    function: "handle_repo_command"
  - id: "find_repo_root"
    type: "function"
    module: "maestro/commands/repo.py"
    function: "find_repo_root"
  - id: "scan_upp_repo_v2"
    type: "function"
    module: "maestro/repo/scanner.py"
    function: "scan_upp_repo_v2"
  - id: "write_repo_artifacts"
    type: "function"
    module: "maestro/commands/repo.py"
    function: "write_repo_artifacts"
  - id: "load_repo_index"
    type: "function"
    module: "maestro/commands/repo.py"
    function: "load_repo_index"
  - id: "build_repo_hierarchy"
    type: "function"
    module: "maestro/commands/repo.py"
    function: "build_repo_hierarchy"
  - id: "save_hierarchy"
    type: "function"
    module: "maestro/commands/repo.py"
    function: "save_hierarchy"
  - id: "load_hierarchy"
    type: "function"
    module: "maestro/commands/repo.py"
    function: "load_hierarchy"
  - id: "load_hierarchy_overrides"
    type: "function"
    module: "maestro/commands/repo.py"
    function: "load_hierarchy_overrides"
  - id: "merge_hierarchy_overrides"
    type: "function"
    module: "maestro/commands/repo.py"
    function: "merge_hierarchy_overrides"
  - id: "print_hierarchy_tree"
    type: "function"
    module: "maestro/commands/repo.py"
    function: "print_hierarchy_tree"
  - id: "handle_repo_pkg_list"
    type: "function"
    module: "maestro/commands/repo.py"
    function: "handle_repo_pkg_list"
  - id: "handle_repo_pkg_info"
    type: "function"
    module: "maestro/commands/repo.py"
    function: "handle_repo_pkg_info"
  - id: "handle_repo_pkg_files"
    type: "function"
    module: "maestro/commands/repo.py"
    function: "handle_repo_pkg_files"
  - id: "handle_repo_pkg_groups"
    type: "function"
    module: "maestro/commands/repo.py"
    function: "handle_repo_pkg_groups"
  - id: "handle_repo_pkg_search"
    type: "function"
    module: "maestro/commands/repo.py"
    function: "handle_repo_pkg_search"
  - id: "handle_repo_pkg_tree"
    type: "function"
    module: "maestro/commands/repo.py"
    function: "handle_repo_pkg_tree"
  - id: "handle_repo_pkg_conf"
    type: "function"
    module: "maestro/commands/repo.py"
    function: "handle_repo_pkg_conf"
  - id: "handle_repo_refresh_all"
    type: "function"
    module: "maestro/commands/repo.py"
    function: "handle_repo_refresh_all"
  - id: "handle_repo_hier_edit"
    type: "function"
    module: "maestro/commands/repo.py"
    function: "handle_repo_hier_edit"
  - id: "handle_repo_hier"
    type: "function"
    module: "maestro/commands/repo.py"
    function: "handle_repo_hier"
  - id: "handle_repo_conventions_detect"
    type: "function"
    module: "maestro/commands/repo.py"
    function: "handle_repo_conventions_detect"
  - id: "handle_repo_conventions_show"
    type: "function"
    module: "maestro/commands/repo.py"
    function: "handle_repo_conventions_show"
  - id: "handle_repo_rules_show"
    type: "function"
    module: "maestro/commands/repo.py"
    function: "handle_repo_rules_show"
  - id: "handle_repo_rules_edit"
    type: "function"
    module: "maestro/commands/repo.py"
    function: "handle_repo_rules_edit"
  - id: "handle_repo_rules_inject"
    type: "function"
    module: "maestro/commands/repo.py"
    function: "handle_repo_rules_inject"
  - id: "get_package_config"
    type: "function"
    module: "maestro/repo/build_config.py"
    function: "get_package_config"
  - id: "match_when"
    type: "function"
    module: "maestro/repo/upp_conditions.py"
    function: "match_when"
  - id: "update_global_repo_index"
    type: "function"
    module: "maestro/global_index.py"
    function: "update_global_repo_index"
  - id: "repo_scan_result_class"
    type: "class"
    module: "maestro/repo/scanner.py"
    class: "RepoScanResult"
  - id: "package_info_class"
    type: "class"
    module: "maestro/repo/package.py"
    class: "PackageInfo"
  - id: "file_group_class"
    type: "class"
    module: "maestro/repo/package.py"
    class: "FileGroup"
  - id: "maestro_repo_dir"
    type: "datastore"
    path: ".maestro/repo/"
  - id: "docs_repo_rules_md"
    type: "datastore"
    path: "docs/RepoRules.md"
  - id: "global_index_file"
    type: "datastore"
    path: "$HOME/.maestro/repos.json"
  - id: "file_system"
    type: "actor"
    description: "File system operations"
  - id: "subprocess"
    type: "actor"
    description: "External process execution"
  - id: "editor"
    type: "actor"
    description: "User's $EDITOR"

edges:
  - from: "main_entry"
    to: "handle_repo_command"
    type: "call"
  - from: "handle_repo_command"
    to: "find_repo_root"
    type: "call"
  - from: "handle_repo_command"
    to: "scan_upp_repo_v2"
    type: "call"
  - from: "scan_upp_repo_v2"
    to: "repo_scan_result_class"
    type: "call"
  - from: "handle_repo_command"
    to: "write_repo_artifacts"
    type: "call"
  - from: "write_repo_artifacts"
    to: "maestro_repo_dir"
    type: "call"
  - from: "handle_repo_refresh_all"
    to: "update_global_repo_index"
    type: "call"
  - from: "update_global_repo_index"
    to: "global_index_file"
    type: "call"
  - from: "handle_repo_command"
    to: "load_repo_index"
    type: "call"
  - from: "load_repo_index"
    to: "maestro_repo_dir"
    type: "call"
  - from: "load_repo_index"
    to: "repo_scan_result_class"
    type: "call"
  - from: "handle_repo_command"
    to: "handle_repo_pkg_list"
    type: "call"
  - from: "handle_repo_command"
    to: "handle_repo_pkg_info"
    type: "call"
  - from: "handle_repo_command"
    to: "handle_repo_pkg_files"
    type: "call"
  - from: "handle_repo_command"
    to: "handle_repo_pkg_groups"
    type: "call"
  - from: "handle_repo_command"
    to: "handle_repo_pkg_search"
    type: "call"
  - from: "handle_repo_command"
    to: "handle_repo_pkg_tree"
    type: "call"
  - from: "handle_repo_pkg_tree"
    to: "match_when"
    type: "call"
  - from: "handle_repo_command"
    to: "handle_repo_pkg_conf"
    type: "call"
  - from: "handle_repo_pkg_conf"
    to: "get_package_config"
    type: "call"
  - from: "handle_repo_command"
    to: "load_hierarchy"
    type: "call"
  - from: "handle_repo_command"
    to: "build_repo_hierarchy"
    type: "call"
  - from: "build_repo_hierarchy"
    to: "repo_scan_result_class"
    type: "call"
  - from: "build_repo_hierarchy"
    to: "package_info_class"
    type: "call"
  - from: "build_repo_hierarchy"
    to: "file_group_class"
    type: "call"
  - from: "handle_repo_command"
    to: "save_hierarchy"
    type: "call"
  - from: "save_hierarchy"
    to: "maestro_repo_dir"
    type: "call"
  - from: "handle_repo_command"
    to: "load_hierarchy_overrides"
    type: "call"
  - from: "load_hierarchy_overrides"
    to: "maestro_repo_dir"
    type: "call"
  - from: "handle_repo_command"
    to: "merge_hierarchy_overrides"
    type: "call"
  - from: "handle_repo_command"
    to: "print_hierarchy_tree"
    type: "call"
  - from: "handle_repo_command"
    to: "handle_repo_hier_edit"
    type: "call"
  - from: "handle_repo_hier_edit"
    to: "maestro_repo_dir"
    type: "call"
  - from: "handle_repo_hier_edit"
    to: "subprocess"
    type: "call"
  - from: "editor"
    to: "handle_repo_hier_edit"
    type: "call"
  - from: "handle_repo_command"
    to: "handle_repo_rules_show"
    type: "call"
  - from: "handle_repo_command"
    to: "handle_repo_rules_edit"
    type: "call"
  - from: "handle_repo_command"
    to: "handle_repo_rules_inject"
    type: "call"
  - from: "handle_repo_command"
    to: "handle_repo_conventions_show"
    type: "call"
  - from: "handle_repo_command"
    to: "handle_repo_conventions_detect"
    type: "call"
  - from: "handle_repo_rules_show"
    to: "docs_repo_rules_md"
    type: "call"
  - from: "handle_repo_rules_edit"
    to: "subprocess"
    type: "call"
  - from: "editor"
    to: "handle_repo_rules_edit"
    type: "call"
  - from: "handle_repo_rules_edit"
    to: "docs_repo_rules_md"
    type: "call"
  - from: "write_repo_artifacts"
    to: "subprocess"
    type: "call"
  - from: "write_repo_artifacts"
    to: "file_system"
    type: "call"

evidence:
  - /home/sblo/Dev/Maestro/maestro/commands/repo.py
  - /home/sblo/Dev/Maestro/maestro/repo/scanner.py
  - /home/sblo/Dev/Maestro/maestro/repo/package.py
  - /home/sblo/Dev/Maestro/maestro/repo/build_config.py
  - /home/sblo/Dev/Maestro/maestro/repo/upp_conditions.py
  - /home/sblo/Dev/Maestro/maestro/global_index.py
  - /home/sblo/Dev/Maestro/maestro/modules/utils.py
  - /home/sblo/Dev/Maestro/docs/RepoRules.md

ledger_hints:
  - "Observed .maestro directory usage in cmd_repo deep flow; violates FORBID_REPO_DOT_MAESTRO invariant; migrate to ./docs/maestro/"
  - "Observed JSON persistence in cmd_repo deep flow; confirms REPO_TRUTH_FORMAT_IS_JSON invariant"
