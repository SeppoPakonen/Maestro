id: "CMD-repo"
layer: "code"
title: "repo deep internal flow (observed)"
status: "partial"
confidence: "high"
storage_backend: "json"

calls:
  - "maestro.commands.repo.handle_repo_command"
  - "maestro.repo.scanner.scan_upp_repo_v2"
  - "maestro.commands.repo.write_repo_artifacts"
  - "maestro.commands.repo.load_repo_index"
  - "maestro.commands.repo.find_repo_root"
  - "maestro.global_index.update_global_repo_index"
  - "maestro.commands.repo.build_repo_hierarchy"
  - "maestro.commands.repo.load_hierarchy"
  - "maestro.commands.repo.load_hierarchy_overrides"
  - "maestro.commands.repo.merge_hierarchy_overrides"
  - "maestro.commands.repo.handle_repo_pkg_*"
  - "maestro.commands.repo.handle_repo_hier_*"
  - "maestro.commands.repo.handle_repo_rules_*"
  - "maestro.commands.repo.handle_repo_conventions_*"

stores:
  - ".maestro/repo/"
  - "docs/RepoRules.md"
  - "$HOME/.maestro/repos.json"

nodes:
  - id: "handle_repo_command"
    type: "function"
    module: "maestro.commands.repo"
    label: "Main command handler"
  - id: "scan_upp_repo_v2"
    type: "function"
    module: "maestro.repo.scanner"
    label: "Repository scanner"
  - id: "write_repo_artifacts"
    type: "function"
    module: "maestro.commands.repo"
    label: "Write scan results"
  - id: "load_repo_index"
    type: "function"
    module: "maestro.commands.repo"
    label: "Load repo index"
  - id: "find_repo_root"
    type: "function"
    module: "maestro.commands.repo"
    label: "Find repo root"
  - id: "update_global_repo_index"
    type: "function"
    module: "maestro.global_index"
    label: "Update global index"
  - id: "build_repo_hierarchy"
    type: "function"
    module: "maestro.commands.repo"
    label: "Build hierarchy"
  - id: "load_hierarchy"
    type: "function"
    module: "maestro.commands.repo"
    label: "Load hierarchy"
  - id: "load_hierarchy_overrides"
    type: "function"
    module: "maestro.commands.repo"
    label: "Load hierarchy overrides"
  - id: "merge_hierarchy_overrides"
    type: "function"
    module: "maestro.commands.repo"
    label: "Merge hierarchy overrides"
  - id: "handle_repo_pkg_*"
    type: "function"
    module: "maestro.commands.repo"
    label: "Package subcommands"
  - id: "handle_repo_hier_*"
    type: "function"
    module: "maestro.commands.repo"
    label: "Hierarchy subcommands"
  - id: "handle_repo_rules_*"
    type: "function"
    module: "maestro.commands.repo"
    label: "Rules subcommands"
  - id: "handle_repo_conventions_*"
    type: "function"
    module: "maestro.commands.repo"
    label: "Conventions subcommands"
  - id: "maestro_repo_store"
    type: "datastore"
    label: ".maestro/repo/ store"
  - id: "repo_rules_store"
    type: "datastore"
    label: "Repo rules store"
  - id: "global_index_store"
    type: "datastore"
    label: "Global index store"
  - id: "filesystem"
    type: "actor"
    label: "File system"
  - id: "editor"
    type: "actor"
    label: "External editor"

edges:
  - from: "handle_repo_command"
    to: "find_repo_root"
    type: "call"
  - from: "handle_repo_command"
    to: "scan_upp_repo_v2"
    type: "call"
  - from: "scan_upp_repo_v2"
    to: "write_repo_artifacts"
    type: "call"
  - from: "write_repo_artifacts"
    to: "maestro_repo_store"
    type: "data"
  - from: "handle_repo_command"
    to: "load_repo_index"
    type: "call"
  - from: "load_repo_index"
    to: "maestro_repo_store"
    type: "data"
  - from: "handle_repo_refresh_all"
    to: "update_global_repo_index"
    type: "call"
  - from: "update_global_repo_index"
    to: "global_index_store"
    type: "data"
  - from: "handle_repo_command"
    to: "build_repo_hierarchy"
    type: "call"
  - from: "build_repo_hierarchy"
    to: "load_hierarchy"
    type: "call"
  - from: "handle_repo_command"
    to: "load_hierarchy_overrides"
    type: "call"
  - from: "load_hierarchy_overrides"
    to: "maestro_repo_store"
    type: "data"
  - from: "handle_repo_command"
    to: "merge_hierarchy_overrides"
    type: "call"
  - from: "handle_repo_command"
    to: "handle_repo_pkg_*"
    type: "call"
  - from: "handle_repo_command"
    to: "handle_repo_hier_*"
    type: "call"
  - from: "handle_repo_command"
    to: "handle_repo_rules_*"
    type: "call"
  - from: "handle_repo_command"
    to: "handle_repo_conventions_*"
    type: "call"
  - from: "handle_repo_rules_*"
    to: "repo_rules_store"
    type: "data"
  - from: "handle_repo_hier_*"
    to: "editor"
    type: "call"

evidence:
  - "v1/internal/deep/cmd_repo_deep.md"
  - "v1/internal/deep/cmd_repo_deep.puml"

ledger_hints:
  - "Observed .maestro directory usage in cmd_repo deep flow; violates FORBID_REPO_DOT_MAESTRO invariant; migrate to ./docs/maestro/."
