id: "CMD-wsession"
layer: "code"
title: "wsession deep internal flow (observed)"
status: "correct"
confidence: "high"
storage_backend: "json"

calls:
  - maestro.main.main
  - maestro.commands.work_session.add_wsession_parser
  - maestro.commands.work_session.handle_wsession_list
  - maestro.commands.work_session.handle_wsession_show
  - maestro.commands.work_session.handle_wsession_tree
  - maestro.commands.work_session.handle_wsession_breadcrumbs
  - maestro.commands.work_session.handle_wsession_timeline
  - maestro.commands.work_session.handle_wsession_stats
  - maestro.commands.work_session._resolve_session_id
  - maestro.commands.work_session.export_session_json
  - maestro.commands.work_session.export_session_markdown
  - maestro.commands.work_session._filter_hierarchy_by_status
  - maestro.commands.work_session._print_breadcrumb_counts
  - maestro.work_session.WorkSession
  - maestro.work_session.list_sessions
  - maestro.work_session.load_session
  - maestro.work_session.get_session_hierarchy
  - maestro.work_session.create_session
  - maestro.breadcrumb.Breadcrumb
  - maestro.breadcrumb.list_breadcrumbs
  - maestro.breadcrumb.get_breadcrumb_summary
  - maestro.breadcrumb.reconstruct_session_timeline
  - maestro.visualization.tree.SessionTreeRenderer
  - maestro.visualization.table.SessionTableFormatter
  - maestro.visualization.detail.SessionDetailFormatter
  - maestro.stats.session_stats.SessionStats
  - maestro.stats.session_stats.calculate_session_stats
  - maestro.stats.session_stats.calculate_tree_stats

stores:
  - docs/sessions/

nodes:
  - id: "main_entry"
    type: "function"
    module: "maestro/main.py"
    function: "main"
  - id: "add_wsession_parser"
    type: "function"
    module: "maestro/commands/work_session.py"
    function: "add_wsession_parser"
  - id: "handle_wsession_list"
    type: "function"
    module: "maestro/commands/work_session.py"
    function: "handle_wsession_list"
  - id: "handle_wsession_show"
    type: "function"
    module: "maestro/commands/work_session.py"
    function: "handle_wsession_show"
  - id: "handle_wsession_tree"
    type: "function"
    module: "maestro/commands/work_session.py"
    function: "handle_wsession_tree"
  - id: "handle_wsession_breadcrumbs"
    type: "function"
    module: "maestro/commands/work_session.py"
    function: "handle_wsession_breadcrumbs"
  - id: "handle_wsession_timeline"
    type: "function"
    module: "maestro/commands/work_session.py"
    function: "handle_wsession_timeline"
  - id: "handle_wsession_stats"
    type: "function"
    module: "maestro/commands/work_session.py"
    function: "handle_wsession_stats"
  - id: "_resolve_session_id"
    type: "function"
    module: "maestro/commands/work_session.py"
    function: "_resolve_session_id"
  - id: "export_session_json"
    type: "function"
    module: "maestro/commands/work_session.py"
    function: "export_session_json"
  - id: "export_session_markdown"
    type: "function"
    module: "maestro/commands/work_session.py"
    function: "export_session_markdown"
  - id: "_filter_hierarchy_by_status"
    type: "function"
    module: "maestro/commands/work_session.py"
    function: "_filter_hierarchy_by_status"
  - id: "_print_breadcrumb_counts"
    type: "function"
    module: "maestro/commands/work_session.py"
    function: "_print_breadcrumb_counts"
  - id: "work_session_class"
    type: "class"
    module: "maestro/work_session.py"
    class: "WorkSession"
  - id: "list_sessions"
    type: "function"
    module: "maestro/work_session.py"
    function: "list_sessions"
  - id: "load_session"
    type: "function"
    module: "maestro/work_session.py"
    function: "load_session"
  - id: "get_session_hierarchy"
    type: "function"
    module: "maestro/work_session.py"
    function: "get_session_hierarchy"
  - id: "create_session"
    type: "function"
    module: "maestro/work_session.py"
    function: "create_session"
  - id: "breadcrumb_class"
    type: "class"
    module: "maestro/breadcrumb.py"
    class: "Breadcrumb"
  - id: "list_breadcrumbs"
    type: "function"
    module: "maestro/breadcrumb.py"
    function: "list_breadcrumbs"
  - id: "get_breadcrumb_summary"
    type: "function"
    module: "maestro/breadcrumb.py"
    function: "get_breadcrumb_summary"
  - id: "reconstruct_session_timeline"
    type: "function"
    module: "maestro/breadcrumb.py"
    function: "reconstruct_session_timeline"
  - id: "session_tree_renderer"
    type: "class"
    module: "maestro/visualization/tree"
    class: "SessionTreeRenderer"
  - id: "session_table_formatter"
    type: "class"
    module: "maestro/visualization/table"
    class: "SessionTableFormatter"
  - id: "session_detail_formatter"
    type: "class"
    module: "maestro/visualization/detail"
    class: "SessionDetailFormatter"
  - id: "session_stats_class"
    type: "class"
    module: "maestro/stats/session_stats.py"
    class: "SessionStats"
  - id: "calculate_session_stats"
    type: "function"
    module: "maestro/stats/session_stats.py"
    function: "calculate_session_stats"
  - id: "calculate_tree_stats"
    type: "function"
    module: "maestro/stats/session_stats.py"
    function: "calculate_tree_stats"
  - id: "docs_sessions_dir"
    type: "datastore"
    path: "docs/sessions/"
  - id: "pathlib"
    type: "module"
  - id: "json"
    type: "module"
  - id: "logging"
    type: "module"
  - id: "sys"
    type: "module"
  - id: "datetime"
    type: "module"
  - id: "file_system"
    type: "actor"

edges:
  - from: "main_entry"
    to: "add_wsession_parser"
  - from: "main_entry"
    to: "handle_wsession_list"
  - from: "main_entry"
    to: "handle_wsession_show"
  - from: "main_entry"
    to: "handle_wsession_tree"
  - from: "main_entry"
    to: "handle_wsession_breadcrumbs"
  - from: "main_entry"
    to: "handle_wsession_timeline"
  - from: "main_entry"
    to: "handle_wsession_stats"
  - from: "handle_wsession_list"
    to: "list_sessions"
  - from: "list_sessions"
    to: "docs_sessions_dir"
  - from: "handle_wsession_list"
    to: "session_table_formatter"
  - from: "handle_wsession_show"
    to: "_resolve_session_id"
  - from: "handle_wsession_show"
    to: "load_session"
  - from: "handle_wsession_show"
    to: "session_detail_formatter"
  - from: "handle_wsession_show"
    to: "export_session_json"
  - from: "export_session_json"
    to: "file_system"
  - from: "export_session_json"
    to: "list_breadcrumbs"
  - from: "export_session_json"
    to: "calculate_session_stats"
  - from: "export_session_json"
    to: "list_sessions"
  - from: "handle_wsession_show"
    to: "export_session_markdown"
  - from: "export_session_markdown"
    to: "file_system"
  - from: "export_session_markdown"
    to: "list_breadcrumbs"
  - from: "export_session_markdown"
    to: "calculate_session_stats"
  - from: "handle_wsession_tree"
    to: "get_session_hierarchy"
  - from: "get_session_hierarchy"
    to: "docs_sessions_dir"
  - from: "handle_wsession_tree"
    to: "_filter_hierarchy_by_status"
  - from: "handle_wsession_tree"
    to: "session_tree_renderer"
  - from: "handle_wsession_tree"
    to: "_print_breadcrumb_counts"
  - from: "handle_wsession_breadcrumbs"
    to: "_resolve_session_id"
  - from: "handle_wsession_breadcrumbs"
    to: "get_breadcrumb_summary"
  - from: "handle_wsession_breadcrumbs"
    to: "list_breadcrumbs"
  - from: "list_breadcrumbs"
    to: "docs_sessions_dir"
  - from: "handle_wsession_timeline"
    to: "_resolve_session_id"
  - from: "handle_wsession_timeline"
    to: "reconstruct_session_timeline"
  - from: "reconstruct_session_timeline"
    to: "docs_sessions_dir"
  - from: "handle_wsession_stats"
    to: "_resolve_session_id"
  - from: "handle_wsession_stats"
    to: "load_session"
  - from: "handle_wsession_stats"
    to: "calculate_session_stats"
  - from: "handle_wsession_stats"
    to: "calculate_tree_stats"
  - from: "handle_wsession_stats"
    to: "session_detail_formatter"
  - from: "handle_wsession_stats"
    to: "list_sessions"
  - from: "_resolve_session_id"
    to: "list_sessions"
  - from: "handle_wsession_show"
    to: "pathlib"
  - from: "handle_wsession_show"
    to: "json"
  - from: "handle_wsession_show"
    to: "logging"
  - from: "handle_wsession_show"
    to: "sys"
  - from: "handle_wsession_show"
    to: "datetime"

evidence:
  - "v1/internal/deep/cmd_wsession_deep.puml"
  - "maestro/commands/work_session.py"
  - "maestro/work_session.py"
  - "maestro/breadcrumb.py"
  - "maestro/visualization/tree.py"
  - "maestro/visualization/table.py"
  - "maestro/visualization/detail.py"
  - "maestro/stats/session_stats.py"

ledger_hints:
  - "Observed JSON persistence in cmd_wsession deep flow with session.json and breadcrumbs.jsonl; aligns with v2 repo truth using JSON. Confirmed REPO_TRUTH_FORMAT_IS_JSON invariant."
