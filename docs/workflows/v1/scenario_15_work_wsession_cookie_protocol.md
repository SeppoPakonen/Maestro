# WF-15: Work ↔ wsession Cookie Protocol (File-based Polling, Multi-process Safe)

## Metadata
```yaml
id: WF-15
title: Work ↔ wsession cookie protocol (file-based polling, multi-process safe)
tags: [work, wsession, cookie, ipc, polling, breadcrumbs, multi-process]
entry_conditions: |
  - A `maestro work` orchestrator run has been initiated for a specific task or workflow.
  - The AI engine or operator needs to provide updates (e.g., breadcrumbs) to this active `maestro work` run.
  - The `maestro work` command has started an underlying Python process (or subprocess) to manage the work session.
exit_conditions: |
  - The `maestro work` run successfully processes all received updates and completes its task.
  - The `maestro work` run is explicitly terminated or encounters a critical error.
  - All `wsession` commands targeting the work-run have completed their write operations.
artifacts_created: |
  - `docs/sessions/<session_id>/session.json`: Work session metadata file.
  - `docs/sessions/<session_id>/breadcrumbs/<depth_level>/<timestamp>.json`: Individual breadcrumb files.
failure_semantics: |
  - **Wrong/Unknown Cookie**: A `maestro wsession` command invoked with a non-existent or incorrect `session_id` (cookie) will fail immediately with a clear error message. The `maestro work` orchestrator will not be affected.
  - **Branch Mismatch (WF-14)**: If `maestro work` is designed to check for branch consistency (not currently implemented for IPC), a mismatch might invalidate the run or cause specific actions to be rejected upon application. Currently, this check is not performed during breadcrumb ingestion.
  - **Mailbox Corruption/Permission Errors**: If the `docs/sessions` directory or specific session subdirectories become corrupted or inaccessible due to permission errors, `maestro work` should gracefully log the error and attempt to recover if possible (e.g., skip malformed messages, retry reading). Persistent errors should lead to a hard stop for the affected `maestro work` orchestrator to prevent silent data loss or incorrect state. `wsession` commands will report write errors.
  - **Invalid Message Schema**: Breadcrumbs with an invalid schema will be rejected by the `maestro work` orchestrator, logged as an error, but should not crash the orchestrator.
links_to: [WF-06, WF-09, WF-14]
related_commands: |
  - `maestro work`: Orchestrates the work session, creates the cookie, polls the inbox.
  - `maestro wsession <subcommand> --cookie <id>`: Writes updates (e.g., breadcrumbs) to a specific work session.
```

## 1. Protocol Overview

This protocol defines the communication mechanism between a `maestro work` orchestrator run and various `maestro wsession` commands (invoked by an AI engine or operator). The communication is achieved through a file-based polling system, leveraging a unique "cookie" (session ID) to target specific work runs, ensuring multi-process safety.

*   **`Maestro work` (the Orchestrator)**: Initiates a work-run, creating a unique work session (identified by a `session_id`). It owns the "inbox" (the session's `breadcrumbs/` directory) and is responsible for periodically polling this directory for new updates.
*   **AI Engine / Operator (`maestro wsession` sender)**: Uses the `maestro wsession ... --cookie <session_id>` command to append updates (primarily breadcrumbs) to the specified work session. This command writes structured JSON files into the designated "inbox" directory.
*   **IPC / Home Hub**: The local filesystem, specifically `docs/sessions/<session_id>/breadcrumbs/`, acts as the intermediary message broker.

## 2. Cookie Definition

A "cookie" in this protocol refers to the `session_id` of a `WorkSession`.

*   **Uniqueness**: Each `maestro work` run generates a unique `session_id` using `uuid.uuid4()`, ensuring isolation between concurrent work runs.
*   **Distribution**:
    *   The `session_id` is output to the user (e.g., on the console) upon `maestro work` initiation.
    *   It must be explicitly included in the prompt provided to the AI engine, instructing the AI to use this ID when invoking `maestro wsession` commands.
*   **Usage**: All `maestro wsession` calls that intend to update a specific work-run *must* pass this `session_id` via a `--cookie` (or equivalent) argument. This prevents `wsession` commands from guessing the current run or accidentally writing to the wrong session.

**Code-grounding**: The `session_id` is defined as a string in `maestro.work_session.WorkSession` and is generated by `uuid.uuid4()` within `maestro.work_session.create_session`.

## 3. File Layout (IPC Mailbox)

The file layout for IPC artifacts strictly adheres to WF-09 and the structure identified in `command_wsession_protocol.md`.

*   **Base Location**: `docs/sessions/` (project-local, managed by Git).
*   **Work Run Instance**: `docs/sessions/<session_id>/`
    *   `session.json`: Contains the `WorkSession` metadata (status, timestamps, related entities, etc.). This file is updated by `maestro work` to reflect the session's state.
    *   `breadcrumbs/`: This directory serves as the "inbox" for breadcrumb messages.
        *   `breadcrumbs/<depth_level>/`: Breadcrumbs are further organized by their `depth_level` to simplify filtering and processing.
            *   `<timestamp>.json`: Individual breadcrumb messages, named by their timestamp.

**Preferred Policy (Actual Implementation)**:
`docs/sessions/<session-id>/`
  * `session.json`
  * `breadcrumbs/`
    * `<depth_level>/`
      * `<timestamp>.json` (append-only messages)

**Atomic Operations**: All writes to `session.json` and `<timestamp>.json` files are atomic, using a temporary file and `os.replace`. This provides inherent multi-process safety for writes to individual files.

## 4. Message Schema (Breadcrumbs)

The primary message type exchanged via this protocol is the "breadcrumb." Breadcrumbs conform to the `maestro.breadcrumb.Breadcrumb` dataclass schema, as detailed in `command_wsession_protocol.md`.

*   **Minimum Required Fields (Actual Implementation)**:
    *   `timestamp` (string, ISO 8601 `YYYYMMDD_HHMMSS_microseconds`): Auto-generated by the system upon creation.
    *   `breadcrumb_id` (string, UUID): Unique ID for the breadcrumb.
    *   `prompt` (string): The input text/data that led to this breadcrumb.
    *   `response` (string): The AI's response or the outcome of the action.
    *   `tools_called` (list of dicts): Details of any tools invoked.
    *   `files_modified` (list of dicts): Records of file changes.
    *   `parent_session_id` (string, optional): Parent session ID if part of a sub-task.
    *   `depth_level` (integer): Hierarchical depth of the breadcrumb within the session.
    *   `model_used` (string): Name of the AI model.
    *   `token_count` (dict): `{input: N, output: M}`.
    *   `cost` (float, optional): Estimated monetary cost.
    *   `error` (string, optional): Error message if an operation failed.

*   **Validation Behavior**:
    *   **Invalid Message**: If a `maestro work` orchestrator encounters a breadcrumb JSON file with a schema that cannot be parsed into a `Breadcrumb` object, it will log the error, skip processing that specific breadcrumb, and continue with the next. It will *not* crash the work-run.
    *   **Rejected & Recorded**: Rejected breadcrumbs should be moved to an `error/` subdirectory within the `breadcrumbs/` directory for post-mortem analysis, or their error state should be recorded in a log. (This specific error handling for malformed breadcrumbs is a proposed enhancement).

**Code-grounding**: The `Breadcrumb` dataclass in `maestro.breadcrumb.py` defines the schema.

## 5. Polling Algorithm

The `maestro work` orchestrator is responsible for polling its `breadcrumbs/` inbox.

*   **Polling Interval**: `maestro work` will check for new breadcrumb files at regular intervals (e.g., every N seconds or at the beginning of each main loop iteration). The specific interval is implementation-dependent, balancing responsiveness with system overhead.
*   **Ordering Rules**:
    1.  `maestro work` lists all `.json` files within `docs/sessions/<session_id>/breadcrumbs/<depth_level>/` for all `depth_level` directories.
    2.  Files are sorted lexicographically by their filename (which is the timestamp `YYYYMMDD_HHMMSS_microseconds`). This ensures chronological processing.
*   **Idempotency**:
    *   To avoid double-processing, `maestro work` maintains an internal record (e.g., a simple list or set of `breadcrumb_id`s or filenames) of breadcrumbs that have already been processed for the current work session.
    *   When new files are discovered, `maestro work` checks this record. Only new, unprocessed breadcrumbs are loaded and applied.
    *   Once a breadcrumb is successfully processed, its identifier is added to the record.
*   **Concurrency Rules**:
    *   **Append-Only Inbox**: The `breadcrumbs/` directory acts as an append-only log. `wsession` commands only add new files; they do not modify existing ones.
    *   **Atomic Writes**: As noted in section 3, `write_breadcrumb` uses atomic file writes, preventing partial or corrupted breadcrumb files from being visible to the reader.
    *   **Locking**: No explicit file locking mechanism is currently employed for the `breadcrumbs/` directory itself, relying on the atomic nature of file writes and unique filenames. If `maestro work` needed to prevent `wsession` from writing new files during its processing window, a lightweight file-based lock could be introduced (e.g., `lock` file within `breadcrumbs/`). This is not strictly necessary for append-only logs.

## 6. Failure Semantics

*   **Wrong/Unknown Cookie**: If a `maestro wsession --cookie <id>` command is executed with a `<id>` that does not correspond to an active or existing session, the command will report a "session not found" error and terminate. It will not create new session data.
*   **Branch Mismatch (WF-14)**: Currently, there is no automatic check for branch mismatches when processing breadcrumbs. `maestro work` assumes the context provided by the AI (including branch information implicitly part of the AI's state leading to the breadcrumb) is correct. Future enhancements might integrate WF-14 checks during breadcrumb processing if the breadcrumb schema is extended to include branch information.
*   **Mailbox Corruption or Permission Errors**:
    *   **Reading Errors**: If `maestro work` encounters a malformed JSON file or permission issues when reading `breadcrumbs/` or `session.json`, it should log a warning/error and attempt to continue processing other files. Persistent or critical read errors (e.g., `docs/sessions/` becoming inaccessible) should result in `maestro work` pausing or terminating, as it indicates a fundamental inability to maintain the work session state.
    *   **Writing Errors**: If `maestro wsession` encounters permission errors when writing a breadcrumb, it will fail and report the error to the user/AI.

## 7. Security Posture (Light-touch)

*   **Not a Security Boundary**: This file-based IPC protocol is primarily designed for correctness, traceability, and operational clarity within a trusted execution environment. It is *not* intended to be a robust security boundary against malicious actors or unauthorized access.
*   **Correctness/Traceability Boundary**: Its main purpose is to ensure that AI interactions are correctly attributed, recorded, and can be fully traced and audited.
*   **Git History**: For critical data and system state changes, Git history provides the ultimate rollback and auditing mechanism, offering protection against accidental corruption or unwanted changes.

## 8. Tests Implied by WF-15

*   **Unit Tests**:
    *   **Cookie Generation/Validation**: Test `uuid.uuid4()` generation, and the `_resolve_session_id` logic to correctly identify sessions from IDs or "latest".
    *   **Message Schema Validation**: Test that `maestro.breadcrumb.Breadcrumb` dataclass correctly parses valid JSON and handles invalid/missing fields gracefully (e.g., raises appropriate exceptions or defaults).
    *   **Inbox Write Atomicity**: Test `maestro.breadcrumb.write_breadcrumb` and `maestro.work_session.save_session` to ensure atomic writes using `.tmp` files and `os.replace`, even under simulated concurrent access.
    *   **Polling Consumes Messages Exactly Once**: Test the polling logic in `maestro work` to ensure breadcrumbs are processed precisely once and that the internal "processed" record functions correctly.
    *   **Ordering of Breadcrumbs**: Verify that `list_breadcrumbs` (and thus `maestro work`'s processing) returns breadcrumbs in chronological order based on their timestamp filenames.
*   **Integration Tests**:
    *   **Basic Workflow**:
        1.  Start `maestro work` in one process.
        2.  From another process, send several breadcrumbs via `maestro wsession --cookie <session_id> ...`.
        3.  Verify that the `maestro work` process logs and reflects these breadcrumbs in its work session log.
    *   **Multiple Concurrent Runs**:
        1.  Start two independent `maestro work` runs (generating two distinct cookies).
        2.  Send breadcrumbs to each session from separate `maestro wsession` calls, ensuring the correct cookie is used.
        3.  Verify that breadcrumbs are correctly isolated and processed only by their targeted `maestro work` orchestrator.
    *   **Invalid Cookie Handling**: Test invoking `maestro wsession` with a non-existent cookie and assert that it fails gracefully without affecting active `maestro work` runs.
    *   **Mailbox Corruption Resilience**: Simulate a malformed breadcrumb JSON file in the inbox and verify `maestro work` logs the error and continues processing other valid breadcrumbs without crashing.
