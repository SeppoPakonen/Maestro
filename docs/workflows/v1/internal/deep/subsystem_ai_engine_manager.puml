@startuml subsystem_ai_engine_manager
!include _shared.puml

' AI Engine Manager Module
' MODULE: AiManagerModule, "maestro/ai/manager.py"
rectangle "AiEngineManager" as AiEngineManagerClass <<Class>>
        --

' AI Types Module
' MODULE: AiTypesModule, "maestro/ai/types.py"
    TYPE(AiEngineNameEnum, "AiEngineName")
rectangle "EngineCapabilities" as EngineCapabilitiesClass <<Class>>
rectangle "PromptRef" as PromptRefClass <<Class>>
rectangle "RunOpts" as RunOptsClass <<Class>>
    PROTOCOL(AiEngineSpecProtocol, "AiEngineSpec")
    PROTOCOL(AiSubprocessRunnerProtocol, "AiSubprocessRunner")
rectangle "FakeProcessResult" as FakeProcessResultClass <<Class>>
rectangle "AiRunResult" as AiRunResultClass <<Class>>

' AI Runner Module
' MODULE: AiRunnerModule, "maestro/ai/runner.py"
rectangle "RunResult" as RunResultClass <<Class>>
rectangle "run_engine_command()" as RunEngineCommand <<Function>>
rectangle "_run_subprocess_command()" as _RunSubprocessCommand <<Function>>
rectangle "_run_qwen_transport()" as _RunQwenTransport <<Function>>
rectangle "_parse_json_events()" as _ParseJsonEvents <<Function>>
rectangle "_get_remaining_buffer()" as _GetRemainingBuffer <<Function>>
rectangle "_extract_session_id_from_events()" as _ExtractSessionIdFromEvents <<Function>>
rectangle "_normalize_event()" as _NormalizeEvent <<Function>>

' AI Engines Package
' MODULE: AiEnginesPackage, "maestro/ai/engines/"
rectangle "get_spec(engine_name) [__init__.py]" as GetSpecFactory <<Function>>
rectangle "QwenEngineSpec [qwen.py]" as QwenEngineSpecClass <<Class>>
    ' ... Other engine specs (Gemini, Claude, Codex)

' AI Session Manager Module
' MODULE: AiSessionManagerModule, "maestro/ai/session_manager.py"
rectangle "AISessionManager" as AISessionManagerClass <<Class>>
        --
rectangle "extract_session_id()" as ExtractSessionIDFn <<Function>>

' AI Stream Render Module
' MODULE: AiStreamRenderModule, "maestro/ai/stream_render.py"
rectangle "StreamRenderer" as StreamRendererClass <<Class>>
rectangle "AiStreamEvent" as AiStreamEventClass <<Class>>

' AI Qwen Extractor Module
' MODULE: AiQwenExtractorModule, "maestro/ai/qwen_extractor.py"
rectangle "extract_qwen_assistant_text()" as ExtractQwenAssistantText <<Function>>
rectangle "filter_qwen_events_for_verbose_mode()" as FilterQwenEvents <<Function>>

' External AI Engine Binaries
rectangle "External AI Engine Binary" as AiEngineBinary <<Actor>>
CLOUD(InternalQwenClient, "Internal Qwen Client (stdio/tcp)")

' Persistent Stores
rectangle "docs/state/ai_sessions.json" as AiSessionsJson <<Data Store>>
rectangle "docs/logs/ai/" as AiLogsDir <<Data Store>>
rectangle "stdout" as Stdout <<Data Store>>
rectangle "stderr" as Stderr <<Data Store>>

' Relationships

' AiEngineManager orchestrates
AiEngineManagerClass --> GetSpecFactory : "gets engine spec"
AiEngineManagerClass --> AiSessionManagerClass : "manages sessions"
AiEngineManagerClass --> AiRunnerModule.RunEngineCommand : "delegates execution"
AiEngineManagerClass --> PromptRefClass
AiEngineManagerClass --> RunOptsClass

' Engine Spec Definition
AiEngineSpecProtocol <|-- QwenEngineSpecClass
AiEngineSpecProtocol <.. AiEngineManagerClass : "uses spec methods"
AiEngineSpecProtocol --> EngineCapabilitiesClass : "defines capabilities"

QwenEngineSpecClass ..> RunOptsClass
QwenEngineSpecClass ..> PromptRefClass

GetSpecFactory --> QwenEngineSpecClass : "returns specific spec instance"
GetSpecFactory --> AiEngineNameEnum

' AI Runner execution flow
RunEngineCommand -[hidden]-> AiRunnerModule
RunEngineCommand -- _RunSubprocessCommand : "standard subprocess"
RunEngineCommand -- _RunQwenTransport : "Qwen specific client"

_RunSubprocessCommand --> AiEngineBinary : "invokes external binary"
_RunSubprocessCommand --> Stdout : "reads from"
_RunSubprocessCommand --> Stderr : "reads from"
_RunSubprocessCommand --> AiLogsDir : "writes logs"
_RunSubprocessCommand --> _ParseJsonEvents : "parses streaming output"
_RunSubprocessCommand --> _GetRemainingBuffer : "manages buffer"
_RunSubprocessCommand --> _ExtractSessionIdFromEvents : "extracts session ID"
_RunSubprocessCommand --> _NormalizeEvent : "normalizes events"
_RunSubprocessCommand --> StreamRendererClass : "renders events"
_RunSubprocessCommand --> AiQwenExtractorModule : "Qwen specific text extraction"

_RunQwenTransport --> InternalQwenClient : "invokes internal client"
_RunQwenTransport --> AiLogsDir : "writes logs (mock)"

_ParseJsonEvents --> AiStreamEventClass : "creates stream events"
_NormalizeEvent --> AiStreamEventClass : "creates normalized events"

_ExtractSessionIdFromEvents --> AiStreamEventClass : "extracts from events"

' Session Management
AiSessionManagerClass --> AiSessionsJson : "persists state to JSON file"
AiSessionManagerClass --> AiEngineNameEnum
AiSessionManagerClass --> ExtractSessionIDFn : "uses shared session ID extraction"

ExtractSessionIDFn --> AiStreamEventClass : "extracts from events"

' Results
AiRunResultClass <.. AiEngineManagerClass : "returns result"
RunResultClass <.. RunEngineCommand : "returns intermediate result"

@enduml
