@startuml subsystem_issue_task_graph
!include _shared.puml

' MODULE: IssueModel, "maestro/issues/model.py"
rectangle "IssueRecord" as IssueRecordClass <<Class>>
    RECTANGLE(IssueTypes, "ISSUE_TYPES")
    RECTANGLE(IssueStates, "ISSUE_STATES")
    RECTANGLE(StateTransitions, "STATE_TRANSITIONS")

    IssueRecordClass --> IssueTypes
    IssueRecordClass --> IssueStates
    IssueRecordClass --> StateTransitions
rectangle "can_transition()" as CanTransition <<Function>>
    CanTransition --> StateTransitions

' MODULE: IssueStore, "maestro/issues/issue_store.py"
rectangle "IssueDetails" as IssueDetailsClass <<Class>>
rectangle "generate_issue_id()" as GenerateIssueID <<Function>>
rectangle "write_issue()" as WriteIssue <<Function>>
rectangle "load_issue()" as LoadIssue <<Function>>
rectangle "list_issues()" as ListIssues <<Function>>
rectangle "update_issue_state()" as UpdateIssueState <<Function>>
rectangle "rollback_issue_state()" as RollbackIssueState <<Function>>
rectangle "update_issue_priority()" as UpdateIssuePriority <<Function>>
rectangle "update_issue_metadata()" as UpdateIssueMetadata <<Function>>
rectangle "update_issue_section()" as UpdateIssueSection <<Function>>
rectangle "_find_issue_path()" as _FindIssuePath <<Function>>
rectangle "_update_metadata_line()" as _UpdateMetadataLine <<Function>>
rectangle "_append_history()" as _AppendHistory <<Function>>
rectangle "_upsert_section()" as _UpsertSection <<Function>>

' MODULE: IssueParsers, "maestro/issues/parsers.py"
rectangle "ParsedIssue" as ParsedIssueClass <<Class>>
rectangle "parse_build_logs()" as ParseBuildLogs <<Function>>
rectangle "parse_analyzer_output()" as ParseAnalyzerOutput <<Function>>
rectangle "_parse_build_line()" as _ParseBuildLine <<Function>>
rectangle "_parse_analyzer_line()" as _ParseAnalyzerLine <<Function>>
    ParsedIssueClass --> IssueDetailsClass : "converts to"

' MODULE: CommandsIssues, "maestro/commands/issues.py"
rectangle "handle_issues_command()" as HandleIssuesCommand <<Function>>
rectangle "_handle_list()" as _HandleList <<Function>>
rectangle "_handle_show()" as _HandleShow <<Function>>
rectangle "_handle_state()" as _HandleState <<Function>>
rectangle "_handle_rollback()" as _HandleRollback <<Function>>
rectangle "_handle_react()" as _HandleReact <<Function>>
rectangle "_handle_analyze()" as _HandleAnalyze <<Function>>
rectangle "_handle_decide()" as _HandleDecide <<Function>>
rectangle "_handle_fix()" as _HandleFix <<Function>>
rectangle "_create_fix_session()" as _CreateFixSession <<Function>>
rectangle "_extract_confidence()" as _ExtractConfidence <<Function>>
rectangle "_first_sentence()" as _FirstSentence <<Function>>
rectangle "_find_repo_root()" as _FindRepoRoot <<Function>>

' MODULE: TracksJsonStore, "maestro/tracks/json_store.py"
rectangle "JsonStore" as JsonStoreClass <<Class>>
rectangle "load_task()" as LoadTask <<Function>>
rectangle "save_task()" as SaveTask <<Function>>
rectangle "load_phase()" as LoadPhase <<Function>>
rectangle "save_phase()" as SavePhase <<Function>>
rectangle "list_all_phases()" as ListAllPhases <<Function>>

' MODULE: TracksModels, "maestro/tracks/models.py"
rectangle "Task" as TaskModel <<Class>>
rectangle "Phase" as PhaseModel <<Class>>
rectangle "Track" as TrackModel <<Class>>
    TaskModel --> PhaseModel : "belongs to"
    PhaseModel --> TrackModel : "belongs to"

' MODULE: CommandsTask, "maestro/commands/task.py"
rectangle "handle_task_command()" as HandleTaskCommand <<Function>>
rectangle "list_tasks()" as ListTasks <<Function>>
rectangle "add_task()" as AddTask <<Function>>
rectangle "remove_task()" as RemoveTask <<Function>>
rectangle "show_task()" as ShowTask <<Function>>
rectangle "set_task_status()" as SetTaskStatus <<Function>>
rectangle "edit_task()" as EditTask <<Function>>
rectangle "set_task_context()" as SetTaskContext <<Function>>
rectangle "_collect_task_entries()" as _CollectTaskEntries <<Function>>

' MODULE: DataMarkdown, "maestro/data/markdown_parser.py"
rectangle "parse_todo_md()" as ParseTodoMd <<Function>>
rectangle "parse_phase_md()" as ParsePhaseMd <<Function>>
    ' ... other Markdown parsers

' MODULE: DataMarkdownWriter, "maestro/data/markdown_writer.py"
rectangle "insert_task_block()" as InsertTaskBlock <<Function>>
rectangle "replace_task_block()" as ReplaceTaskBlock <<Function>>
rectangle "remove_task_block()" as RemoveTaskBlock <<Function>>
    ' ... other Markdown writers

' MODULE: AiClient, "maestro/ai/client.py"
rectangle "ExternalCommandClient" as ExternalCommandClient <<Class>>

rectangle "docs/issues/<id>.md" as DocsIssuesMd <<Data Store>>
rectangle "docs/sessions/<id>.md" as DocsSessionsMd <<Data Store>>
rectangle "docs/todo.md" as DocsTodoMd <<Data Store>>
rectangle "docs/phases/<id>.md" as DocsPhasesMd <<Data Store>>
rectangle ".maestro/tracks/*/.json" as MaestroJsonStore <<Data Store>>

' Issue Flow
IssueDetailsClass <-- ParsedIssueClass
WriteIssue(IssueDetailsClass) --> DocsIssuesMd : "Writes new issue"
LoadIssue(DocsIssuesMd) --> IssueRecordClass : "Loads existing issue"
ListIssues --> DocsIssuesMd : "Reads all issues"
UpdateIssueState --> DocsIssuesMd : "Updates issue state"
UpdateIssueMetadata --> DocsIssuesMd : "Updates metadata"
UpdateIssueSection --> DocsIssuesMd : "Updates section"
RollbackIssueState --> DocsIssuesMd : "Rolls back state"
CommandsIssues.HandleIssuesCommand --> IssueStore : "CRUD operations"

IssueParsers.ParseBuildLogs --> ParsedIssueClass : "Extracts issues from logs"
IssueParsers.ParseAnalyzerOutput --> ParsedIssueClass : "Extracts issues from analyzer output"

CommandsIssues._HandleAnalyze --> ExternalCommandClient : "AI Analysis"
CommandsIssues._HandleFix --> _CreateFixSession : "Initiates fix session"
_CreateFixSession --> DocsSessionsMd : "Creates fix session file"
_CreateFixSession --> TracksModels.TaskModel : "Generates plan of tasks (conceptual)"

' Task Flow
CommandsTask.HandleTaskCommand --> AddTask : "Add task"
CommandsTask.HandleTaskCommand --> ListTasks : "List tasks"
CommandsTask.HandleTaskCommand --> ShowTask : "Show task"
CommandsTask.HandleTaskCommand --> RemoveTask : "Remove task"
CommandsTask.HandleTaskCommand --> SetTaskStatus : "Set task status"
CommandsTask.HandleTaskCommand --> EditTask : "Edit task"
CommandsTask.HandleTaskCommand --> SetTaskContext : "Set context"

AddTask --> JsonStoreClass : "Adds Task to JSON store"
RemoveTask --> JsonStoreClass : "Removes Task from JSON store"
SetTaskStatus --> JsonStoreClass : "Updates Task status in JSON store"
_CollectTaskEntries --> JsonStoreClass : "Loads all tasks from JSON store"
ShowTask --> _CollectTaskEntries : "Gets task data"

TaskModel <-- JsonStoreClass : "Serialized/Deserialized"
PhaseModel <-- JsonStoreClass : "Serialized/Deserialized"
TrackModel <-- JsonStoreClass : "Serialized/Deserialized"

' Hybrid Data Management (Tasks/Phases/Tracks also have Markdown representation)
CommandsTask.EditTask --> DataMarkdownWriter : "Modifies Markdown"
CommandsTask.EditTask --> DataMarkdown : "Reads Markdown"

MaestroJsonStore <--> JsonStoreClass : "JSON Storage for Tracks/Phases/Tasks"
DocsTodoMd <--> DataMarkdown : "Markdown representation for Tracks/Phases/Tasks"
DocsPhasesMd <--> DataMarkdown : "Markdown representation for Phases/Tasks"

' Validation
UpdateIssueState --> CanTransition : "Issue state validation"
UpdateIssueState --> IssueStates
CommandsIssues._HandleState --> IssueStates : "Validates new state"
SetTaskStatus --> CommandsTask._NormalizeTaskStatus : "Validates task status"
CommandsIssues._HandleDecide --> IssueStates : "Validates decision input"

' Dependencies & Hierarchy (Logical)
TaskModel -up-> TaskModel : "Dependencies (List<str> of task_ids)"
TaskModel -up-> PhaseModel : "Child of Phase"
PhaseModel -up-> TrackModel : "Child of Track"

@enduml
