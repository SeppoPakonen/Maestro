@startuml cmd_root_deep
!include _shared.puml

' Core Command Modules
' MODULE: MaestroMain, "maestro/main.py"
rectangle "main()" as MainEntry <<Function>>

' MODULE: CommandHandlers, "maestro/modules/command_handlers.py"
rectangle "handle_root_set()" as HandleRootSet <<Function>>
rectangle "handle_root_get()" as HandleRootGet <<Function>>
rectangle "handle_root_refine()" as HandleRootRefine <<Function>>
rectangle "handle_root_discuss()" as HandleRootDiscuss <<Function>>
rectangle "handle_root_show()" as HandleRootShow <<Function>>
rectangle "load_session()" as LoadSession <<Function>>
rectangle "save_session()" as SaveSession <<Function>>
rectangle "get_maestro_dir()" as GetMaestroDir <<Function>> ' Used to determine session_dir
rectangle "edit_root_task_in_editor()" as EditRootTaskInEditor <<Function>> ' Used by new session
rectangle "build_prompt()" as BuildPrompt <<Function>> ' Generic prompt builder
rectangle "save_prompt_for_traceability()" as SavePromptForTraceability <<Function>>
rectangle "save_ai_output()" as SaveAiOutput <<Function>>
rectangle "get_multiline_input()" as GetMultilineInput <<Function>>
rectangle "print_ai_response()" as PrintAiResponse <<Function>>

' Session Model & Persistence
' MODULE: SessionModel, "maestro/session_model.py"
rectangle "Session" as SessionClass <<Class>>

' AI Integration
' MODULE: EnginesModule, "maestro/engines.py"
rectangle "get_engine()" as GetEngine <<Function>>
rectangle "PlannerError" as PlannerError <<Class>>

' Utility Modules
' MODULE: MaestroUtils, "maestro/modules/utils.py"
    ' print_header, print_info, print_success, print_error, print_warning, print_debug, Colors

' External Dependencies
rectangle "File System" as FileSystem <<Actor>>
rectangle "User (for input)" as User <<Actor>>
rectangle "External AI Service" as ExternalAI <<Actor>>
rectangle "subprocess module" as Subprocess <<Actor>>

' Persistent Stores
rectangle "docs/sessions/<name>/" as DocsSessionsDir <<Database>>
rectangle ".maestro/conversations/" as ConversationsDir <<Database>>
    *.txt (transcripts)


' --- Relationships and Call Flow ---

' CLI Command Setup (implicit via maestro.main.py and cli_parser)

' Command Dispatch (from maestro.main.py)
MainEntry -- HandleRootSet
MainEntry -- HandleRootGet
MainEntry -- HandleRootRefine
MainEntry -- HandleRootDiscuss
MainEntry -- HandleRootShow

' Common Session Loading
CommandHandlers.LoadSession --> DocsSessionsDir : "reads session.json"

' Root Set Flow (`maestro root set`)
HandleRootSet --> CommandHandlers.LoadSession
HandleRootSet --> User : "gets text input"
HandleRootSet --> SessionClass : "updates root_task fields"
HandleRootSet --> CommandHandlers.SaveSession --[#Red,dashed]-> DocsSessionsDir : "saves updated session"

' Root Get Flow (`maestro root get`)
HandleRootGet --> CommandHandlers.LoadSession
HandleRootGet --> User : "prints raw/clean root task"

' Root Show Flow (`maestro root show`)
HandleRootShow --> CommandHandlers.LoadSession
HandleRootShow --> User : "prints all root task details"

' Root Refine Flow (`maestro root refine`)
HandleRootRefine --> CommandHandlers.LoadSession
HandleRootRefine --> HandleRefineRoot : "delegates to utils.handle_refine_root"
HandleRefineRoot --> ExternalAI : "invokes AI planner"
HandleRefineRoot --> CommandHandlers.SaveSession

' Root Discuss Flow (`maestro root discuss`)
HandleRootDiscuss --> CommandHandlers.LoadSession
HandleRootDiscuss --> GetMaestroDir : "determines conversation dir"
HandleRootDiscuss --> ConversationsDir : "creates dir"
HandleRootDiscuss --> User : "interactive input"
HandleRootDiscuss --> GetEngine : "selects AI engine"
HandleRootDiscuss --> ExternalAI : "communicates with AI"
HandleRootDiscuss --> SessionClass : "updates session with refined root task, history"
HandleRootDiscuss --> CommandHandlers.SaveSession --[#Red,dashed]-> DocsSessionsDir
HandleRootDiscuss --> ConversationsDir --[#Red,dashed]-> FileSystem : "saves conversation transcript"

' Helper Interactions
GetMaestroDir --> FileSystem
EditRootTaskInEditor --> Subprocess : "editor interaction (if used)"
GetEngine --> ExternalAI

' Data Model interactions
SessionClass <.. LoadSession : "loaded into"
SessionClass --> SaveSession : "saved from"
SessionClass <.. CommandHandlers.HandleRootShow : "data source"

' Data Persistence
DocsSessionsDir <--> FileSystem
ConversationsDir <--> FileSystem

@enduml
