@startuml cmd_issues_deep
!include _shared.puml

' Core Command Modules
' MODULE: MaestroMain, "maestro/main.py"
rectangle "main()" as MainEntry <<Function>>

' MODULE: CommandsIssues, "maestro/commands/issues.py"
rectangle "add_issues_parser()" as AddIssuesParser <<Function>>
rectangle "handle_issues_command()" as HandleIssuesCommand <<Function>>
rectangle "_handle_list()" as _HandleList <<Function>>
rectangle "_handle_show()" as _HandleShow <<Function>>
rectangle "_handle_state()" as _HandleState <<Function>>
rectangle "_handle_rollback()" as _HandleRollback <<Function>>
rectangle "_handle_react()" as _HandleReact <<Function>>
rectangle "_handle_analyze()" as _HandleAnalyze <<Function>>
rectangle "_handle_decide()" as _HandleDecide <<Function>>
rectangle "_handle_fix()" as _HandleFix <<Function>>
rectangle "_find_repo_root()" as _FindRepoRoot <<Function>>
rectangle "_find_issue_path()" as _FindIssuePath <<Function>>
rectangle "_extract_confidence()" as _ExtractConfidence <<Function>>
rectangle "_first_sentence()" as _FirstSentence <<Function>>
rectangle "_create_fix_session()" as _CreateFixSession <<Function>>

' Issue Subsystem Modules
' MODULE: IssuesStore, "maestro/issues/issue_store.py"
rectangle "list_issues()" as ListIssues <<Function>>
rectangle "load_issue()" as LoadIssue <<Function>>
rectangle "update_issue_state()" as UpdateIssueState <<Function>>
rectangle "rollback_issue_state()" as RollbackIssueState <<Function>>
rectangle "update_issue_metadata()" as UpdateIssueMetadata <<Function>>
rectangle "update_issue_priority()" as UpdateIssuePriority <<Function>>
rectangle "update_issue_section()" as UpdateIssueSection <<Function>>
rectangle "IssueDetails" as IssueDetailsClass <<Class>>
rectangle "generate_issue_id()" as GenerateIssueId <<Function>>
rectangle "write_issue()" as WriteIssue <<Function>>

' MODULE: IssuesModel, "maestro/issues/model.py"
rectangle "IssueRecord" as IssueRecordClass <<Class>>
    RECTANGLE(IssueTypes, "ISSUE_TYPES")
    RECTANGLE(IssueStates, "ISSUE_STATES")
    RECTANGLE(StateTransitions, "STATE_TRANSITIONS")
rectangle "can_transition()" as CanTransition <<Function>>

' MODULE: SolutionsStore, "maestro/solutions/solution_store.py"
rectangle "match_solutions()" as MatchSolutions <<Function>>
rectangle "SolutionMatch" as SolutionMatchClass <<Class>>

' AI Integration
' MODULE: AiClient, "maestro/ai/client.py"
rectangle "ExternalCommandClient" as ExternalCommandClient <<Class>>

' Utility Modules
' MODULE: MaestroUtils, "maestro/modules/utils.py"
    ' print_header, print_error etc.

' External Dependencies
rectangle "File System" as FileSystem <<Actor>>
rectangle "External AI Service" as ExternalAI <<Actor>>

' Persistent Stores
rectangle "docs/issues/<id>.md" as DocsIssuesMd <<Database>>
rectangle "docs/solutions/<id>.md" as DocsSolutionsMd <<Database>>
rectangle "docs/sessions/<id>-fix-<timestamp>.md" as DocsSessionsMd <<Database>>

' --- Relationships and Call Flow ---

' CLI Command Setup
MainEntry --> AddIssuesParser : "Adds 'issues' command and subparsers"

' Command Dispatch
HandleIssuesCommand --> _FindRepoRoot : "Locates repo context"
HandleIssuesCommand -- _HandleList
HandleIssuesCommand -- _HandleShow
HandleIssuesCommand -- _HandleState
HandleIssuesCommand -- _HandleRollback
HandleIssuesCommand -- _HandleReact
HandleIssuesCommand -- _HandleAnalyze
HandleIssuesCommand -- _HandleDecide
HandleIssuesCommand -- _HandleFix

' Data Flow for Issue Records
IssueRecordClass <.. IssuesStore.LoadIssue : "loaded from Markdown"
IssueRecordClass --> IssuesStore.UpdateIssueState : "validates transitions"
IssueRecordClass ..> IssuesStore.UpdateIssueMetadata
IssueRecordClass ..> IssuesStore.UpdateIssuePriority
IssueRecordClass ..> IssuesStore.UpdateIssueSection

' Issue Lifecycle Commands
_HandleList --> IssuesStore.ListIssues --> DocsIssuesMd
_HandleShow --> IssuesStore.LoadIssue --> DocsIssuesMd

' State Management
_HandleState --> IssuesStore.UpdateIssueState
IssuesStore.UpdateIssueState --> IssuesModel.CanTransition : "validates state change"
IssuesStore.UpdateIssueState --> IssuesModel.IssueStates : "checks valid states"
_HandleRollback --> IssuesStore.RollbackIssueState

' Solution Matching
_HandleReact --> SolutionsStore.MatchSolutions
_HandleReact --> IssuesStore.UpdateIssueState
_HandleReact --> IssuesStore.UpdateIssueMetadata
_HandleReact --> IssuesStore.UpdateIssueSection
SolutionsStore.MatchSolutions --> DocsSolutionsMd : "reads solutions"

' AI-driven Analysis and Decision
_HandleAnalyze --> AiClient.ExternalCommandClient : "sends prompt to AI"
_HandleAnalyze --> CommandsIssues._ExtractConfidence : "parses AI response"
_HandleAnalyze --> CommandsIssues._FirstSentence : "summarizes AI response"
_HandleAnalyze --> IssuesStore.UpdateIssueState : "updates to 'analyzing', 'analyzed'"
_HandleAnalyze --> IssuesStore.UpdateIssueMetadata
_HandleAnalyze --> IssuesStore.UpdateIssueSection
ExternalCommandClient --> ExternalAI : "communicates with AI service"

_HandleDecide --> IssuesStore.UpdateIssueState : "updates to 'decided', 'cancelled'"
_HandleDecide --> IssuesStore.UpdateIssueMetadata
_HandleDecide --> IssuesStore.UpdateIssueSection
_HandleDecide --> IssuesStore.UpdateIssuePriority

' Fix Session Creation
_HandleFix --> CommandsIssues._CreateFixSession : "generates fix plan"
_HandleFix --> IssuesStore.UpdateIssueState : "updates to 'fixing', 'fixed'"
_HandleFix --> IssuesStore.UpdateIssueMetadata
_HandleFix --> IssuesStore.UpdateIssueSection
_CreateFixSession --[#Red,dashed]-> DocsSessionsMd : "writes fix session Markdown"

' File System Interactions
DocsIssuesMd <--> FileSystem : "Read/Write issue data"
DocsSolutionsMd <--> FileSystem : "Read solution data"
DocsSessionsMd <--> FileSystem : "Write fix session data"

' Helper function interactions
_FindRepoRoot --> FileSystem : "searches for .maestro"
_FindIssuePath --> FileSystem : "locates issue file"

' Validation and Constants
CommandsIssues --> IssuesModel.IssueTypes : "uses for type checking"
CommandsIssues --> IssuesModel.IssueStates : "uses for state checking"

@enduml
