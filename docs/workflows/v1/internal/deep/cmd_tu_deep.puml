@startuml cmd_tu_deep
!include _shared.puml

' Core Command Modules
' MODULE: MaestroMain, "maestro/main.py"
rectangle "main()" as MainEntry <<Function>>

' MODULE: CommandsTU, "maestro/commands/tu.py"
rectangle "add_tu_parser()" as AddTuParser <<Function>>
rectangle "handle_tu_command()" as HandleTuCommand <<Function>>
rectangle "get_parser_by_language()" as GetParserByLanguage <<Function>>
rectangle "detect_language_from_path()" as DetectLanguageFromPath <<Function>>
rectangle "get_files_by_language()" as GetFilesByLanguage <<Function>>
rectangle "handle_tu_build_command()" as HandleTuBuildCommand <<Function>>
rectangle "handle_tu_info_command()" as HandleTuInfoCommand <<Function>>
rectangle "handle_tu_query_command()" as HandleTuQueryCommand <<Function>>
rectangle "handle_tu_complete_command()" as HandleTuCompleteCommand <<Function>>
rectangle "handle_tu_references_command()" as HandleTuReferencesCommand <<Function>>
rectangle "handle_tu_lsp_command()" as HandleTuLspCommand <<Function>>
rectangle "handle_tu_cache_clear_command()" as HandleTuCacheClearCommand <<Function>>
rectangle "handle_tu_cache_stats_command()" as HandleTuCacheStatsCommand <<Function>>
rectangle "handle_tu_transform_command()" as HandleTuTransformCommand <<Function>>
rectangle "handle_tu_print_ast_command()" as HandleTuPrintAstCommand <<Function>>
rectangle "handle_tu_draft_command()" as HandleTuDraftCommand <<Function>>

' TU Core Modules
package "maestro/tu/parsers.py" as TuParsers <<Module>> { ' Conceptual grouping
rectangle "ClangParser" as ClangParserClass <<Class>>
rectangle "JavaParser" as JavaParserClass <<Class>>
rectangle "KotlinParser" as KotlinParserClass <<Class>>
rectangle "PythonParser" as PythonParserClass <<Class>>
    PROTOCOL(TranslationUnitParser, "TranslationUnitParser")

' MODULE: TuBuilder, "maestro/tu/tu_builder.py"
rectangle "TUBuilder" as TUBuilderClass <<Class>>
rectangle "build()" as Build <<Function>>
rectangle "build_with_symbols()" as BuildWithSymbols <<Function>>

package "maestro/tu/indexing.py" as TuIndexing <<Module>> { ' Conceptual grouping
rectangle "SymbolIndex" as SymbolIndexClass <<Class>>
rectangle "CompletionProvider" as CompletionProviderClass <<Class>>
rectangle "query()" as Query <<Function>>
rectangle "find_references()" as FindReferences <<Function>>
rectangle "get_completions()" as GetCompletions <<Function>>

' MODULE: TuLsp, "maestro/tu/lsp_server.py"
rectangle "MaestroLSPServer" as MaestroLSPServerClass <<Class>>
rectangle "start_tcp()" as StartTcp <<Function>>
rectangle "start_io()" as StartIo <<Function>>

' MODULE: TuTransformers, "maestro/tu/transformers.py"
rectangle "UppConventionTransformer" as UppConventionTransformerClass <<Class>>
rectangle "transform_document()" as TransformDocument <<Function>>
rectangle "generate_primary_header()" as GeneratePrimaryHeader <<Function>>
rectangle "update_cpp_includes()" as UpdateCppIncludes <<Function>>

package "maestro/tu/ast.py" as TuAst <<Module>> { ' Conceptual grouping
rectangle "ASTDocument" as ASTDocument <<Class>>
rectangle "ASTNode" as ASTNode <<Class>>
rectangle "ASTPrinter" as ASTPrinterClass <<Class>>
rectangle "print_document()" as PrintDocument <<Function>>

' MODULE: TuCodeGen, "maestro/tu/code_generator.py"
rectangle "CodeGenerator" as CodeGeneratorClass <<Class>>
rectangle "generate_class()" as GenerateClass <<Function>>
rectangle "generate_function()" as GenerateFunction <<Function>>

' Utility Modules
' MODULE: MaestroUtils, "maestro/modules/utils.py"
    ' print_success, print_error etc.

' External Dependencies
rectangle "File System" as FileSystem <<Actor>>
rectangle "shutil module" as Shutil <<Actor>>
rectangle "subprocess module" as Subprocess <<Actor>>
rectangle "json module" as Json <<Actor>>

' Persistent Stores
rectangle "Source Code Files (*.cpp, *.java, *.py etc.)" as SourceFiles <<Database>>
rectangle ".maestro/tu/cache/" as TuCacheDir <<Database>>
    *.ast (serialized ASTs)
rectangle ".maestro/tu/analysis/symbols.db" as SymbolIndexDb <<Database>>
rectangle ".maestro/tu/draft/" as TuDraftDir <<Database>>
    Generated draft files
rectangle "docs/todo-classes.md" as DocsTodoClassesMd <<Database>>


' --- Relationships and Call Flow ---

' CLI Command Setup
MainEntry --> AddTuParser : "Adds 'tu' command and subparsers"

' Command Dispatch
HandleTuCommand --> HandleTuBuildCommand
HandleTuCommand --> HandleTuInfoCommand
HandleTuCommand --> HandleTuQueryCommand
HandleTuCommand --> HandleTuCompleteCommand
HandleTuCommand --> HandleTuReferencesCommand
HandleTuCommand --> HandleTuLspCommand
HandleTuCommand --> HandleTuCacheClearCommand
HandleTuCommand --> HandleTuCacheStatsCommand
HandleTuCommand --> HandleTuTransformCommand
HandleTuCommand --> HandleTuPrintAstCommand
HandleTuCommand --> HandleTuDraftCommand

' Core TU Operations Flow
HandleTuBuildCommand --> GetFilesByLanguage
HandleTuBuildCommand --> DetectLanguageFromPath
HandleTuBuildCommand --> GetParserByLanguage
HandleTuBuildCommand --> TUBuilderClass.Build
TUBuilderClass.Build --> TuCacheDir : "writes cached TUs"

HandleTuQueryCommand --> SymbolIndexClass.Query --> SymbolIndexDb
HandleTuCompleteCommand --> CompletionProviderClass.GetCompletions
HandleTuReferencesCommand --> SymbolIndexClass.FindReferences --> SymbolIndexDb

HandleTuLspCommand --> MaestroLSPServerClass : "starts LSP server"
MaestroLSPServerClass --> StdIO : "TCP or STDIO communication"

HandleTuCacheClearCommand --> Shutil : "removes cache directory"
HandleTuCacheClearCommand --> TuCacheDir

HandleTuCacheStatsCommand --> TuCacheDir : "reads cache files"

HandleTuTransformCommand --> GetFilesByLanguage
HandleTuTransformCommand --> DetectLanguageFromPath
HandleTuTransformCommand --> GetParserByLanguage
HandleTuTransformCommand --> TUBuilderClass
HandleTuTransformCommand --> UppConventionTransformerClass.TransformDocument
UppConventionTransformerClass --> SourceFiles : "modifies source code"

HandleTuPrintAstCommand --> GetParserByLanguage
HandleTuPrintAstCommand --> ASTPrinterClass.PrintDocument
ASTPrinterClass.PrintDocument --> StdIO / FileSystem : "writes AST"

HandleTuDraftCommand --> GetFilesByLanguage
HandleTuDraftCommand --> DetectLanguageFromPath
HandleTuDraftCommand --> GetParserByLanguage
HandleTuDraftCommand --> TuCodeGen.CodeGeneratorClass
TuCodeGen.CodeGeneratorClass --> TuDraftDir : "writes generated code"
TuCodeGen.CodeGeneratorClass --> DocsTodoClassesMd : "links drafts to tasks/phases"

' Language Adapters
GetParserByLanguage --> TuParsers.ClangParserClass
GetParserByLanguage --> TuParsers.JavaParserClass
GetParserByLanguage --> TuParsers.KotlinParserClass
GetParserByLanguage --> TuParsers.PythonParserClass
TranslationUnitParser <|-- TuParsers.ClangParserClass
TranslationUnitParser <|-- TuParsers.JavaParserClass
TranslationUnitParser <|-- TuParsers.KotlinParserClass
TranslationUnitParser <|-- TuParsers.PythonParserClass

' Data Flow and Persistence
SourceFiles <--> FileSystem : "reads/writes source code"
TuCacheDir <--> FileSystem : "reads/writes TU cache"
SymbolIndexDb <--> FileSystem : "reads/writes symbol index"
TuDraftDir <--> FileSystem : "writes generated code"
DocsTodoClassesMd <--> FileSystem : "writes draft links"

@enduml
