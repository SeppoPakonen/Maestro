@startuml subsystem_repo_resolve
!include _shared.puml

' Repo Resolve Orchestrator
' MODULE: ScannerModule, "maestro/repo/scanner.py"
rectangle "RepoScanResult" as RepoScanResultClass <<Class>>
rectangle "scan_upp_repo_v2()" as ScanUppRepoV2 <<Function>>
rectangle "guess_path_kind()" as GuessPathKind <<Function>>
rectangle "infer_internal_packages()" as InferInternalPackages <<Function>>

' Core Data Structures
' MODULE: PackageModule, "maestro/repo/package.py"
rectangle "PackageInfo" as PackageInfoClass <<Class>>
rectangle "FileGroup" as FileGroupClass <<Class>>

' U++ Specific Parsers
' MODULE: UppParserModule, "maestro/repo/upp_parser.py"
rectangle "UppParser" as UppParserClass <<Class>>
rectangle "parse_upp_file()" as ParseUppFile <<Function>>
rectangle "parse_upp_content()" as ParseUppContent <<Function>>
    UppParserClass ..> FileGroupClass : "creates"

' MODULE: UplusplusVarReaderModule, "maestro/repo/uplusplus_var_reader.py"
rectangle "VarFileParser" as VarFileParserClass <<Class>>
rectangle "UppAssemblyReader" as UppAssemblyReaderClass <<Class>>
rectangle "read_user_assemblies()" as ReadUserAssemblies <<Function>>

' Generic Build System Scanners
' MODULE: BuildSystemsModule, "maestro/repo/build_systems.py"
rectangle "BuildSystemPackage" as BuildSystemPackageClass <<Class>>
rectangle "detect_build_system()" as DetectBuildSystem <<Function>>
rectangle "scan_all_build_systems()" as ScanAllBuildSystems <<Function>>
rectangle "scan_cmake_packages()" as ScanCmakePackages <<Function>>
rectangle "scan_msvs_packages()" as ScanMsvsPackages <<Function>>
rectangle "scan_maven_packages()" as ScanMavenPackages <<Function>>
rectangle "scan_gradle_packages()" as ScanGradlePackages <<Function>>
    ' ... other scan_*_packages
    BuildSystemPackageClass ..> PackageInfoClass : "converted to"

' Assembly Detection
' MODULE: AssemblyModule, "maestro/repo/assembly.py"
rectangle "AssemblyInfo" as AssemblyInfoClass <<Class>>
rectangle "detect_assemblies()" as DetectAssemblies <<Function>>
rectangle "classify_assembly_type()" as ClassifyAssemblyType <<Function>>
    ' ... other detect_*_assembly functions

' Convention Inference
' MODULE: GroupingModule, "maestro/repo/grouping.py"
rectangle "AutoGrouper" as AutoGrouperClass <<Class>>
rectangle "auto_group()" as AutoGroup <<Function>>
    AutoGrouperClass ..> FileGroupClass : "creates"

' External Systems
rectangle "File System" as FileSystem <<Actor>>
rectangle "~/.config/u++/ide/*.var" as UserConfigDir <<Database>>

' --- Relationships and Call Flow ---

' Main Scan Orchestration
ScanUppRepoV2 --> FileSystem : "Walks directory tree"
ScanUppRepoV2 --> UppParserModule.ParseUppFile : "Parses .upp files"
ScanUppRepoV2 --> BuildSystemsModule.ScanAllBuildSystems : "Scans other build systems"
ScanUppRepoV2 --> UplusplusVarReaderModule.ReadUserAssemblies : "Reads user assemblies"
ScanUppRepoV2 --> AssemblyModule.DetectAssemblies : "Detects assemblies"
ScanUppRepoV2 --> InferInternalPackages : "Infers internal packages"
ScanUppRepoV2 --> RepoScanResultClass : "Populates result"

' Package Information Flow
PackageInfoClass <.. UppParserModule : "populated by"
PackageInfoClass <.. BuildSystemsModule : "converted from BuildSystemPackage"
PackageInfoClass <.. ScannerModule : "collected by"

' Build System Detection & Parsing
ScanAllBuildSystems --> DetectBuildSystem : "First, detects systems"
DetectBuildSystem --> FileSystem : "Checks for signature files"
ScanAllBuildSystems --> ScanCmakePackages : "Invokes specific scanners"
ScanCmakePackages --> FileSystem : "Reads CMakeLists.txt"
ScanMsvsPackages --> FileSystem : "Reads .sln, .vcxproj, .csproj"
ScanMavenPackages --> FileSystem : "Reads pom.xml"
ScanGradlePackages --> FileSystem : "Reads build.gradle, settings.gradle"

' U++ Parsing Details
UppParserClass -[dashed]-> FileSystem : "Reads .upp files"
UppParserClass ..> UppParserClass : "uses _parse_* methods"
UppParserClass --> FileGroupClass : "_process_file_groups creates"
UppParserClass ..> PackageInfoClass : "results in metadata for"

' User Assembly Reading
ReadUserAssemblies --> UppAssemblyReaderClass : "initializes reader"
UppAssemblyReaderClass --> UserConfigDir : "reads .var files from"
UppAssemblyReaderClass --> VarFileParserClass : "parses .var files"

' Assembly Aggregation
DetectAssemblies --> PackageInfoClass : "consumes discovered packages"
DetectAssemblies --> AssemblyInfoClass : "produces AssemblyInfo"
DetectAssemblies ..> ClassifyAssemblyType : "uses classification logic"
ClassifyAssemblyType ..> AssemblyModule : "uses detect_*_assembly heuristics"

' Convention Inference / File Grouping
InferInternalPackages --> GroupingModule.AutoGrouperClass : "uses for unknown paths"
AutoGroup --> FileGroupClass : "creates inferred groups"
FileGroupClass <.. PackageInfoClass : "contained within"

' Output Structure
RepoScanResultClass --> AssemblyInfoClass : "contains detected assemblies"
RepoScanResultClass --> PackageInfoClass : "contains detected packages"
RepoScanResultClass --> ScannerModule.UnknownPath : "contains unknown paths"
RepoScanResultClass --> ScannerModule.InternalPackage : "contains inferred internal packages"

@enduml
