@startuml subsystem_docs_truth
!include _shared.puml

' MODULE: DataModule, "maestro/data"
    ' MODULE: MarkdownParser, "markdown_parser.py"
rectangle "parse_quoted_value()" as ParseQuotedValue <<Function>>
rectangle "parse_status_badge()" as ParseStatusBadge <<Function>>
rectangle "parse_checkbox()" as ParseCheckbox <<Function>>
rectangle "parse_heading()" as ParseHeading <<Function>>
rectangle "parse_track_heading()" as ParseTrackHeading <<Function>>
rectangle "parse_phase_heading()" as ParsePhaseHeading <<Function>>
rectangle "parse_task_heading()" as ParseTaskHeading <<Function>>
rectangle "parse_metadata_block()" as ParseMetadataBlock <<Function>>
rectangle "parse_track()" as ParseTrack <<Function>>
rectangle "parse_phase()" as ParsePhase <<Function>>
rectangle "parse_task()" as ParseTask <<Function>>
rectangle "parse_todo_md()" as ParseTodoMd <<Function>>
rectangle "parse_done_md()" as ParseDoneMd <<Function>>
rectangle "parse_phase_md()" as ParsePhaseMd <<Function>>
rectangle "parse_config_md()" as ParseConfigMd <<Function>>

    ' MODULE: MarkdownWriter, "markdown_writer.py"
rectangle "write_track_to_todo_md()" as WriteTrack <<Function>> ' Illustrative
rectangle "update_task_in_phase_md()" as UpdateTask <<Function>> ' Illustrative
rectangle "remove_phase_from_track_md()" as RemovePhase <<Function>> ' Illustrative
        ' ... many other writing/modifying functions

    ' MODULE: CommonUtils, "common_utils.py"
rectangle "parse_todo_safe()" as ParseTodoSafe <<Function>>
rectangle "parse_done_safe()" as ParseDoneSafe <<Function>>

' MODULE: Commands, "maestro/commands"
rectangle "handle_track_command()" as HandleTrackCmd <<Function>>
rectangle "handle_phase_command()" as HandlePhaseCmd <<Function>>
rectangle "handle_task_command()" as HandleTaskCmd <<Function>>
rectangle "handle_issues_command()" as HandleIssuesCmd <<Function>>
rectangle "handle_solutions_command()" as HandleSolutionsCmd <<Function>>
    ' ... other command handlers

rectangle "docs/todo.md" as DocsTodoMd <<Data Store>>
rectangle "docs/done.md" as DocsDoneMd <<Data Store>>
rectangle "docs/phase_*.md" as DocsPhaseMd <<Data Store>>
rectangle "docs/config.md" as DocsConfigMd <<Data Store>>
rectangle "File System" as FileSystem <<Data Store>>

' Parsing Pipeline
HandleTrackCmd --> ParseTodoSafe : "Reads active tracks"
HandlePhaseCmd --> ParseTodoSafe : "Reads active phases"
HandleTaskCmd --> ParseTodoSafe : "Reads active tasks"
HandleIssuesCmd --> ParseTodoSafe : "Reads issues from docs"
HandleSolutionsCmd --> ParseTodoSafe : "Reads solutions from docs"
' ... and others

ParseTodoSafe --> ParseTodoMd : "Calls specific file parser"
ParseDoneSafe --> ParseDoneMd : "Calls specific file parser"

ParseTodoMd --> ParseTrack : "Parses track sections"
ParseTrack --> ParsePhase : "Parses phase sections"
ParsePhase --> ParseTask : "Parses task items"
ParseTask --> ParseCheckbox : "Parses task status"
ParseTrack --> ParseTrackHeading : "Identifies track heading"
ParsePhase --> ParsePhaseHeading : "Identifies phase heading"
ParseTask --> ParseTaskHeading : "Identifies task heading"
ParseMetadataBlock <.. ParseTrack : "Parses metadata for track"
ParseMetadataBlock <.. ParsePhase : "Parses metadata for phase"
ParseMetadataBlock <.. ParseTask : "Parses metadata for task"
ParseMetadataBlock --> ParseQuotedValue : "Parses key-value pairs"

ParseTodoMd -[dashed]-> DocsTodoMd : "Reads content"
ParseDoneMd -[dashed]-> DocsDoneMd : "Reads content"
ParsePhaseMd -[dashed]-> DocsPhaseMd : "Reads content"
ParseConfigMd -[dashed]-> DocsConfigMd : "Reads content"

' Writing/Updating Pipeline (Illustrative, as it's often read-modify-write)
MarkdownWriter <.. HandleTrackCmd : "Updates docs/todo.md"
MarkdownWriter <.. HandlePhaseCmd : "Updates docs/todo.md or docs/phase_*.md"
MarkdownWriter <.. HandleTaskCmd : "Updates docs/todo.md or docs/phase_*.md"

WriteTrack --> DocsTodoMd : "Writes/updates track data"
UpdateTask --> DocsPhaseMd : "Updates task data"
RemovePhase --> DocsTodoMd : "Removes phase data"

' Data Flow and Boundaries
DocsTodoMd <--> FileSystem : "Active work"
DocsDoneMd <--> FileSystem : "Completed work archive"
DocsPhaseMd <--> FileSystem : "Individual phase details"
DocsConfigMd <--> FileSystem : "Project configuration"

' Implicit Validation/Enforcement
MarkdownParser -[#Blue]-> DocsTodoMd : "Assumes specific Markdown structure"
MarkdownWriter -[#Blue]-> DocsDoneMd : "Maintains TODO/DONE separation"

@enduml
