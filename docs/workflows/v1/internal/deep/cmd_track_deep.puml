@startuml cmd_track_deep
!include _shared.puml

' Core Command Modules
' MODULE: MaestroMain, "maestro/main.py"
rectangle "main()" as MainEntry <<Function>>

' MODULE: CommandsTrack, "maestro/commands/track.py"
rectangle "add_track_parsers()" as AddTrackParsers <<Function>>
rectangle "handle_track_command()" as HandleTrackCommand <<Function>>
rectangle "resolve_track_identifier()" as ResolveTrackIdentifier <<Function>>
rectangle "list_tracks()" as ListTracks <<Function>>
rectangle "show_track()" as ShowTrack <<Function>>
rectangle "show_track_details()" as ShowTrackDetails <<Function>>
rectangle "add_track()" as AddTrack <<Function>>
rectangle "remove_track()" as RemoveTrack <<Function>>
rectangle "edit_track()" as EditTrack <<Function>>
rectangle "set_track_status()" as SetTrackStatus <<Function>>
rectangle "set_track_context()" as SetTrackContext <<Function>>
rectangle "_ensure_todo_file()" as _EnsureTodoFile <<Function>>
rectangle "_parse_todo_safe()" as _ParseTodoSafe <<Function>>
rectangle "_slugify_track_id()" as _SlugifyTrackId <<Function>>

' Data Storage and Models
' MODULE: DataCommonUtils, "maestro/data/common_utils.py"
rectangle "get_all_tracks_with_phases_and_tasks()" as GetAllTracks <<Function>>
rectangle "resolve_identifier_by_type()" as ResolveIdentifierByType <<Function>>

' MODULE: DataMarkdownWriter, "maestro/data/markdown_writer.py"
rectangle "extract_track_block()" as ExtractTrackBlock <<Function>>
rectangle "replace_track_block()" as ReplaceTrackBlock <<Function>>
rectangle "update_track_metadata()" as UpdateTrackMetadata <<Function>>
rectangle "update_track_heading_status()" as UpdateTrackHeadingStatus <<Function>>

' MODULE: TracksJsonStore, "maestro/tracks/json_store.py"
rectangle "JsonStore" as JsonStoreClass <<Class>>
rectangle "load_track()" as LoadTrack <<Function>>
rectangle "save_track()" as SaveTrack <<Function>>
rectangle "load_index()" as LoadIndex <<Function>>
rectangle "save_index()" as SaveIndex <<Function>>

' MODULE: TracksModels, "maestro/tracks/models.py"
rectangle "Track" as TrackClass <<Class>>

' Display and Utility
' MODULE: DisplayTableRenderer, "maestro/display/table_renderer.py"
rectangle "render_track_table()" as RenderTrackTable <<Function>>
rectangle "render_phase_table()" as RenderPhaseTable <<Function>>

' MODULE: ConfigSettings, "maestro/config/settings.py"
rectangle "get_settings()" as GetSettings <<Function>>

' MODULE: StatusUtils, "maestro/commands/status_utils.py"
rectangle "normalize_status()" as NormalizeStatus <<Function>>
rectangle "allowed_statuses()" as AllowedStatuses <<Function>>
rectangle "status_badge()" as StatusBadge <<Function>>
rectangle "status_timestamp()" as StatusTimestamp <<Function>>

' MODULE: CommandsDiscuss, "maestro/commands/discuss.py"
rectangle "handle_track_discuss()" as HandleTrackDiscuss <<Function>>

' External Dependencies
rectangle "User's $EDITOR" as Editor <<Actor>>
rectangle "File System" as FileSystem <<Actor>>
rectangle "subprocess module" as Subprocess <<Actor>>

' Persistent Stores
rectangle "docs/todo.md" as DocsTodoMd <<Database>>
rectangle "docs/done.md" as DocsDoneMd <<Database>>
rectangle ".maestro/tracks/*.json" as MaestroTracksJson <<Database>>
rectangle ".maestro/tracks/index.json" as MaestroTracksIndexJson <<Database>>
rectangle "$HOME/.maestro/settings.json" as SettingsJson <<Database>>


' --- Relationships and Call Flow ---

' CLI Command Setup
MainEntry --> AddTrackParsers : "Adds 'track' command and subparsers"

' Command Dispatch
HandleTrackCommand -right-> ListTracks
HandleTrackCommand -right-> ShowTrack
HandleTrackCommand -right-> ShowTrackDetails
HandleTrackCommand -right-> AddTrack
HandleTrackCommand -right-> RemoveTrack
HandleTrackCommand -right-> EditTrack
HandleTrackCommand -right-> SetTrackStatus
HandleTrackCommand -right-> SetTrackContext
HandleTrackCommand -right-> CommandsDiscuss.HandleTrackDiscuss

' Track Identification
CommandsTrack.ResolveTrackIdentifier --> DataCommonUtils.ResolveIdentifierByType

' Listing Tracks
ListTracks --> DataCommonUtils.GetAllTracks
ListTracks --> DisplayTableRenderer.RenderTrackTable
ListTracks --> DocsTodoMd : "implicitly via get_all_tracks"

' Showing Tracks (Details)
ShowTrack --> CommandsTrack.ResolveTrackIdentifier
ShowTrack --> _ParseTodoSafe : "reads from Markdown"
ShowTrack --> GetSettings : "accesses settings for display"
ShowTrack --> DisplayTableRenderer : "uses for structured output"
ShowTrack --> DocsDoneMd : "reads done phases"
ShowTrackDetails --> CommandsTrack.ResolveTrackIdentifier
ShowTrackDetails --> _ParseTodoSafe
ShowTrackDetails --> DocsDoneMd

' Adding Track
AddTrack --> JsonStoreClass : "manages JSON storage"
AddTrack --> _SlugifyTrackId : "generates track ID"
AddTrack --> TrackClass : "creates Track object"
AddTrack --> JsonStoreClass.SaveTrack : "persists Track object"
AddTrack --> JsonStoreClass.LoadTrack : "checks for duplicates"

' Removing Track
RemoveTrack --> JsonStoreClass : "manages JSON storage"
RemoveTrack --> CommandsTrack.ResolveTrackIdentifier
RemoveTrack --> JsonStoreClass.LoadTrack
RemoveTrack --> JsonStoreClass.LoadIndex
RemoveTrack --> JsonStoreClass.SaveIndex
RemoveTrack --> FileSystem : "unlinks track's JSON file"

' Editing Track
EditTrack --> CommandsTrack.ResolveTrackIdentifier
EditTrack --> DataMarkdownWriter.ExtractTrackBlock : "extracts Markdown block"
EditTrack --> Subprocess : "opens $EDITOR"
Editor <--> EditTrack : "modifies content"
EditTrack --> DataMarkdownWriter.ReplaceTrackBlock : "updates Markdown block"
EditTrack --[#Red,dashed]-> DocsTodoMd

' Setting Track Status
SetTrackStatus --> CommandsTrack.ResolveTrackIdentifier
SetTrackStatus --> StatusUtils.NormalizeStatus
SetTrackStatus --> DataMarkdownWriter.UpdateTrackMetadata --[#Red,dashed]-> DocsTodoMd
SetTrackStatus --> DataMarkdownWriter.UpdateTrackHeadingStatus --[#Red,dashed]-> DocsTodoMd
SetTrackStatus --> StatusUtils.StatusBadge
SetTrackStatus --> StatusUtils.StatusTimestamp

' Setting Track Context
SetTrackContext --> CommandsTrack.ResolveTrackIdentifier
SetTrackContext --> GetSettings
SetTrackContext --> SettingsJson : "writes settings"

' AI Discussion
HandleTrackCommand --> CommandsDiscuss.HandleTrackDiscuss : "delegates AI discussion"

' Data Model interactions
TrackClass <.. TracksJsonStore : "managed by JsonStore"
DocsTodoMd <--> DataMarkdownWriter : "Markdown interface"
DocsTodoMd <--> CommandsTrack._ParseTodoSafe : "reads Markdown"
DocsTodoMd <--> CommandsTrack._EnsureTodoFile : "ensures existence"

' Persistence
DocsTodoMd <--> FileSystem
DocsDoneMd <--> FileSystem
MaestroTracksJson <--> FileSystem
MaestroTracksIndexJson <--> FileSystem
SettingsJson <--> FileSystem

@enduml
