@startuml cmd_phase_deep
!include _shared.puml

' Core Command Modules
' MODULE: MaestroMain, "maestro/main.py"
rectangle "main()" as MainEntry <<Function>>

' MODULE: CommandsPhase, "maestro/commands/phase.py"
rectangle "add_phase_parser()" as AddPhaseParser <<Function>>
rectangle "handle_phase_command()" as HandlePhaseCommand <<Function>>
rectangle "list_phases()" as ListPhases <<Function>>
rectangle "show_phase()" as ShowPhase <<Function>>
rectangle "add_phase()" as AddPhase <<Function>>
rectangle "remove_phase()" as RemovePhase <<Function>>
rectangle "edit_phase()" as EditPhase <<Function>>
rectangle "set_phase_status()" as SetPhaseStatus <<Function>>
rectangle "set_phase_context()" as SetPhaseContext <<Function>>
rectangle "_parse_todo_safe()" as _ParseTodoSafe <<Function>>
rectangle "_looks_like_phase_id()" as _LooksLikePhaseId <<Function>>
rectangle "_available_track_ids()" as _AvailableTrackIds <<Function>>
rectangle "_available_phase_ids()" as _AvailablePhaseIds <<Function>>

' Data Storage and Models
' MODULE: DataCommonUtils, "maestro/data/common_utils.py"
rectangle "get_all_tracks_with_phases_and_tasks()" as GetAllTracks <<Function>>
rectangle "resolve_identifier_by_type()" as ResolveIdentifierByType <<Function>>

' MODULE: DataMarkdown, "maestro/data/markdown_parser.py"
rectangle "parse_todo_md()" as ParseTodoMd <<Function>>
rectangle "parse_done_md()" as ParseDoneMd <<Function>>
rectangle "parse_phase_md()" as ParsePhaseMd <<Function>>
rectangle "parse_config_md()" as ParseConfigMd <<Function>>

' MODULE: DataMarkdownWriter, "maestro/data/markdown_writer.py"
rectangle "extract_phase_block()" as ExtractPhaseBlock <<Function>>
rectangle "insert_phase_block()" as InsertPhaseBlock <<Function>>
rectangle "remove_phase_block()" as RemovePhaseBlock <<Function>>
rectangle "replace_phase_block()" as ReplacePhaseBlock <<Function>>
rectangle "update_phase_metadata()" as UpdatePhaseMetadata <<Function>>
rectangle "update_phase_heading_status()" as UpdatePhaseHeadingStatus <<Function>>

' MODULE: TracksJsonStore, "maestro/tracks/json_store.py"
rectangle "JsonStore" as JsonStoreClass <<Class>>
rectangle "load_track()" as LoadTrack <<Function>>
rectangle "save_track()" as SaveTrack <<Function>>
rectangle "load_phase()" as LoadPhase <<Function>>
rectangle "save_phase()" as SavePhase <<Function>>
rectangle "list_all_tracks()" as ListAllTracks <<Function>>
rectangle "list_all_phases()" as ListAllPhases <<Function>>

' MODULE: TracksModels, "maestro/tracks/models.py"
rectangle "Phase" as PhaseClass <<Class>>
rectangle "Track" as TrackClass <<Class>>

' Display and Utility
' MODULE: DisplayTableRenderer, "maestro/display/table_renderer.py"
rectangle "render_phase_table()" as RenderPhaseTable <<Function>>

' MODULE: ConfigSettings, "maestro/config/settings.py"
rectangle "get_settings()" as GetSettings <<Function>>

' MODULE: StatusUtils, "maestro/commands/status_utils.py"
rectangle "normalize_status()" as NormalizeStatus <<Function>>
rectangle "allowed_statuses()" as AllowedStatuses <<Function>>
rectangle "status_badge()" as StatusBadge <<Function>>
rectangle "status_timestamp()" as StatusTimestamp <<Function>>

' MODULE: CommandsDiscuss, "maestro/commands/discuss.py"
rectangle "handle_phase_discuss()" as HandlePhaseDiscuss <<Function>>

' External Dependencies
rectangle "User's $EDITOR" as Editor <<Actor>>
rectangle "File System" as FileSystem <<Actor>>
rectangle "subprocess module" as Subprocess <<Actor>>

' Persistent Stores
rectangle "docs/todo.md" as DocsTodoMd <<Database>>
rectangle "docs/done.md" as DocsDoneMd <<Database>>
rectangle "docs/phases/<id>.md" as DocsPhasesMd <<Database>>
rectangle ".maestro/tracks/*.json" as MaestroTracksJson <<Database>>
rectangle "$HOME/.maestro/settings.json" as SettingsJson <<Database>>


' --- Relationships and Call Flow ---

' CLI Command Setup
MainEntry --> AddPhaseParser : "Adds 'phase' command and subparsers"

' Command Dispatch
HandlePhaseCommand -right-> ListPhases
HandlePhaseCommand -right-> ShowPhase
HandlePhaseCommand -right-> AddPhase
HandlePhaseCommand -right-> RemovePhase
HandlePhaseCommand -right-> EditPhase
HandlePhaseCommand -right-> SetPhaseStatus
HandlePhaseCommand -right-> SetPhaseContext
HandlePhaseCommand -right-> CommandsDiscuss.HandlePhaseDiscuss

' Phase Identification
CommandsPhase.HandlePhaseCommand --> CommandsPhase._LooksLikePhaseId : "validates phase ID"

' Listing Phases
ListPhases --> DataCommonUtils.GetAllTracks
ListPhases --> GetSettings : "uses current track context"
ListPhases --> DisplayTableRenderer.RenderPhaseTable
ListPhases --> DocsTodoMd : "implicitly via get_all_tracks"

' Showing Phases
ShowPhase --> FileSystem : "checks docs/phases/<id>.md existence"
ShowPhase --> DataMarkdown.ParsePhaseMd : "parses dedicated phase file"
ShowPhase --> _ParseTodoSafe : "parses docs/todo.md if no dedicated file"

' Adding Phase
AddPhase --> GetSettings : "gets current track if not specified"
AddPhase --> JsonStoreClass : "manages JSON storage"
AddPhase --> JsonStoreClass.LoadTrack : "ensures parent track exists"
AddPhase --> JsonStoreClass.LoadPhase : "checks for duplicates"
AddPhase --> TracksModels.PhaseClass : "creates Phase object"
AddPhase --> JsonStoreClass.SavePhase : "persists Phase object"
AddPhase --> JsonStoreClass.SaveTrack : "updates parent Track object"

' Removing Phase
RemovePhase --> JsonStoreClass : "manages JSON storage"
RemovePhase --> JsonStoreClass.LoadPhase : "gets phase details"
RemovePhase --> JsonStoreClass.LoadTrack : "loads parent track"
RemovePhase --> JsonStoreClass.SaveTrack : "updates parent track"
RemovePhase --> FileSystem : "unlinks phase's JSON file"

' Editing Phase
EditPhase --> FileSystem : "checks docs/phases/<id>.md existence"
EditPhase --> Subprocess : "opens editor for dedicated phase file"
Editor <--> EditPhase
EditPhase --> DataMarkdownWriter.ExtractPhaseBlock : "extracts Markdown block (from docs/todo.md)"
EditPhase --> Subprocess : "opens editor for extracted block"
EditPhase --> DataMarkdownWriter.ReplacePhaseBlock : "updates Markdown block"

' Setting Phase Status
SetPhaseStatus --> StatusUtils.NormalizeStatus
SetPhaseStatus --> JsonStoreClass : "manages JSON storage"
SetPhaseStatus --> JsonStoreClass.LoadPhase
SetPhaseStatus --> JsonStoreClass.SavePhase

' Setting Phase Context
SetPhaseContext --> _ParseTodoSafe : "finds phase in todo.md"
SetPhaseContext --> DataMarkdown.ParsePhaseMd : "finds phase in dedicated file"
SetPhaseContext --> GetSettings
SetPhaseContext --> SettingsJson : "writes settings"

' AI Discussion
HandlePhaseCommand --> CommandsDiscuss.HandlePhaseDiscuss : "delegates AI discussion"

' Data Model interactions
PhaseClass <.. TracksJsonStore : "managed by JsonStore"
DocsTodoMd <--> DataMarkdownWriter : "Markdown interface for todo.md"
DocsPhasesMd <--> DataMarkdownWriter : "Markdown interface for dedicated files"

' Persistence
DocsTodoMd <--> FileSystem
DocsPhasesMd <--> FileSystem
MaestroTracksJson <--> FileSystem : "(for phase.json, track.json)"
SettingsJson <--> FileSystem

@enduml
