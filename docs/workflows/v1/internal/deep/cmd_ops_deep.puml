@startuml cmd_ops_deep
!include _shared.puml

' Core Command Modules
' MODULE: MaestroMain, "maestro/main.py"
rectangle "main()" as MainEntry <<Function>>

' MODULE: ProjectOpsCommands, "maestro/project_ops/commands.py"
rectangle "add_project_ops_parser()" as AddProjectOpsParser <<Function>>
rectangle "handle_project_ops_validate()" as HandleProjectOpsValidate <<Function>>
rectangle "handle_project_ops_preview()" as HandleProjectOpsPreview <<Function>>
rectangle "handle_project_ops_apply()" as HandleProjectOpsApply <<Function>>

' Project Operations Data Model & Logic
' MODULE: ProjectOpsDecoder, "maestro/project_ops/decoder.py"
rectangle "decode_project_ops_json()" as DecodeProjectOpsJson <<Function>>
    EXCEPTION(DecodeError, "DecodeError")

' MODULE: ProjectOpsSchemas, "maestro/project_ops/schemas.py"
rectangle "validate_project_ops_result()" as ValidateProjectOpsResult <<Function>>

' MODULE: ProjectOpsTranslator, "maestro/project_ops/translator.py"
rectangle "actions_to_ops()" as ActionsToOps <<Function>>

' MODULE: ProjectOpsOperations, "maestro/project_ops/operations.py"
rectangle "CreateTrack" as CreateTrackClass <<Class>>
rectangle "CreatePhase" as CreatePhaseClass <<Class>>
rectangle "CreateTask" as CreateTaskClass <<Class>>
rectangle "MoveTaskToDone" as MoveTaskToDoneClass <<Class>>
rectangle "SetContext" as SetContextClass <<Class>>

' MODULE: ProjectOpsExecutor, "maestro/project_ops/executor.py"
rectangle "ProjectOpsExecutor" as ProjectOpsExecutorClass <<Class>>
rectangle "PreviewResult" as PreviewResultClass <<Class>>
rectangle "preview_ops()" as PreviewOps <<Function>>
rectangle "apply_ops()" as ApplyOps <<Function>>

' Data Storage and Markdown Writers
' MODULE: DataMarkdownWriter, "maestro/data/markdown_writer.py"
rectangle "insert_track_block()" as InsertTrackBlock <<Function>>
rectangle "insert_phase_block()" as InsertPhaseBlock <<Function>>
rectangle "insert_task_block()" as InsertTaskBlock <<Function>>
rectangle "update_task_metadata()" as UpdateTaskMetadata <<Function>>
rectangle "update_phase_metadata()" as UpdatePhaseMetadata <<Function>>
rectangle "update_track_metadata()" as UpdateTrackMetadata <<Function>>

' MODULE: TracksJsonStore, "maestro/tracks/json_store.py"
rectangle "JsonStore" as JsonStoreClass <<Class>>
rectangle "save_track()" as SaveTrack <<Function>>
rectangle "save_phase()" as SavePhase <<Function>>
rectangle "save_task()" as SaveTask <<Function>>
rectangle "load_track()" as LoadTrack <<Function>>
rectangle "load_phase()" as LoadPhase <<Function>>
rectangle "load_task()" as LoadTask <<Function>>
rectangle "load_index()" as LoadIndex <<Function>>
rectangle "save_index()" as SaveIndex <<Function>>

' MODULE: TracksModels, "maestro/tracks/models.py"
rectangle "Track" as TrackClass <<Class>>
rectangle "Phase" as PhaseClass <<Class>>
rectangle "Task" as TaskClass <<Class>>

' Utility Modules
' MODULE: MaestroUtils, "maestro/modules/utils.py"
    ' print_header, print_info, print_success, print_error, styled_print, Colors

' External Dependencies
rectangle "File System" as FileSystem <<Actor>>
rectangle "pathlib" as Pathlib <<Actor>>
rectangle "json module" as Json <<Actor>>


' --- Relationships and Call Flow ---

' CLI Command Setup
MainEntry --> ProjectOpsCommands.AddProjectOpsParser : "Adds 'ops' command and subparsers"

' Command Dispatch (from maestro.main.py)
HandleProjectOpsValidate <.. MainEntry : "for 'ops validate'"
HandleProjectOpsPreview <.. MainEntry : "for 'ops preview'"
HandleProjectOpsApply <.. MainEntry : "for 'ops apply'"


' Validation Flow
ProjectOpsCommands.HandleProjectOpsValidate --> ProjectOpsDecoder.DecodeProjectOpsJson
ProjectOpsDecoder.DecodeProjectOpsJson --> ProjectOpsSchemas.ValidateProjectOpsResult : "validates JSON schema"
ProjectOpsCommands.HandleProjectOpsValidate --> MaestroUtils : "prints success/error"

' Preview Flow
ProjectOpsCommands.HandleProjectOpsPreview --> ProjectOpsDecoder.DecodeProjectOpsJson
ProjectOpsCommands.HandleProjectOpsPreview --> ProjectOpsTranslator.ActionsToOps
ProjectOpsCommands.HandleProjectOpsPreview --> ProjectOpsExecutor.ProjectOpsExecutorClass.PreviewOps : "simulates changes"
ProjectOpsExecutor.ProjectOpsExecutorClass.PreviewOps --> ProjectOpsCommands.ProjectOpsOperations : "uses typed ops"
ProjectOpsExecutor.ProjectOpsExecutorClass.PreviewOps --> PreviewResultClass : "returns preview"
ProjectOpsCommands.HandleProjectOpsPreview --> MaestroUtils : "prints changes"

' Apply Flow
ProjectOpsCommands.HandleProjectOpsApply --> ProjectOpsDecoder.DecodeProjectOpsJson
ProjectOpsCommands.HandleProjectOpsApply --> ProjectOpsTranslator.ActionsToOps
ProjectOpsCommands.HandleProjectOpsApply --> ProjectOpsExecutor.ProjectOpsExecutorClass.ApplyOps : "applies changes"
ProjectOpsExecutor.ProjectOpsExecutorClass.ApplyOps --> ProjectOpsCommands.ProjectOpsOperations : "uses typed ops"
ProjectOpsExecutor.ProjectOpsExecutorClass.ApplyOps --> PreviewResultClass : "returns applied changes"

' Execution Details (within ProjectOpsExecutor.ApplyOps)
ProjectOpsExecutorClass.ApplyOps --> TracksJsonStore.JsonStoreClass : "initializes JSON store"
ProjectOpsExecutorClass.ApplyOps --> DataMarkdownWriter.InsertTrackBlock --[#Red,dashed]-> FileSystem : "creates track in docs/todo.md"
ProjectOpsExecutorClass.ApplyOps --> TracksJsonStore.SaveTrack --[#Red,dashed]-> FileSystem : "saves track JSON"
ProjectOpsExecutorClass.ApplyOps --> TracksJsonStore.SaveIndex --[#Red,dashed]-> FileSystem : "updates track index"
ProjectOpsExecutorClass.ApplyOps --> DataMarkdownWriter.InsertPhaseBlock --[#Red,dashed]-> FileSystem : "creates phase in docs/todo.md"
ProjectOpsExecutorClass.ApplyOps --> TracksJsonStore.SavePhase --[#Red,dashed]-> FileSystem : "saves phase JSON"
ProjectOpsExecutorClass.ApplyOps --> TracksJsonStore.LoadTrack : "loads track to update phases"
ProjectOpsExecutorClass.ApplyOps --> DataMarkdownWriter.InsertTaskBlock --[#Red,dashed]-> FileSystem : "creates task in docs/todo.md"
ProjectOpsExecutorClass.ApplyOps --> TracksJsonStore.SaveTask --[#Red,dashed]-> FileSystem : "saves task JSON"
ProjectOpsExecutorClass.ApplyOps --> TracksJsonStore.LoadPhase : "loads phase to update tasks"
ProjectOpsExecutorClass.ApplyOps --> DataMarkdownWriter.UpdateTaskMetadata --[#Red,dashed]-> FileSystem : "updates task status in docs/todo.md"
ProjectOpsExecutorClass.ApplyOps --> TracksJsonStore.LoadTask : "loads task to update status"
ProjectOpsExecutorClass.ApplyOps --> TracksJsonStore.SaveTask --[#Red,dashed]-> FileSystem : "saves updated task JSON"

' Data Model Interactions
ProjectOpsCommands.ProjectOpsOperations <.. ProjectOpsTranslator.ActionsToOps : "creates ops"
ProjectOpsCommands.ProjectOpsOperations <.. ProjectOpsExecutor.ProjectOpsExecutorClass : "processes ops"
TrackClass <.. ProjectOpsExecutor.ProjectOpsExecutorClass : "manages Track objects"
PhaseClass <.. ProjectOpsExecutor.ProjectOpsExecutorClass : "manages Phase objects"
TaskClass <.. ProjectOpsExecutor.ProjectOpsExecutorClass : "manages Task objects"

' Data Persistence
FileSystem <--> DocsTodoMd : "reads/writes Markdown files"
FileSystem <--> MaestroConvertDir : "reads/writes JSON store files for tracks/phases/tasks"

' Error Handling
DecodeError <.. ProjectOpsDecoder.DecodeProjectOpsJson
DecodeError <.. ProjectOpsTranslator.ActionsToOps
ProjectOpsExecutorClass --> ValueError : "on unknown op type or validation fail"
ProjectOpsExecutorClass --> RuntimeError : "on apply failure"

@enduml
