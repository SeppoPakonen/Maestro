@startuml cmd_task_deep
!include _shared.puml

' Core Command Modules
' MODULE: MaestroMain, "maestro/main.py"
rectangle "main()" as MainEntry <<Function>>

' MODULE: CommandsTask, "maestro/commands/task.py"
rectangle "add_task_parser()" as AddTaskParser <<Function>>
rectangle "handle_task_command()" as HandleTaskCommand <<Function>>
rectangle "list_tasks()" as ListTasks <<Function>>
rectangle "show_task()" as ShowTask <<Function>>
rectangle "add_task()" as AddTask <<Function>>
rectangle "remove_task()" as RemoveTask <<Function>>
rectangle "edit_task()" as EditTask <<Function>>
rectangle "set_task_status()" as SetTaskStatus <<Function>>
rectangle "set_task_context()" as SetTaskContext <<Function>>
rectangle "_collect_task_entries()" as _CollectTaskEntries <<Function>>
rectangle "_resolve_task_identifier()" as _ResolveTaskIdentifier <<Function>>
rectangle "_parse_task_list_filters()" as _ParseTaskListFilters <<Function>>
rectangle "_find_task_file()" as _FindTaskFile <<Function>>
rectangle "_normalize_task_status()" as _NormalizeTaskStatus <<Function>>

' Data Storage and Models
' MODULE: DataCommonUtils, "maestro/data/common_utils.py"
rectangle "get_all_tracks_with_phases_and_tasks()" as GetAllTracks <<Function>>
rectangle "resolve_identifier_by_type()" as ResolveIdentifierByType <<Function>>

' MODULE: DataMarkdown, "maestro/data/markdown_parser.py"
rectangle "parse_todo_md()" as ParseTodoMd <<Function>>
rectangle "parse_done_md()" as ParseDoneMd <<Function>>
rectangle "parse_phase_md()" as ParsePhaseMd <<Function>>
rectangle "parse_config_md()" as ParseConfigMd <<Function>>

' MODULE: DataMarkdownWriter, "maestro/data/markdown_writer.py"
rectangle "extract_task_block()" as ExtractTaskBlock <<Function>>
rectangle "replace_task_block()" as ReplaceTaskBlock <<Function>>
rectangle "extract_phase_block()" as ExtractPhaseBlock <<Function>> ' For _insert_task_in_todo
rectangle "replace_phase_block()" as ReplacePhaseBlock <<Function>> ' For _insert_task_in_todo

' MODULE: TracksJsonStore, "maestro/tracks/json_store.py"
rectangle "JsonStore" as JsonStoreClass <<Class>>
rectangle "list_all_tracks()" as ListAllTracks <<Function>>
rectangle "load_track()" as LoadTrack <<Function>>
rectangle "load_archive()" as LoadArchive <<Function>>
rectangle "list_all_phases()" as ListAllPhases <<Function>>
rectangle "load_phase()" as LoadPhase <<Function>>
rectangle "save_phase()" as SavePhase <<Function>>
rectangle "load_task()" as LoadTask <<Function>>
rectangle "save_task()" as SaveTask <<Function>>

' MODULE: TracksModels, "maestro/tracks/models.py"
rectangle "Task" as TaskClass <<Class>>
rectangle "Phase" as PhaseClass <<Class>>
rectangle "Track" as TrackClass <<Class>>

' Display and Utility
' MODULE: DisplayTableRenderer, "maestro/display/table_renderer.py"
rectangle "render_task_table()" as RenderTaskTable <<Function>>

' MODULE: ConfigSettings, "maestro/config/settings.py"
rectangle "get_settings()" as GetSettings <<Function>>

' MODULE: StatusUtils, "maestro/commands/status_utils.py"
rectangle "normalize_status()" as NormalizeStatus <<Function>>
rectangle "allowed_statuses()" as AllowedStatuses <<Function>>
rectangle "status_badge()" as StatusBadge <<Function>>
rectangle "status_timestamp()" as StatusTimestamp <<Function>>

' MODULE: CommandsDiscuss, "maestro/commands/discuss.py"
rectangle "handle_task_discuss()" as HandleTaskDiscuss <<Function>>

' External Dependencies
rectangle "User's $EDITOR" as Editor <<Actor>>
rectangle "File System" as FileSystem <<Actor>>
rectangle "subprocess module" as Subprocess <<Actor>>

' Persistent Stores
rectangle "docs/phases/<id>.md" as DocsPhasesMd <<Database>>
rectangle ".maestro/tracks/*.json" as MaestroTracksJson <<Database>>
rectangle ".maestro/tracks/tasks/*.json" as MaestroTasksJson <<Database>>
rectangle "$HOME/.maestro/settings.json" as SettingsJson <<Database>>


' --- Relationships and Call Flow ---

' CLI Command Setup
MainEntry --> AddTaskParser : "Adds 'task' command and subparsers"

' Command Dispatch
HandleTaskCommand -down-> ListTasks
HandleTaskCommand -down-> ShowTask
HandleTaskCommand -down-> AddTask
HandleTaskCommand -down-> RemoveTask
HandleTaskCommand -down-> EditTask
HandleTaskCommand -down-> SetTaskStatus
HandleTaskCommand -down-> SetTaskContext
HandleTaskCommand -down-> CommandsDiscuss.HandleTaskDiscuss

' Task Data Collection (Unified)
_CollectTaskEntries --> JsonStoreClass : "loads tasks from JSON store"
_CollectTaskEntries --> TracksModels.TrackClass : "uses Track/Phase/Task models"
_CollectTaskEntries --> TracksModels.PhaseClass
_CollectTaskEntries --> TracksModels.TaskClass

' Task Identification & Filtering
CommandsTask._ParseTaskListFilters <.. ListTasks
CommandsTask._ResolveTaskIdentifier <.. ShowTask
CommandsTask._ResolveTaskIdentifier <.. EditTask
CommandsTask._FindTaskFile <.. EditTask

' Listing Tasks
ListTasks --> _CollectTaskEntries
ListTasks --> DisplayTableRenderer.RenderTaskTable

' Showing Tasks
ShowTask --> _ResolveTaskIdentifier
ShowTask --> GetSettings
ShowTask --> DisplayTableRenderer : "uses _status_display"

' Adding Task
AddTask --> GetSettings : "gets current phase if not specified"
AddTask --> JsonStoreClass : "manages JSON storage"
AddTask --> JsonStoreClass.LoadPhase : "ensures parent phase exists"
AddTask --> JsonStoreClass.LoadTask : "checks for duplicates"
AddTask --> TracksModels.TaskClass : "creates Task object"
AddTask --> JsonStoreClass.SaveTask : "persists Task object"
AddTask --> JsonStoreClass.SavePhase : "updates parent Phase object"

' Removing Task
RemoveTask --> JsonStoreClass : "manages JSON storage"
RemoveTask --> JsonStoreClass.LoadTask : "gets task details"
RemoveTask --> JsonStoreClass.LoadPhase : "loads parent phase"
RemoveTask --> JsonStoreClass.SavePhase : "updates parent phase"
RemoveTask --> FileSystem : "unlinks task's JSON file"

' Editing Task (Markdown)
EditTask --> _FindTaskFile
EditTask --> DataMarkdownWriter.ExtractTaskBlock : "extracts Markdown block"
EditTask --> Subprocess : "opens $EDITOR"
Editor <--> EditTask
EditTask --> DataMarkdownWriter.ReplaceTaskBlock : "updates Markdown block"
EditTask --[#Red,dashed]-> DocsPhasesMd

' Setting Task Status
SetTaskStatus --> StatusUtils.NormalizeStatus
SetTaskStatus --> JsonStoreClass : "manages JSON storage"
SetTaskStatus --> JsonStoreClass.LoadTask
SetTaskStatus --> JsonStoreClass.SaveTask

' Setting Task Context
SetTaskContext --> GetSettings
SetTaskContext --> SettingsJson : "writes settings"

' AI Discussion
HandleTaskCommand --> CommandsDiscuss.HandleTaskDiscuss : "delegates AI discussion"

' Data Model interactions
TaskClass <.. TracksJsonStore : "managed by JsonStore"
DocsPhasesMd <--> DataMarkdownWriter : "Markdown interface for phase files"

' Persistence
DocsPhasesMd <--> FileSystem
MaestroTasksJson <--> FileSystem
MaestroTracksJson <--> FileSystem : "(for phase.json)"
SettingsJson <--> FileSystem

@enduml
