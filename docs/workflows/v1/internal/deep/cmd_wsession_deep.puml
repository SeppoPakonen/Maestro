@startuml cmd_wsession_deep
!include _shared.puml

' Core Command Modules
' MODULE: MaestroMain, "maestro/main.py"
rectangle "main()" as MainEntry <<Function>>

' MODULE: CommandsWSession, "maestro/commands/work_session.py"
rectangle "add_wsession_parser()" as AddWSessionParser <<Function>>
rectangle "handle_wsession_list()" as HandleWSessionList <<Function>>
rectangle "handle_wsession_show()" as HandleWSessionShow <<Function>>
rectangle "handle_wsession_tree()" as HandleWSessionTree <<Function>>
rectangle "handle_wsession_breadcrumbs()" as HandleWSessionBreadcrumbs <<Function>>
rectangle "handle_wsession_timeline()" as HandleWSessionTimeline <<Function>>
rectangle "handle_wsession_stats()" as HandleWSessionStats <<Function>>
rectangle "_resolve_session_id()" as _ResolveSessionId <<Function>>
rectangle "export_session_json()" as ExportSessionJson <<Function>>
rectangle "export_session_markdown()" as ExportSessionMarkdown <<Function>>
rectangle "_filter_hierarchy_by_status()" as _FilterHierarchyByStatus <<Function>>
rectangle "_print_breadcrumb_counts()" as _PrintBreadcrumbCounts <<Function>>

' Work Session Subsystem
' MODULE: WorkSessionModule, "maestro/work_session.py"
rectangle "WorkSession" as WorkSessionClass <<Class>>
rectangle "list_sessions()" as ListSessions <<Function>>
rectangle "load_session()" as LoadSession <<Function>>
rectangle "get_session_hierarchy()" as GetSessionHierarchy <<Function>>
rectangle "create_session()" as CreateSession <<Function>>

' MODULE: BreadcrumbModule, "maestro/breadcrumb.py"
rectangle "Breadcrumb" as BreadcrumbClass <<Class>>
rectangle "list_breadcrumbs()" as ListBreadcrumbs <<Function>>
rectangle "get_breadcrumb_summary()" as GetBreadcrumbSummary <<Function>>
rectangle "reconstruct_session_timeline()" as ReconstructSessionTimeline <<Function>>

' MODULE: VisualizationModule, "maestro/visualization"
rectangle "tree.SessionTreeRenderer" as SessionTreeRendererClass <<Class>>
rectangle "table.SessionTableFormatter" as SessionTableFormatterClass <<Class>>
rectangle "detail.SessionDetailFormatter" as SessionDetailFormatterClass <<Class>>

' MODULE: StatsModule, "maestro/stats/session_stats.py"
rectangle "SessionStats" as SessionStatsClass <<Class>>
rectangle "calculate_session_stats()" as CalculateSessionStats <<Function>>
rectangle "calculate_tree_stats()" as CalculateTreeStats <<Function>>

' Utility Modules
package "pathlib" as Pathlib <<Module>>
package "json" as Json <<Module>>
package "logging" as Logging <<Module>>
package "sys" as Sys <<Module>>
package "datetime" as DateTime <<Module>>

' External Dependencies
rectangle "File System" as FileSystem <<Actor>>

' Persistent Stores
rectangle "docs/sessions/" as DocsSessionsDir <<Database>>
    <session-id>/session.json
    <session-id>/breadcrumbs.jsonl


' --- Relationships and Call Flow ---

' CLI Command Setup
MainEntry --> AddWSessionParser : "Adds 'wsession' command and subparsers"

' Command Dispatch
MainEntry --> CommandsWSession : "Delegates to handle_wsession_*"

' List Sessions (`wsession list`)
HandleWSessionList --> WorkSessionModule.ListSessions : "retrieves sessions based on filters"
WorkSessionModule.ListSessions --> DocsSessionsDir : "reads session.json files"
HandleWSessionList --> VisualizationModule.SessionTableFormatterClass.format_table : "renders sessions in table"

' Show Session Details (`wsession show`)
HandleWSessionShow --> CommandsWSession._ResolveSessionId : "resolves session ID"
HandleWSessionShow --> WorkSessionModule.LoadSession : "loads specific session data"
HandleWSessionShow --> VisualizationModule.SessionDetailFormatterClass.format_details : "renders detailed view"
HandleWSessionShow --> CommandsWSession.ExportSessionJson --[#Red,dashed]-> FileSystem : "exports to JSON"
CommandsWSession.ExportSessionJson --> BreadcrumbModule.ListBreadcrumbs : "includes breadcrumbs"
CommandsWSession.ExportSessionJson --> StatsModule.CalculateSessionStats : "includes stats"
CommandsWSession.ExportSessionJson --> WorkSessionModule.ListSessions : "includes child sessions"
HandleWSessionShow --> CommandsWSession.ExportSessionMarkdown --[#Red,dashed]-> FileSystem : "exports to Markdown"
CommandsWSession.ExportSessionMarkdown --> BreadcrumbModule.ListBreadcrumbs
CommandsWSession.ExportSessionMarkdown --> StatsModule.CalculateSessionStats

' Session Tree (`wsession tree`)
HandleWSessionTree --> WorkSessionModule.GetSessionHierarchy : "builds session hierarchy"
WorkSessionModule.GetSessionHierarchy --> DocsSessionsDir : "reads session data"
HandleWSessionTree --> CommandsWSession._FilterHierarchyByStatus : "applies status filter"
HandleWSessionTree --> VisualizationModule.SessionTreeRendererClass.render : "renders tree"
HandleWSessionTree --> CommandsWSession._PrintBreadcrumbCounts : "displays breadcrumb counts"

' Breadcrumbs (`wsession breadcrumbs`)
HandleWSessionBreadcrumbs --> CommandsWSession._ResolveSessionId
HandleWSessionBreadcrumbs --> BreadcrumbModule.GetBreadcrumbSummary : "gets summary"
HandleWSessionBreadcrumbs --> BreadcrumbModule.ListBreadcrumbs : "lists detailed breadcrumbs"
BreadcrumbModule.ListBreadcrumbs --> DocsSessionsDir : "reads breadcrumbs.jsonl files"

' Timeline (`wsession timeline`)
HandleWSessionTimeline --> CommandsWSession._ResolveSessionId
HandleWSessionTimeline --> BreadcrumbModule.ReconstructSessionTimeline : "reconstructs timeline events"
BreadcrumbModule.ReconstructSessionTimeline --> DocsSessionsDir : "reads breadcrumbs.jsonl files"

' Statistics (`wsession stats`)
HandleWSessionStats --> CommandsWSession._ResolveSessionId
HandleWSessionStats --> WorkSessionModule.LoadSession
HandleWSessionStats --> StatsModule.CalculateSessionStats : "calculates stats for single session"
HandleWSessionStats --> StatsModule.CalculateTreeStats : "calculates stats for session tree"
HandleWSessionStats --> VisualizationModule.SessionDetailFormatterClass.format_statistics : "renders stats"
HandleWSessionStats --> WorkSessionModule.ListSessions : "for aggregate stats"

' Helper Interactions
CommandsWSession._ResolveSessionId --> WorkSessionModule.ListSessions : "to find 'latest'"
CommandsWSession --> Pathlib
CommandsWSession --> Json
CommandsWSession --> Logging
CommandsWSession --> Sys
CommandsWSession --> DateTime

' Data Model interactions
WorkSessionClass <.. WorkSessionModule.ListSessions
WorkSessionClass <.. WorkSessionModule.LoadSession
BreadcrumbClass <.. BreadcrumbModule.ListBreadcrumbs
SessionStatsClass <.. StatsModule.CalculateSessionStats

@enduml