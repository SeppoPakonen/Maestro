# Command: `ops`

## 1. Command Surface

*   **Command:** `ops`
*   **Aliases:** None
*   **Handler Binding:** `maestro.main.main` dispatches to `maestro.project_ops.commands.handle_project_ops_validate`, `handle_project_ops_preview`, `handle_project_ops_apply`.

## 2. Entrypoint(s)

*   **Primary Dispatchers:** `maestro.project_ops.commands.handle_project_ops_validate(json_file, session_path, verbose)`, `handle_project_ops_preview(json_file, session_path, verbose)`, `handle_project_ops_apply(json_file, session_path, verbose)`.
*   **File Path:** `/home/sblo/Dev/Maestro/maestro/project_ops/commands.py`

## 3. Call Chain (ordered)

The `ops` command operates on AI-generated "Project Operations," providing tools to validate, preview, and apply structural changes to the project.

### Common Flow for `ops` subcommands

1.  `maestro.main.main()` → `maestro.project_ops.commands.add_project_ops_parser()`
    *   **Purpose:** Registers the `ops` command and its `validate`, `preview`, `apply` subcommands.
2.  `maestro.main.main()` → (dispatches to specific `handle_project_ops_*` function based on `args.ops_subcommand`)
    *   **Purpose:** Executes the logic for the respective `ops` subcommand.
3.  Reads the `json_file` content.
4.  `maestro.project_ops.decoder.decode_project_ops_json(content)`
    *   **Purpose:** Parses and strictly validates the JSON content against the `ProjectOpsResult` schema.
    *   **Internal Call Chain:** `maestro.project_ops.schemas.validate_project_ops_result(content_dict)`.
5.  `maestro.project_ops.translator.actions_to_ops(project_ops_result)`
    *   **Purpose:** Converts the validated JSON actions into a list of strongly-typed `maestro.project_ops.operations` objects.
6.  `maestro.project_ops.executor.ProjectOpsExecutor()`
    *   **Purpose:** Initializes the executor responsible for applying changes.
7.  `print()` statements provide user feedback.

### `maestro ops validate <file.json>`

1.  ... → `maestro.project_ops.commands.handle_project_ops_validate(json_file, ...)`
2.  Performs JSON decoding and validation.
3.  Prints success or detailed error messages.

### `maestro ops preview <file.json>`

1.  ... → `maestro.project_ops.commands.handle_project_ops_preview(json_file, ...)`
2.  `maestro.project_ops.executor.ProjectOpsExecutor().preview_ops(ops)`
    *   **Purpose:** Simulates applying the operations without modifying the actual project files.
3.  Prints the proposed `changes`, `before_state`, and `after_state`.

### `maestro ops apply <file.json>`

1.  ... → `maestro.project_ops.commands.handle_project_ops_apply(json_file, ...)`
2.  `maestro.project_ops.executor.ProjectOpsExecutor().apply_ops(ops, dry_run=False)`
    *   **Purpose:** Applies the operations, modifying project files (e.g., `docs/todo.md`, `.maestro/tracks/*.json`).
3.  Prints the summary of `changes` applied.

## 4. Core Data Model Touchpoints

*   **Reads:**
    *   The specified `json_file` containing `ProjectOpsResult` (typically generated by AI during `maestro plan explore`).
    *   `docs/todo.md` and `.maestro/tracks/*.json` (implicitly by `ProjectOpsExecutor` during preview/apply).
*   **Writes:**
    *   `docs/todo.md` and `.maestro/tracks/*.json` are modified by `ProjectOpsExecutor().apply_ops()`.
*   **Schema:** `ProjectOpsResult` JSON adheres to the schema defined in `maestro.project_ops.schemas.py`.

## 5. Configuration & Globals

*   `session_path`: Optional argument, likely passed to underlying modules but not directly used in this command file.

## 6. Validation & Assertion Gates

*   **JSON Schema Validation:** `decode_project_ops_json` strictly validates the input JSON.
*   **File Existence:** Checks if the `json_file` exists.
*   **Scope Check:** `actions_to_ops` ensures the `scope` is "project".
*   **Action Argument Validation:** `actions_to_ops` checks for required arguments for each action type.
*   `ProjectOpsExecutor` performs further checks (e.g., track already exists) before applying changes.

## 7. Side Effects

*   **Validation:** Validates `ProjectOpsResult` JSON.
*   **Preview:** Describes potential changes to the project structure.
*   **Application:** Modifies project Markdown files (`docs/todo.md`) and JSON files (`.maestro/tracks/*.json`).
*   Prints status, preview, and results to the console.

## 8. Error Semantics

*   `print_error` for errors, `sys.exit(1)` for critical failures (e.g., file not found, validation failed, unexpected error).
*   `DecodeError` for JSON decoding/validation failures.
*   `ValueError` or `RuntimeError` from `ProjectOpsExecutor` for application failures.

## 9. Existing Tests & Coverage Gaps

*   **Tests:**
    *   `maestro/tests/project_ops/commands/test_ops_commands.py` (or similar) should cover the CLI command behavior.
    *   Unit tests for `decoder.py`, `translator.py`, `executor.py`, `schemas.py`, `operations.py` (in `maestro/project_ops/`).
    *   Integration tests covering:
        *   Successful validation, preview, and application of various `ProjectOpsResult` JSONs.
        *   Error handling for invalid JSON, missing files, and application failures.
        *   Verifying actual file system changes after `apply`.
*   **Coverage Gaps:**
    *   Comprehensive testing of all possible `ProjectOpsResult` action types and their arguments.
    *   Robustness testing against malformed JSON input or unexpected project states.
    *   Testing of `preview_ops` and `apply_ops` in complex project structures with many tracks, phases, tasks.
    *   Ensuring atomicity and transactional integrity during `apply_ops` (if multiple changes are involved).
