@startuml cmd_settings_deep
!include _shared.puml

' Core Command Modules
' MODULE: MaestroMain, "maestro/main.py"
rectangle "main()" as MainEntry <<Function>>

' MODULE: CommandsSettings, "maestro/commands/settings.py"
rectangle "add_settings_parser()" as AddSettingsParser <<Function>>
rectangle "handle_settings_command()" as HandleSettingsCommand <<Function>>
rectangle "list_settings()" as ListSettings <<Function>>
rectangle "get_setting()" as GetSetting <<Function>>
rectangle "set_setting()" as SetSetting <<Function>>
rectangle "edit_settings()" as EditSettings <<Function>>
rectangle "reset_settings()" as ResetSettings <<Function>>
rectangle "settings_wizard()" as SettingsWizard <<Function>>
rectangle "format_value_for_display()" as FormatValueForDisplay <<Function>>
rectangle "convert_value_to_type()" as ConvertValueToType <<Function>>
    ' Profile handlers
rectangle "profile_list()" as ProfileList <<Function>>
rectangle "profile_save()" as ProfileSave <<Function>>
rectangle "profile_load()" as ProfileLoad <<Function>>
rectangle "profile_get()" as ProfileGet <<Function>>
rectangle "profile_set_default()" as ProfileSetDefault <<Function>>

' Configuration Modules
' MODULE: ConfigSettings, "maestro/config/settings.py"
rectangle "Settings" as SettingsClass <<Class>>
rectangle "get_settings()" as GetSettings <<Function>>
rectangle "create_default_config()" as CreateDefaultConfig <<Function>>
rectangle "load()" as SettingsLoad <<Function>>
rectangle "save()" as SettingsSave <<Function>>
rectangle "get()" as SettingsGet <<Function>>
rectangle "set()" as SettingsSet <<Function>>
rectangle "validate()" as SettingsValidate <<Function>>

' MODULE: ConfigProfiles, "maestro/config/settings_profiles.py"
rectangle "SettingsProfileManager" as SettingsProfileManagerClass <<Class>>
rectangle "list_profiles()" as ListProfiles <<Function>>
rectangle "get_active_profile()" as GetActiveProfile <<Function>>
rectangle "get_default_profile()" as GetDefaultProfile <<Function>>
rectangle "update_profile()" as UpdateProfile <<Function>>
rectangle "create_profile()" as CreateProfile <<Function>>
rectangle "set_active_profile()" as SetActiveProfile <<Function>>
rectangle "set_default_profile()" as SetDefaultProfile <<Function>>
rectangle "load_profile()" as LoadProfile <<Function>>
rectangle "has_unsaved_changes()" as HasUnsavedChanges <<Function>>
rectangle "get_settings_hash()" as GetSettingsHash <<Function>>
rectangle "create_audit_log()" as CreateAuditLog <<Function>>

' Utility Modules
' MODULE: DataMarkdown, "maestro/data/markdown_parser.py"
rectangle "parse_config_md()" as ParseConfigMd <<Function>>

' MODULE: MaestroUtils, "maestro/modules/utils.py"
    ' Console print functions, Colors

' External Dependencies
rectangle "User's $EDITOR" as Editor <<Actor>>
rectangle "File System" as FileSystem <<Actor>>
rectangle "subprocess module" as Subprocess <<Actor>>

' Persistent Stores
rectangle "docs/config.md" as DocsConfigMd <<Database>>
rectangle "~/.maestro/profiles.json" as ProfilesJson <<Database>>
rectangle "~/.maestro/profiles/<id>.json" as ProfileSettingsJson <<Database>>
rectangle "~/.maestro/profiles/audit.jsonl" as ProfileAuditJsonL <<Database>>


' --- Relationships and Call Flow ---

' CLI Command Setup
MainEntry --> AddSettingsParser : "Adds 'settings' command and subparsers"

' Command Dispatch
HandleSettingsCommand --> ListSettings
HandleSettingsCommand --> GetSetting
HandleSettingsCommand --> SetSetting
HandleSettingsCommand --> EditSettings
HandleSettingsCommand --> ResetSettings
HandleSettingsCommand --> SettingsWizard
HandleSettingsCommand --> ProfileList : "profile subcommands"
HandleSettingsCommand --> ProfileSave
HandleSettingsCommand --> ProfileLoad
HandleSettingsCommand --> ProfileGet
HandleSettingsCommand --> ProfileSetDefault

' Settings Object Interaction
ListSettings --> ConfigSettings.GetSettings
GetSetting --> ConfigSettings.GetSettings
SetSetting --> ConfigSettings.GetSettings
SetSetting --> SettingsClass.Set
SetSetting --> SettingsClass.Validate
SetSetting --> SettingsClass.Save
EditSettings --> ConfigSettings.GetSettings
EditSettings --> ConfigSettings.CreateDefaultConfig : "if config file missing"
EditSettings --> SettingsClass.Load
EditSettings --> SettingsClass.Validate
ResetSettings --> ConfigSettings.GetSettings
ResetSettings --> ConfigSettings.CreateDefaultConfig
SettingsWizard --> ConfigSettings.CreateDefaultConfig
SettingsWizard --> SettingsClass.Save

' Profile Manager Interaction
SetSetting --> ConfigProfiles.SettingsProfileManagerClass.GetSettingsHash : "detect changes"
ResetSettings --> ConfigProfiles.SettingsProfileManagerClass.GetSettingsHash
SettingsWizard --> ConfigProfiles.SettingsProfileManagerClass.GetSettingsHash

ProfileList --> ConfigProfiles.SettingsProfileManagerClass.ListProfiles
ProfileList --> ConfigProfiles.SettingsProfileManagerClass.GetActiveProfile
ProfileList --> ConfigProfiles.SettingsProfileManagerClass.GetDefaultProfile

ProfileSave --> ConfigProfiles.SettingsProfileManagerClass.CreateProfile
ProfileSave --> ConfigProfiles.SettingsProfileManagerClass.UpdateProfile
ProfileSave --> ConfigProfiles.SettingsProfileManagerClass.SetDefaultProfile
ProfileSave --> ConfigProfiles.SettingsProfileManagerClass.SetActiveProfile

ProfileLoad --> ConfigProfiles.SettingsProfileManagerClass.LoadProfile
ProfileLoad --> ConfigProfiles.SettingsProfileManagerClass.HasUnsavedChanges
ProfileLoad --> ConfigProfiles.SettingsProfileManagerClass.CreateAuditLog

ProfileGet --> ConfigProfiles.SettingsProfileManagerClass.GetActiveProfile

ProfileSetDefault --> ConfigProfiles.SettingsProfileManagerClass.SetDefaultProfile


' File System & External Interaction

ConfigSettings.GetSettings -[dashed]-> DocsConfigMd : "reads/loads settings"
SettingsClass.Save --[#Red,dashed]-> DocsConfigMd : "writes/updates settings"
SettingsClass.Load -[dashed]-> DocsConfigMd : "loads settings"

EditSettings --> Subprocess : "invokes external editor"
Editor <--> EditSettings : "modifies docs/config.md"

SettingsProfileManagerClass --> ProfilesJson : "manages profile metadata"
SettingsProfileManagerClass --> ProfileSettingsJson : "manmanages profile settings content"
SettingsProfileManagerClass --> ProfileAuditJsonL : "writes audit log"

' Data Conversion and Formatting
SetSetting --> CommandsSettings.ConvertValueToType
ListSettings --> CommandsSettings.FormatValueForDisplay
GetSetting --> CommandsSettings.FormatValueForDisplay

@enduml
