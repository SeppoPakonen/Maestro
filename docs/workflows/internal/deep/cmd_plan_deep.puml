@startuml cmd_plan_deep
!include _shared.puml

' Core Command Modules
' MODULE: MaestroMain, "maestro/main.py"
rectangle "main()" as MainEntry <<Function>>

' MODULE: CommandsPlan, "maestro/commands/plan.py"
rectangle "add_plan_parser()" as AddPlanParser <<Function>>
rectangle "handle_plan_add()" as HandlePlanAdd <<Function>>
rectangle "handle_plan_list()" as HandlePlanList <<Function>>
rectangle "handle_plan_remove()" as HandlePlanRemove <<Function>>
rectangle "handle_plan_show()" as HandlePlanShow <<Function>>
rectangle "handle_plan_add_item()" as HandlePlanAddItem <<Function>>
rectangle "handle_plan_remove_item()" as HandlePlanRemoveItem <<Function>>
rectangle "handle_plan_discuss()" as HandlePlanDiscuss <<Function>>
rectangle "handle_plan_explore()" as HandlePlanExplore <<Function>>
rectangle "create_explore_prompt()" as CreateExplorePrompt <<Function>>

' Plan Data Model & Persistence
' MODULE: PlansModule, "maestro/plans.py"
rectangle "PlanStore" as PlanStoreClass <<Class>>
rectangle "Plan" as PlanClass <<Class>>
rectangle "PlanItem" as PlanItemClass <<Class>>
    PlanStoreClass "1" *-- "0..*" PlanClass : "manages"
    PlanClass "1" *-- "0..*" PlanItemClass : "contains"

' Plan Operations (AI-generated changes to plans)
' MODULE: PlanOpsCommands, "maestro/plan_ops/commands.py"
rectangle "add_plan_ops_parser()" as AddPlanOpsParser <<Function>>
rectangle "handle_plan_ops_validate()" as HandlePlanOpsValidate <<Function>>
rectangle "handle_plan_ops_preview()" as HandlePlanOpsPreview <<Function>>
rectangle "handle_plan_ops_apply()" as HandlePlanOpsApply <<Function>>

' MODULE: PlanOpsDecoder, "maestro/plan_ops/decoder.py"
rectangle "decode_plan_ops_json()" as DecodePlanOpsJson <<Function>>
    EXCEPTION(DecodeError, "DecodeError")

' MODULE: PlanOpsSchemas, "maestro/plan_ops/schemas.py"
rectangle "validate_plan_ops_result()" as ValidatePlanOpsResult <<Function>>

' MODULE: PlanOpsTranslator, "maestro/plan_ops/translator.py"
rectangle "actions_to_ops()" as ActionsToOps <<Function>>

' MODULE: PlanOpsOperations, "maestro/plan_ops/operations.py"
rectangle "Selector" as SelectorClass <<Class>>
rectangle "CreatePlan" as CreatePlanClass <<Class>>
rectangle "DeletePlan" as DeletePlanClass <<Class>>
rectangle "AddPlanItem" as AddPlanItemClass <<Class>>
rectangle "RemovePlanItem" as RemovePlanItemClass <<Class>>
rectangle "Commentary" as CommentaryClass <<Class>>

' MODULE: PlanOpsExecutor, "maestro/plan_ops/executor.py"
rectangle "PlanOpsExecutor" as PlanOpsExecutorClass <<Class>>
rectangle "PreviewResult" as PreviewResultClass <<Class>>
rectangle "preview_ops()" as PreviewOps <<Function>>
rectangle "apply_ops()" as ApplyOps <<Function>>

' Plan Explore (Iterative AI Planning)
' MODULE: PlanExploreSession, "maestro/plan_explore/session.py"
rectangle "ExploreSession" as ExploreSessionClass <<Class>>
rectangle "ExploreIteration" as ExploreIterationClass <<Class>>
rectangle "ExploreIterationStatus" as ExploreIterationStatus <<Enum>>
rectangle "create_explore_session()" as CreateExploreSession <<Function>>
rectangle "load_explore_session()" as LoadExploreSession <<Function>>
rectangle "save_explore_session()" as SaveExploreSession <<Function>>
rectangle "add_iteration_to_session()" as AddIterationToSession <<Function>>
rectangle "resume_explore_session()" as ResumeExploreSession <<Function>>
rectangle "interrupt_explore_session()" as InterruptExploreSession <<Function>>
rectangle "complete_explore_session()" as CompleteExploreSession <<Function>>

' AI Integration
' MODULE: AiManagerModule, "maestro/ai/manager.py"
rectangle "AiEngineManager" as AiEngineManagerClass <<Class>>

' MODULE: AiChatModule, "maestro/ai/chat.py"
rectangle "run_interactive_chat()" as RunInteractiveChat <<Function>>

' MODULE: AiTypesModule, "maestro/ai/types.py"
rectangle "PromptRef" as PromptRefClass <<Class>>
rectangle "RunOpts" as RunOptsClass <<Class>>

' Project Operations (from Explore)
' MODULE: ProjectOpsDecoder, "maestro/project_ops/decoder.py"
rectangle "decode_project_ops_json()" as DecodeProjectOpsJson <<Function>>

' MODULE: ProjectOpsTranslator, "maestro/project_ops/translator.py"
rectangle "actions_to_ops()" as ActionsToOpsProj <<Function>>

' MODULE: ProjectOpsExecutor, "maestro/project_ops/executor.py"
rectangle "ProjectOpsExecutor" as ProjectOpsExecutorClass <<Class>>

' Other Maestro Modules
' MODULE: DataMarkdownParser, "maestro/data/markdown_parser.py"
rectangle "parse_todo_md()" as ParseTodoMd <<Function>>

' MODULE: ConfigSettings, "maestro/config/settings.py"
rectangle "get_settings()" as GetSettings <<Function>>

' MODULE: MaestroUtils, "maestro/modules/utils.py"
    ' Console print functions, Colors

' External Dependencies
rectangle "File System" as FileSystem <<Actor>>
rectangle "docs/plans.md" as DocsPlansMd <<Database>>
rectangle "docs/todo.md" as DocsTodoMd <<Database>>
rectangle "docs/sessions/explore/<session-id>/explore_session.json" as ExploreSessionJson <<Database>>

' --- Relationships and Call Flow ---

' CLI Command Setup
MainEntry --> AddPlanParser : "Adds 'plan' command and subparsers"

' Basic Plan Management
CommandsPlan.HandlePlanAdd --> PlanStoreClass : "add_plan()"
CommandsPlan.HandlePlanList --> PlanStoreClass : "load()"
CommandsPlan.HandlePlanRemove --> PlanStoreClass : "remove_plan()"
CommandsPlan.HandlePlanShow --> PlanStoreClass : "get_plan()"
CommandsPlan.HandlePlanAddItem --> PlanStoreClass : "add_item_to_plan()"
CommandsPlan.HandlePlanRemoveItem --> PlanStoreClass : "remove_item_from_plan()"

PlanStoreClass --> DocsPlansMd : "loads/saves from"
PlanStoreClass ..> PlanClass : "creates/manages"
PlanStoreClass ..> PlanItemClass : "creates/manages"

' Plan Ops (AI-generated) Flow
CommandsPlan.HandlePlanDiscuss --> AiEngineManagerClass : "uses for AI calls"
CommandsPlan.HandlePlanDiscuss --> DecodePlanOpsJson : "validates AI response"
CommandsPlan.HandlePlanDiscuss --> ActionsToOps : "translates to ops objects"
CommandsPlan.HandlePlanDiscuss --> PlanOpsExecutorClass : "previews/applies ops"

PlanOpsCommands.HandlePlanOpsValidate --> DecodePlanOpsJson
PlanOpsCommands.HandlePlanOpsPreview --> DecodePlanOpsJson
PlanOpsCommands.HandlePlanOpsPreview --> ActionsToOps
PlanOpsCommands.HandlePlanOpsPreview --> PlanOpsExecutorClass.PreviewOps
PlanOpsCommands.HandlePlanOpsApply --> DecodePlanOpsJson
PlanOpsCommands.HandlePlanOpsApply --> ActionsToOps
PlanOpsCommands.HandlePlanOpsApply --> PlanOpsExecutorClass.ApplyOps

DecodePlanOpsJson --> ValidatePlanOpsResult : "relies on schema validation"
ActionsToOps --> PlanOpsOperations : "creates typed ops (CreatePlan, DeletePlan, etc.)"
PlanOpsExecutorClass --> PlansModule.PlanStoreClass : "interacts with PlanStore"
PlanOpsExecutorClass --> PlanOpsOperations : "processes typed ops"
PlanOpsExecutorClass --> PreviewResultClass : "returns preview"
PlanOpsExecutorClass ..> SelectorClass : "resolves plan"

' Plan Explore Flow
CommandsPlan.HandlePlanExplore --> PlanExploreSession.CreateExploreSession : "creates session"
CommandsPlan.HandlePlanExplore --> PlanExploreSession.ResumeExploreSession : "resumes session"
CommandsPlan.HandlePlanExplore --> AiEngineManagerClass : "uses for AI calls"
CommandsPlan.HandlePlanExplore --> CreateExplorePrompt : "generates prompt"
CommandsPlan.HandlePlanExplore --> DecodeProjectOpsJson : "validates AI response"
CommandsPlan.HandlePlanExplore --> ProjectOpsTranslator.ActionsToOpsProj : "translates to project ops"
CommandsPlan.HandlePlanExplore --> ProjectOpsExecutorClass : "previews/applies project ops"
CommandsPlan.HandlePlanExplore --> PlanExploreSession.AddIterationToSession : "adds iteration"
CommandsPlan.HandlePlanExplore --> PlanExploreSession.SaveExploreSession : "saves session"
CommandsPlan.HandlePlanExplore --> DataMarkdownParser.ParseTodoMd : "reads project state"
CommandsPlan.HandlePlanExplore --> ConfigSettings.GetSettings : "accesses settings"

PlanExploreSession.ExploreSessionClass "1" *-- "0..*" PlanExploreSession.ExploreIterationClass : "contains"
PlanExploreSession.ExploreIterationClass --> ExploreIterationStatus : "has status"
ExploreSessionJson <--> PlanExploreSession : "persists sessions"

' AI Manager and Chat
AiEngineManagerClass <.. CommandsPlan.HandlePlanDiscuss
AiEngineManagerClass <.. CommandsPlan.HandlePlanExplore
AiChatModule.RunInteractiveChat <.. CommandsPlan.HandlePlanDiscuss : "interactive mode"
AiTypesModule.PromptRefClass <.. CommandsPlan.HandlePlanDiscuss
AiTypesModule.RunOptsClass <.. CommandsPlan.HandlePlanDiscuss
AiTypesModule.PromptRefClass <.. CommandsPlan.HandlePlanExplore
AiTypesModule.RunOptsClass <.. CommandsPlan.HandlePlanExplore

' Utility/Common
CommandsPlan --> MaestroUtils : "console output"

' Validation Gates
rectangle "AI response JSON validation" as PlanOpsJsonValidation <<Validation Gate>>
HandlePlanDiscuss -down-> PlanOpsJsonValidation : "validates"
HandlePlanExplore -down-> PlanOpsJsonValidation : "validates ProjectOpsResult"
PlanOpsJsonValidation --> DecodeError : "raises error on failure"
PlanOpsExecutorClass --> DecodeError : "raises error on invalid op or state"
PlanOpsExecutorClass --> PlanStoreClass.load : "implicitly checks for duplicates in CreatePlan"

@enduml
