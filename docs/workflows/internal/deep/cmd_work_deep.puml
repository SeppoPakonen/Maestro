@startuml cmd_work_deep
!include _shared.puml

' Core Command Modules
' MODULE: MaestroMain, "maestro/main.py"
rectangle "main()" as MainEntry <<Function>>

' MODULE: CommandsWork, "maestro/commands/work.py"
rectangle "add_work_parser()" as AddWorkParser <<Function>>
rectangle "handle_work_any()" as HandleWorkAny <<Function>>
rectangle "handle_work_any_pick()" as HandleWorkAnyPick <<Function>>
rectangle "handle_work_track()" as HandleWorkTrack <<Function>>
rectangle "handle_work_phase()" as HandleWorkPhase <<Function>>
rectangle "handle_work_issue()" as HandleWorkIssue <<Function>>
rectangle "handle_work_task()" as HandleWorkTask <<Function>>
rectangle "handle_work_discuss()" as HandleWorkDiscuss <<Function>>
rectangle "handle_work_analyze()" as HandleWorkAnalyze <<Function>>
rectangle "handle_work_fix()" as HandleWorkFix <<Function>>
rectangle "load_available_work()" as LoadAvailableWork <<Function>>
rectangle "ai_select_work_items()" as AiSelectWorkItems <<Function>>
rectangle "simple_priority_sort()" as SimplePrioritySort <<Function>>
rectangle "_run_ai_interaction_with_breadcrumb()" as _RunAiInteractionWithBreadcrumb <<Function>>
rectangle "_safe_generate()" as _SafeGenerate <<Function>>
rectangle "load_issues()" as LoadIssues <<Function>>
rectangle "_load_task_entries()" as _LoadTaskEntries <<Function>>

' Work Session & Breadcrumb Management
' MODULE: WorkSessionModule, "maestro/work_session.py"
rectangle "WorkSession" as WorkSessionClass <<Class>>
rectangle "create_session()" as CreateSession <<Function>>
rectangle "complete_session()" as CompleteSession <<Function>>
rectangle "save_session()" as SaveSession <<Function>>
rectangle "is_breadcrumb_enabled()" as IsBreadcrumbEnabled <<Function>>
rectangle "load_breadcrumb_settings()" as LoadBreadcrumbSettings <<Function>>

' MODULE: BreadcrumbModule, "maestro/breadcrumb.py"
rectangle "create_breadcrumb()" as CreateBreadcrumb <<Function>>
rectangle "write_breadcrumb()" as WriteBreadcrumb <<Function>>
rectangle "estimate_tokens()" as EstimateTokens <<Function>>
rectangle "calculate_cost()" as CalculateCost <<Function>>

' AI Task Synchronization (from AI module)
' MODULE: AiTaskSync, "maestro/ai/task_sync.py"
rectangle "build_task_prompt()" as BuildTaskPrompt <<Function>>
rectangle "build_task_queue()" as BuildTaskQueue <<Function>>
rectangle "find_task_context()" as FindTaskContext <<Function>>
rectangle "task_is_done()" as TaskIsDone <<Function>>
rectangle "write_sync_state()" as WriteSyncState <<Function>>

' AI Engine Integration
' MODULE: EnginesModule, "maestro/engines.py"
rectangle "get_engine()" as GetEngine <<Function>>
    EXCEPTION(EngineError, "EngineError")

' Data & Context
' MODULE: DataMarkdown, "maestro/data/markdown_parser.py"
rectangle "parse_todo_md()" as ParseTodoMd <<Function>>
rectangle "parse_phase_md()" as ParsePhaseMd <<Function>>

' MODULE: CommandsDiscuss, "maestro/commands/discuss.py"
rectangle "handle_track_discuss()" as HandleTrackDiscuss <<Function>>
rectangle "handle_phase_discuss()" as HandlePhaseDiscuss <<Function>>
rectangle "handle_task_discuss()" as HandleTaskDiscuss <<Function>>

' Worker Modules (Dynamically Imported)
PACKAGE(Workers, "maestro/workers") {
rectangle "track_worker.py" as TrackWorker <<Class>> { rectangle "execute_track_work()" as ExecuteTrackWork <<Function>> }
rectangle "phase_worker.py" as PhaseWorker <<Class>> { rectangle "execute_phase_work()" as ExecutePhaseWork <<Function>> }
rectangle "issue_worker.py" as IssueWorker <<Class>> { rectangle "execute_issue_work()" as ExecuteIssueWork <<Function>> }

' External Dependencies
rectangle "File System" as FileSystem <<Actor>>
rectangle "External AI Service" as ExternalAI <<Actor>>
rectangle "User (for interactive selection)" as User <<Actor>>
rectangle "Git CLI (for analyze context)" as Git <<Actor>>

' Persistent Stores
rectangle "docs/todo.md" as DocsTodoMd <<Database>>
rectangle "docs/issues/<id>.md" as DocsIssuesMd <<Database>>
rectangle "docs/phases/<id>.md" as DocsPhasesMd <<Database>>
rectangle "docs/sessions/" as DocsSessionsDir <<Database>>
    *.json (work sessions)
    breadcrumbs/*.jsonl (breadcrumbs)
rectangle "docs/ai_sync.json" as DocsAiSyncJson <<Database>>


' --- Relationships and Call Flow ---

' CLI Command Setup
MainEntry --> AddWorkParser : "Adds 'work' command and subparsers"

' Work Orchestration (Delegation)
HandleWorkAny --> LoadAvailableWork : "gets items"
HandleWorkAny --> AiSelectWorkItems : "AI chooses best"
HandleWorkAny --> CreateSession : "starts session"
HandleWorkAny --> Workers : "executes work"

HandleWorkAnyPick --> LoadAvailableWork
HandleWorkAnyPick --> AiSelectWorkItems : "AI recommends top N"
HandleWorkAnyPick --> User : "selects item"
HandleWorkAnyPick --> CreateSession
HandleWorkAnyPick --> Workers : "executes work"

HandleWorkTrack --> LoadAvailableWork
HandleWorkTrack --> CreateSession
HandleWorkTrack --> Workers.ExecuteTrackWork

HandleWorkPhase --> LoadAvailableWork
HandleWorkPhase --> CreateSession
HandleWorkPhase --> Workers.ExecutePhaseWork

HandleWorkIssue --> LoadAvailableWork
HandleWorkIssue --> CreateSession
HandleWorkIssue --> Workers.ExecuteIssueWork

HandleWorkTask --> _LoadTaskEntries
HandleWorkTask --> AiTaskSync.FindTaskContext
HandleWorkTask --> AiTaskSync.BuildTaskQueue
HandleWorkTask --> AiTaskSync.WriteSyncState
HandleWorkTask --> CreateSession
HandleWorkTask --> _RunAiInteractionWithBreadcrumb

HandleWorkDiscuss --> CommandsDiscuss : "delegates to specific discuss handler"

HandleWorkAnalyze --> LoadAvailableWork : "gathers context for AI"
HandleWorkAnalyze --> GetEngine : "selects AI engine"
HandleWorkAnalyze --> _RunAiInteractionWithBreadcrumb : "runs AI analysis"

HandleWorkFix --> LoadAvailableWork
HandleWorkFix --> CreateSession
HandleWorkFix --> _RunAiInteractionWithBreadcrumb
HandleWorkFix --> GetEngine : "selects AI engine for multi-phase workflow"

' Work Session & Breadcrumb Flow
CreateSession --[#Red,dashed]-> DocsSessionsDir : "creates session.json"
_RunAiInteractionWithBreadcrumb --> _SafeGenerate : "generates AI response"
_RunAiInteractionWithBreadcrumb --> BreadcrumbModule.CreateBreadcrumb
_RunAiInteractionWithBreadcrumb --> BreadcrumbModule.WriteBreadcrumb --[#Red,dashed]-> DocsBreadcrumbsJsonL : "writes breadcrumb data"
_RunAiInteractionWithBreadcrumb --> BreadcrumbModule.EstimateTokens
_RunAiInteractionWithBreadcrumb --> BreadcrumbModule.CalculateCost
WorkSessionModule.CompleteSession --[#Red,dashed]-> DocsSessionsDir : "updates session.json status"

' AI Interaction Details
AiSelectWorkItems --> GetEngine : "calls AI for selection"
AiSelectWorkItems --> ExternalAI : "interacts with AI service"
AiSelectWorkItems --> SimplePrioritySort : "fallback if AI fails"
_SafeGenerate --> GetEngine : "generates content from AI"
_SafeGenerate --> ExternalAI

' Data Sources
LoadAvailableWork --> DocsTodoMd : "reads tracks/phases"
LoadAvailableWork --> LoadIssues : "reads issues"
LoadIssues --> DocsIssuesMd
_LoadTaskEntries --> DocsPhasesMd

' Task Sync State
AiTaskSync.WriteSyncState --[#Red,dashed]-> DocsAiSyncJson : "updates sync state"

' Utilities & Helpers
CommandsWork --> AiTaskSync.FindTaskContext
CommandsWork --> AiTaskSync.TaskIsDone
CommandsWork --> DataMarkdown.ParsePhaseMd
CommandsWork --> GetEngine
CommandsWork --> Logging : "uses for error/debug"

@enduml
