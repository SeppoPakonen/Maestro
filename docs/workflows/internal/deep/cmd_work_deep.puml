@startuml cmd_work_deep
!include _shared.puml

' Core Command Modules
MODULE(MaestroMain, "maestro/main.py") {
    FUNCTION(MainEntry, "main()")
}

MODULE(CommandsWork, "maestro/commands/work.py") {
    FUNCTION(AddWorkParser, "add_work_parser()")
    FUNCTION(HandleWorkAny, "handle_work_any()")
    FUNCTION(HandleWorkAnyPick, "handle_work_any_pick()")
    FUNCTION(HandleWorkTrack, "handle_work_track()")
    FUNCTION(HandleWorkPhase, "handle_work_phase()")
    FUNCTION(HandleWorkIssue, "handle_work_issue()")
    FUNCTION(HandleWorkTask, "handle_work_task()")
    FUNCTION(HandleWorkDiscuss, "handle_work_discuss()")
    FUNCTION(HandleWorkAnalyze, "handle_work_analyze()")
    FUNCTION(HandleWorkFix, "handle_work_fix()")
    FUNCTION(LoadAvailableWork, "load_available_work()")
    FUNCTION(AiSelectWorkItems, "ai_select_work_items()")
    FUNCTION(SimplePrioritySort, "simple_priority_sort()")
    FUNCTION(_RunAiInteractionWithBreadcrumb, "_run_ai_interaction_with_breadcrumb()")
    FUNCTION(_SafeGenerate, "_safe_generate()")
    FUNCTION(LoadIssues, "load_issues()")
    FUNCTION(_LoadTaskEntries, "_load_task_entries()")
}

' Work Session & Breadcrumb Management
MODULE(WorkSessionModule, "maestro/work_session.py") {
    CLASS(WorkSessionClass, "WorkSession")
    FUNCTION(CreateSession, "create_session()")
    FUNCTION(CompleteSession, "complete_session()")
    FUNCTION(SaveSession, "save_session()")
    FUNCTION(IsBreadcrumbEnabled, "is_breadcrumb_enabled()")
    FUNCTION(LoadBreadcrumbSettings, "load_breadcrumb_settings()")
}

MODULE(BreadcrumbModule, "maestro/breadcrumb.py") {
    FUNCTION(CreateBreadcrumb, "create_breadcrumb()")
    FUNCTION(WriteBreadcrumb, "write_breadcrumb()")
    FUNCTION(EstimateTokens, "estimate_tokens()")
    FUNCTION(CalculateCost, "calculate_cost()")
}

' AI Task Synchronization (from AI module)
MODULE(AiTaskSync, "maestro/ai/task_sync.py") {
    FUNCTION(BuildTaskPrompt, "build_task_prompt()")
    FUNCTION(BuildTaskQueue, "build_task_queue()")
    FUNCTION(FindTaskContext, "find_task_context()")
    FUNCTION(TaskIsDone, "task_is_done()")
    FUNCTION(WriteSyncState, "write_sync_state()")
}

' AI Engine Integration
MODULE(EnginesModule, "maestro/engines.py") {
    FUNCTION(GetEngine, "get_engine()")
    EXCEPTION(EngineError, "EngineError")
}

' Data & Context
MODULE(DataMarkdown, "maestro/data/markdown_parser.py") {
    FUNCTION(ParseTodoMd, "parse_todo_md()")
    FUNCTION(ParsePhaseMd, "parse_phase_md()")
}

MODULE(CommandsDiscuss, "maestro/commands/discuss.py") {
    FUNCTION(HandleTrackDiscuss, "handle_track_discuss()")
    FUNCTION(HandlePhaseDiscuss, "handle_phase_discuss()")
    FUNCTION(HandleTaskDiscuss, "handle_task_discuss()")
}

' Worker Modules (Dynamically Imported)
PACKAGE(Workers, "maestro/workers") {
    CLASS(TrackWorker, "track_worker.py") { FUNCTION(ExecuteTrackWork, "execute_track_work()") }
    CLASS(PhaseWorker, "phase_worker.py") { FUNCTION(ExecutePhaseWork, "execute_phase_work()") }
    CLASS(IssueWorker, "issue_worker.py") { FUNCTION(ExecuteIssueWork, "execute_issue_work()") }
}

' External Dependencies
ACTOR(FileSystem, "File System")
ACTOR(ExternalAI, "External AI Service")
ACTOR(User, "User (for interactive selection)")
ACTOR(Git, "Git CLI (for analyze context)")

' Persistent Stores
DATABASE(DocsTodoMd, "docs/todo.md")
DATABASE(DocsIssuesMd, "docs/issues/<id>.md")
DATABASE(DocsPhasesMd, "docs/phases/<id>.md")
DATABASE(DocsSessionsDir, "docs/sessions/") {
    *.json (work sessions)
    breadcrumbs/*.jsonl (breadcrumbs)
}
DATABASE(DocsAiSyncJson, "docs/ai_sync.json")


' --- Relationships and Call Flow ---

' CLI Command Setup
MainEntry --> AddWorkParser : "Adds 'work' command and subparsers"

' Work Orchestration (Delegation)
HandleWorkAny --> LoadAvailableWork : "gets items"
HandleWorkAny --> AiSelectWorkItems : "AI chooses best"
HandleWorkAny --> CreateSession : "starts session"
HandleWorkAny --> Workers : "executes work"

HandleWorkAnyPick --> LoadAvailableWork
HandleWorkAnyPick --> AiSelectWorkItems : "AI recommends top N"
HandleWorkAnyPick --> User : "selects item"
HandleWorkAnyPick --> CreateSession
HandleWorkAnyPick --> Workers : "executes work"

HandleWorkTrack --> LoadAvailableWork
HandleWorkTrack --> CreateSession
HandleWorkTrack --> Workers.ExecuteTrackWork

HandleWorkPhase --> LoadAvailableWork
HandleWorkPhase --> CreateSession
HandleWorkPhase --> Workers.ExecutePhaseWork

HandleWorkIssue --> LoadAvailableWork
HandleWorkIssue --> CreateSession
HandleWorkIssue --> Workers.ExecuteIssueWork

HandleWorkTask --> _LoadTaskEntries
HandleWorkTask --> AiTaskSync.FindTaskContext
HandleWorkTask --> AiTaskSync.BuildTaskQueue
HandleWorkTask --> AiTaskSync.WriteSyncState
HandleWorkTask --> CreateSession
HandleWorkTask --> _RunAiInteractionWithBreadcrumb

HandleWorkDiscuss --> CommandsDiscuss : "delegates to specific discuss handler"

HandleWorkAnalyze --> LoadAvailableWork : "gathers context for AI"
HandleWorkAnalyze --> GetEngine : "selects AI engine"
HandleWorkAnalyze --> _RunAiInteractionWithBreadcrumb : "runs AI analysis"

HandleWorkFix --> LoadAvailableWork
HandleWorkFix --> CreateSession
HandleWorkFix --> _RunAiInteractionWithBreadcrumb
HandleWorkFix --> GetEngine : "selects AI engine for multi-phase workflow"

' Work Session & Breadcrumb Flow
CreateSession --[#Red,dashed]-> DocsSessionsDir : "creates session.json"
_RunAiInteractionWithBreadcrumb --> _SafeGenerate : "generates AI response"
_RunAiInteractionWithBreadcrumb --> BreadcrumbModule.CreateBreadcrumb
_RunAiInteractionWithBreadcrumb --> BreadcrumbModule.WriteBreadcrumb --[#Red,dashed]-> DocsBreadcrumbsJsonL : "writes breadcrumb data"
_RunAiInteractionWithBreadcrumb --> BreadcrumbModule.EstimateTokens
_RunAiInteractionWithBreadcrumb --> BreadcrumbModule.CalculateCost
WorkSessionModule.CompleteSession --[#Red,dashed]-> DocsSessionsDir : "updates session.json status"

' AI Interaction Details
AiSelectWorkItems --> GetEngine : "calls AI for selection"
AiSelectWorkItems --> ExternalAI : "interacts with AI service"
AiSelectWorkItems --> SimplePrioritySort : "fallback if AI fails"
_SafeGenerate --> GetEngine : "generates content from AI"
_SafeGenerate --> ExternalAI

' Data Sources
LoadAvailableWork --> DocsTodoMd : "reads tracks/phases"
LoadAvailableWork --> LoadIssues : "reads issues"
LoadIssues --> DocsIssuesMd
_LoadTaskEntries --> DocsPhasesMd

' Task Sync State
AiTaskSync.WriteSyncState --[#Red,dashed]-> DocsAiSyncJson : "updates sync state"

' Utilities & Helpers
CommandsWork --> AiTaskSync.FindTaskContext
CommandsWork --> AiTaskSync.TaskIsDone
CommandsWork --> DataMarkdown.ParsePhaseMd
CommandsWork --> GetEngine
CommandsWork --> Logging : "uses for error/debug"

@enduml
