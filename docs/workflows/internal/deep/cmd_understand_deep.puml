@startuml cmd_understand_deep
!include _shared.puml

' Core Command Modules
' MODULE: MaestroMain, "maestro/main.py"
rectangle "main()" as MainEntry <<Function>>

' MODULE: CommandsUnderstand, "maestro/commands/understand/__init__.py"
rectangle "add_understand_parser()" as AddUnderstandParser <<Function>>

' MODULE: UnderstandCommand, "maestro/understand/command.py"
rectangle "handle_understand_dump()" as HandleUnderstandDump <<Function>>

' MODULE: UnderstandIntrospector, "maestro/understand/introspector.py"
rectangle "ProjectIntrospector" as ProjectIntrospectorClass <<Class>>
rectangle "gather_all()" as GatherAll <<Function>>
rectangle "gather_identity()" as GatherIdentity <<Function>>
rectangle "gather_authority_model()" as GatherAuthorityModel <<Function>>
rectangle "gather_rule_gates()" as GatherRuleGates <<Function>>
rectangle "gather_mutation_boundaries()" as GatherMutationBoundaries <<Function>>
rectangle "gather_automation_long_run()" as GatherAutomationLongRun <<Function>>
rectangle "gather_directory_semantics()" as GatherDirectorySemantics <<Function>>
rectangle "gather_contracts()" as GatherContracts <<Function>>
rectangle "gather_evidence_index()" as GatherEvidenceIndex <<Function>>

' MODULE: UnderstandRenderer, "maestro/understand/renderer.py"
rectangle "MarkdownRenderer" as MarkdownRendererClass <<Class>>
rectangle "render()" as Render <<Function>>
rectangle "_render_identity()" as _RenderIdentity <<Function>>
rectangle "_render_authority_model()" as _RenderAuthorityModel <<Function>>
rectangle "_render_rule_gates()" as _RenderRuleGates <<Function>>
    ' ... other _render_* methods

' Utility Modules
' MODULE: MaestroUtils, "maestro/modules/utils.py"
    ' print_success, print_error etc.

' External Dependencies
rectangle "File System" as FileSystem <<Actor>>
rectangle "pathlib" as Pathlib <<Actor>>

' Persistent Stores
rectangle "docs/UNDERSTANDING_SNAPSHOT.md" as DocsUnderstandingSnapshotMd <<Database>>


' --- Relationships and Call Flow ---

' CLI Command Setup
MainEntry --> CommandsUnderstand.AddUnderstandParser : "Adds 'understand' command"
CommandsUnderstand.AddUnderstandParser --> UnderstandCommand.HandleUnderstandDump : "registers handler for 'dump'"

' Command Execution Flow
MainEntry --> UnderstandCommand.HandleUnderstandDump : "dispatches 'understand dump'"

' Introspection and Rendering Process
UnderstandCommand.HandleUnderstandDump --> UnderstandIntrospector.ProjectIntrospectorClass : "1. Initialize Introspector"
UnderstandCommand.HandleUnderstandDump --> UnderstandRenderer.MarkdownRendererClass : "2. Initialize Renderer"

MarkdownRendererClass.Render --> ProjectIntrospectorClass.GatherAll : "3. Gather all project data"
ProjectIntrospectorClass.GatherAll --> ProjectIntrospectorClass.GatherIdentity : "  - gathers identity"
ProjectIntrospectorClass.GatherAll --> ProjectIntrospectorClass.GatherAuthorityModel : "  - gathers authority model"
' ... other gather_* methods

MarkdownRendererClass.Render --> UnderstandRenderer._RenderIdentity : "4. Render sections to Markdown"
MarkdownRendererClass.Render --> UnderstandRenderer._RenderAuthorityModel
' ... other _render_* methods

' File I/O for Snapshot
UnderstandCommand.HandleUnderstandDump --> Pathlib : "path management"
Pathlib --> FileSystem : "interacts with filesystem"
UnderstandCommand.HandleUnderstandDump --> DocsUnderstandingSnapshotMd : "specifies output file"

' Conditional Check Mode
rectangle "args.check == True" as CheckModeLogic <<Validation Gate>>
UnderstandCommand.HandleUnderstandDump --> CheckModeLogic : "5. If check mode"
CheckModeLogic --> DocsUnderstandingSnapshotMd : "reads existing content"
CheckModeLogic --> DocsUnderstandingSnapshotMd : "compares new vs existing"
CheckModeLogic --> HARD_STOP("Mismatched snapshot") : "exit 1 on difference"

' Writing to File
UnderstandCommand.HandleUnderstandDump --> FileSystem : "creates parent directory"
UnderstandCommand.HandleUnderstandDump --[#Red,dashed]-> DocsUnderstandingSnapshotMd : "6. Writes new content"

' Console Output
UnderstandCommand.HandleUnderstandDump --> MaestroUtils : "prints success/error"

@enduml
