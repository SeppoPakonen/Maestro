@startuml cmd_rules_deep
!include _shared.puml

' Core Command Modules
' MODULE: MaestroMain, "maestro/main.py"
rectangle "main()" as MainEntry <<Function>>

' MODULE: CommandHandlers, "maestro/modules/command_handlers.py"
rectangle "handle_rules_list()" as HandleRulesList <<Function>>
rectangle "handle_rules_file()" as HandleRulesFile <<Function>>
rectangle "load_session()" as LoadSession <<Function>>
rectangle "save_session()" as SaveSession <<Function>>
rectangle "get_maestro_dir()" as GetMaestroDir <<Function>> ' Used to determine session_dir

' Session Model & Persistence
' MODULE: SessionModel, "maestro/session_model.py"
rectangle "Session" as SessionClass <<Class>>

' Utility Modules
' MODULE: MaestroUtils, "maestro/modules/utils.py"
    ' print_header, print_info, print_error etc.

' External Dependencies
rectangle "File System" as FileSystem <<Actor>>
rectangle "User's $EDITOR" as Editor <<Actor>>
rectangle "subprocess module" as Subprocess <<Actor>>
rectangle "os module" as OS <<Actor>>
rectangle "pathlib module" as Pathlib <<Actor>>

' Persistent Stores
rectangle "docs/sessions/<name>/" as DocsSessionsDir <<Database>>


' --- Relationships and Call Flow ---

' CLI Command Setup (implicit via maestro.main.py and cli_parser)

' Command Dispatch (from maestro.main.py)
MainEntry -- HandleRulesList
MainEntry -- HandleRulesFile

' HandleRulesList Flow (`maestro rules list`)
HandleRulesList --> CommandHandlers.LoadSession : "loads session data"
CommandHandlers.LoadSession --> DocsSessionsDir : "reads session.json"
HandleRulesList --> FileSystem : "reads rules.txt"
HandleRulesList --> MaestroUtils : "prints rules content"

' HandleRulesFile Flow (`maestro rules edit`)
HandleRulesFile --> CommandHandlers.LoadSession : "loads session data"
HandleRulesFile --> GetMaestroDir : "determines session directory"
HandleRulesFile --> FileSystem : "checks/creates rules.txt"
HandleRulesFile --> CommandHandlers.SaveSession : "updates session with rules_path"
HandleRulesFile --> Subprocess : "invokes external editor"
Editor <--> HandleRulesFile

' Session Model interactions
SessionClass <.. LoadSession : "loaded into"
SessionClass --> SaveSession : "saved from"

' File System Interactions
DocsSessionsDir <--> FileSystem : "reads/writes session.json and rules.txt"
Subprocess --> OS : "editor environment variable"

@enduml
