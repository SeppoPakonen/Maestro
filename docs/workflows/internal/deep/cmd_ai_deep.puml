@startuml cmd_ai_deep
!include _shared.puml

' Core Command Modules
' MODULE: MaestroMain, "maestro/main.py"
rectangle "main()" as MainEntry <<Function>>

' MODULE: CommandsAi, "maestro/commands/ai.py"
rectangle "add_ai_parser()" as AddAiParser <<Function>>
rectangle "handle_ai_sync()" as HandleAiSync <<Function>>
rectangle "handle_ai_qwen()" as HandleAiQwen <<Function>>
rectangle "handle_ai_gemini()" as HandleAiGemini <<Function>>
rectangle "handle_ai_codex()" as HandleAiCodex <<Function>>
rectangle "handle_ai_claude()" as HandleAiClaude <<Function>>
rectangle "_resolve_session()" as _ResolveSession <<Function>>
rectangle "_find_session_path()" as _FindSessionPath <<Function>>
rectangle "_select_next_task()" as _SelectNextTask <<Function>>
rectangle "_write_sync_breadcrumb()" as _WriteSyncBreadcrumb <<Function>>
rectangle "_watch_ai_sync()" as _WatchAiSync <<Function>>
rectangle "_read_sync_signature()" as _ReadSyncSignature <<Function>>
    ' Legacy Qwen handlers
rectangle "_run_qwen_stdin_chat()" as _RunQwenStdinChat <<Function>>
rectangle "_run_qwen_server()" as _RunQwenServer <<Function>>
rectangle "_run_qwen_tui()" as _RunQwenTui <<Function>>
rectangle "_resolve_qwen_script()" as _ResolveQwenScript <<Function>>

' AI-related Subsystem Modules
' MODULE: AiTaskManager, "maestro/ai/task_sync.py"
rectangle "load_sync_state()" as LoadSyncState <<Function>>
rectangle "write_sync_state()" as WriteSyncState <<Function>>
rectangle "find_task_context()" as FindTaskContext <<Function>>
rectangle "build_task_queue()" as BuildTaskQueue <<Function>>
rectangle "build_task_prompt()" as BuildTaskPrompt <<Function>>
rectangle "task_is_done()" as TaskIsDone <<Function>>

' MODULE: BreadcrumbModule, "maestro/breadcrumb.py"
rectangle "create_breadcrumb()" as CreateBreadcrumb <<Function>>
rectangle "write_breadcrumb()" as WriteBreadcrumb <<Function>>
rectangle "estimate_tokens()" as EstimateTokens <<Function>>

' MODULE: WorkSessionModule, "maestro/work_session.py"
rectangle "WorkSession" as WorkSessionClass <<Class>>
rectangle "list_sessions()" as ListSessions <<Function>>
rectangle "load_session()" as LoadSession <<Function>>
rectangle "save_session()" as SaveSession <<Function>>
rectangle "SessionType" as SessionType <<Enum>>
rectangle "SessionStatus" as SessionStatus <<Enum>>

' MODULE: AiManagerModule, "maestro/ai/manager.py"
rectangle "AiEngineManager" as AiEngineManagerClass <<Class>>

' MODULE: AiTypesModule, "maestro/ai/types.py"
rectangle "PromptRef" as PromptRefClass <<Class>>
rectangle "RunOpts" as RunOptsClass <<Class>>

package "maestro/ai/runners.py" as AiRunners <<Module>> { ' Renamed from AiManager's calls
rectangle "run_one_shot()" as RunOneShot <<Function>>
rectangle "run_interactive_chat()" as RunInteractiveChat <<Function>>

' MODULE: ConfigSettings, "maestro/config/settings.py"
rectangle "get_settings()" as GetSettings <<Function>>

' MODULE: MaestroQwenClient, "maestro/qwen/client.py"
rectangle "QwenClient" as QwenClientClass <<Class>>
rectangle "QwenClientConfig" as QwenClientConfig <<Class>>
rectangle "MessageHandlers" as MessageHandlers <<Class>>
    ' Qwen messages (Init, Conversation, etc.)

' MODULE: MaestroQwenTui, "maestro/qwen/tui.py"
rectangle "run_tui()" as RunTui <<Function>>

' External Dependencies
rectangle "File System" as FileSystem <<Actor>>
rectangle "External AI Service" as ExternalAI <<Actor>>
rectangle "Standard Input/Output" as StdIO <<Actor>>

' Persistent Stores
rectangle "docs/ai_sync.json" as DocsAiSyncJson <<Database>>
rectangle "docs/sessions/<id>/session.json" as DocsSessionsJson <<Database>>
rectangle "docs/sessions/<id>/breadcrumbs.jsonl" as DocsBreadcrumbsJsonL <<Database>>
rectangle "$HOME/.maestro/settings.json" as SettingsJson <<Database>>
rectangle "qwen-code.sh" as QwenScript <<Database>>


' --- Relationships and Call Flow ---

' CLI Command Setup
MainEntry --> AddAiParser : "Adds 'ai' command and subparsers"

' Command Dispatch
HandleAiSync <.. MainEntry : "for 'ai sync'"
HandleAiQwen <.. MainEntry : "for 'ai qwen'"
HandleAiGemini <.. MainEntry : "for 'ai gemini'"
HandleAiCodex <.. MainEntry : "for 'ai codex'"
HandleAiClaude <.. MainEntry : "for 'ai claude'"

' AI Sync Flow
HandleAiSync --> CommandsAi._ResolveSession
CommandsAi._ResolveSession --> AiTaskManager.LoadSyncState : "loads sync state"
CommandsAi._ResolveSession --> WorkSessionModule.ListSessions : "finds active work session"
CommandsAi._ResolveSession --> WorkSessionModule.LoadSession : "loads WorkSession object"
HandleAiSync --> AiTaskManager.FindTaskContext : "gets task details"
HandleAiSync --> AiTaskManager.BuildTaskQueue
HandleAiSync --> CommandsAi._SelectNextTask : "selects next task"
HandleAiSync --> AiTaskManager.BuildTaskPrompt : "generates AI prompt"
HandleAiSync --> WorkSessionModule.SaveSession : "updates WorkSession"
HandleAiSync --> AiTaskManager.WriteSyncState : "persists sync state"
HandleAiSync --> CommandsAi._WriteSyncBreadcrumb : "records breadcrumb"
CommandsAi._WriteSyncBreadcrumb --> BreadcrumbModule.CreateBreadcrumb
CommandsAi._WriteSyncBreadcrumb --> BreadcrumbModule.WriteBreadcrumb
CommandsAi._WriteSyncBreadcrumb --> BreadcrumbModule.EstimateTokens

' Watch Mode for AI Sync
HandleAiSync -[dashed]-> CommandsAi._WatchAiSync : "if --watch"
CommandsAi._WatchAiSync --> CommandsAi._ReadSyncSignature : "reads file signature"
CommandsAi._WatchAiSync --> HandleAiSync : "recursively calls handle_ai_sync on change"

' Generic AI Engine Interaction Flow
HandleAiQwen -- RunOptsClass : "builds run options"
HandleAiQwen -- PromptRefClass : "builds prompt reference"
HandleAiQwen -- AiManagerModule.AiEngineManagerClass : "initializes manager"
HandleAiQwen -- AiRunners.RunOneShot : "for --one-shot or --stdin"
HandleAiQwen -- AiRunners.RunInteractiveChat : "for interactive mode"

HandleAiGemini --> AiManagerModule.AiEngineManagerClass
HandleAiGemini --> AiRunners.RunOneShot
HandleAiGemini --> AiRunners.RunInteractiveChat
HandleAiCodex --> AiManagerModule.AiEngineManagerClass
HandleAiCodex --> AiRunners.RunOneShot
HandleAiCodex --> AiRunners.RunInteractiveChat
HandleAiClaude --> AiManagerModule.AiEngineManagerClass
HandleAiClaude --> AiRunners.RunOneShot
HandleAiClaude --> AiRunners.RunInteractiveChat

' AI Configuration
HandleAiQwen --> ConfigSettings.GetSettings
ConfigSettings.GetSettings --> SettingsJson : "reads settings"

' Legacy Qwen Handling
HandleAiQwen -[dashed]-> CommandsAi._RunQwenStdinChat : "for qwen-old tui"
HandleAiQwen -[dashed]-> CommandsAi._RunQwenServer : "for qwen-old server"
HandleAiQwen -[dashed]-> CommandsAi._RunQwenTui : "for qwen-old attach"
CommandsAi._RunQwenStdinChat --> MaestroQwenClient.QwenClientClass : "interacts directly"
CommandsAi._RunQwenStdinChat --> StdIO : "reads/writes"
CommandsAi._RunQwenServer --> Subprocess : "spawns server"
CommandsAi._RunQwenTui --> MaestroQwenTui.RunTui : "runs TUI client"
CommandsAi._RunQwenServer --> QwenScript : "uses qwen-code.sh"

' Persistent Stores & Filesystem
DocsAiSyncJson <--> FileSystem : "sync state"
DocsSessionsJson <--> FileSystem : "work sessions"
DocsBreadcrumbsJsonL <--> FileSystem : "breadcrumbs"
SettingsJson <--> FileSystem : "global settings"

' AI Engine Manager Integration
AiRunners.RunOneShot --> AiManagerModule.AiEngineManagerClass.run_once : "executes AI command"
AiRunners.RunInteractiveChat --> AiManagerModule.AiEngineManagerClass.run_once : "executes AI command"

@enduml
