@startuml cmd_repo_deep
!include _shared.puml

' Core Command Modules
' MODULE: MaestroMain, "maestro/main.py"
rectangle "main()" as MainEntry <<Function>>

' MODULE: CommandsRepo, "maestro/commands/repo.py"
rectangle "add_repo_parser()" as AddRepoParser <<Function>>
rectangle "handle_repo_command()" as HandleRepoCommand <<Function>>
rectangle "find_repo_root()" as FindRepoRoot <<Function>>
rectangle "write_repo_artifacts()" as WriteRepoArtifacts <<Function>>
rectangle "load_repo_index()" as LoadRepoIndex <<Function>>
rectangle "build_repo_hierarchy()" as BuildRepoHierarchy <<Function>>
rectangle "save_hierarchy()" as SaveHierarchy <<Function>>
rectangle "load_hierarchy()" as LoadHierarchy <<Function>>
rectangle "load_hierarchy_overrides()" as LoadHierarchyOverrides <<Function>>
rectangle "merge_hierarchy_overrides()" as MergeHierarchyOverrides <<Function>>
rectangle "print_hierarchy_tree()" as PrintHierarchyTree <<Function>>
rectangle "handle_repo_pkg_list()" as HandleRepoPkgList <<Function>>
rectangle "handle_repo_pkg_info()" as HandleRepoPkgInfo <<Function>>
rectangle "handle_repo_pkg_files()" as HandleRepoPkgFiles <<Function>>
rectangle "handle_repo_pkg_groups()" as HandleRepoPkgGroups <<Function>>
rectangle "handle_repo_pkg_search()" as HandleRepoPkgSearch <<Function>>
rectangle "handle_repo_pkg_tree()" as HandleRepoPkgTree <<Function>>
rectangle "handle_repo_pkg_conf()" as HandleRepoPkgConf <<Function>>
rectangle "handle_repo_refresh_all()" as HandleRepoRefreshAll <<Function>>
rectangle "handle_repo_hier_edit()" as HandleRepoHierEdit <<Function>>
rectangle "handle_repo_hier()" as HandleRepoHier <<Function>>
rectangle "handle_repo_conventions_detect()" as HandleRepoConventionsDetect <<Function>>
rectangle "handle_repo_conventions_show()" as HandleRepoConventionsShow <<Function>>
rectangle "handle_repo_rules_show()" as HandleRepoRulesShow <<Function>>
rectangle "handle_repo_rules_edit()" as HandleRepoRulesEdit <<Function>>
rectangle "handle_repo_rules_inject()" as HandleRepoRulesInject <<Function>>

' Repo Subsystem Modules (defined in subsystem_repo_resolve)
' MODULE: ScannerModule, "maestro/repo/scanner.py"
rectangle "scan_upp_repo_v2()" as ScanUppRepoV2 <<Function>>

' MODULE: PackageModule, "maestro/repo/package.py"
rectangle "PackageInfo" as PackageInfoClass <<Class>>
rectangle "FileGroup" as FileGroupClass <<Class>>

' MODULE: BuildConfigModule, "maestro/repo/build_config.py"
rectangle "get_package_config()" as GetPackageConfig <<Function>>

' MODULE: UppConditionsModule, "maestro/repo/upp_conditions.py"
rectangle "match_when()" as MatchWhen <<Function>>

' MODULE: GlobalIndexModule, "maestro/global_index.py"
rectangle "update_global_repo_index()" as UpdateGlobalRepoIndex <<Function>>

' MODULE: MaestroUtils, "maestro/modules/utils.py"
    ' Uses print_header, print_info, print_success, print_error, print_warning, print_debug, Colors

' External Dependencies
rectangle "User's $EDITOR" as Editor <<Actor>>
rectangle "File System" as FileSystem <<Actor>>
rectangle "subprocess module" as Subprocess <<Actor>>

' Persistent Stores
rectangle ".maestro/repo/" as MaestroRepoDir <<Data Store>>
rectangle "docs/RepoRules.md" as DocsRepoRulesMd <<Data Store>>
rectangle "$HOME/.maestro/repos.json" as GlobalIndexFile <<Data Store>>

' --- Relationships ---

MainEntry --> HandleRepoCommand : "CLI command dispatch"

' Subcommand Dispatch within handle_repo_command
HandleRepoCommand --> FindRepoRoot : "Locates repo context"

' `repo resolve` flow
HandleRepoCommand -down-> ScanUppRepoV2 : "invokes scanner (for 'resolve', 'refresh all')"
ScanUppRepoV2 --> RepoScanResultClass : "returns scan result"
HandleRepoCommand -down-> WriteRepoArtifacts : "persists scan artifacts"
WriteRepoArtifacts --[#Red,dashed]-> MaestroRepoDir : "writes index.json, summary.txt, assemblies.json, state.json"
HandleRepoRefreshAll --> UpdateGlobalRepoIndex : "updates global index"
UpdateGlobalRepoIndex --[#Red,dashed]-> GlobalIndexFile : "writes repo info"

' `repo show`, `repo pkg`, `repo conf` flow
HandleRepoCommand --> LoadRepoIndex : "loads scan result"
LoadRepoIndex -[dashed]-> MaestroRepoDir : "reads index.json"
LoadRepoIndex --> RepoScanResultClass : "returns loaded data"
HandleRepoCommand ..> HandleRepoPkgList
HandleRepoCommand ..> HandleRepoPkgInfo
HandleRepoCommand ..> HandleRepoPkgFiles
HandleRepoCommand ..> HandleRepoPkgGroups
HandleRepoCommand ..> HandleRepoPkgSearch

HandleRepoCommand --> HandleRepoPkgTree : "Package dependency tree"
HandleRepoPkgTree --> UppConditionsModule.MatchWhen : "applies conditional logic"

HandleRepoCommand --> HandleRepoPkgConf : "Package configurations"
HandleRepoPkgConf --> BuildConfigModule.GetPackageConfig : "gets build config"

' `repo hier` flow
HandleRepoCommand --> LoadHierarchy : "loads hierarchy"
HandleRepoCommand --> BuildRepoHierarchy : "builds hierarchy"
BuildRepoHierarchy --> RepoScanResultClass : "uses scan data"
BuildRepoHierarchy --> PackageInfoClass : "uses PackageInfo"
BuildRepoHierarchy --> FileGroupClass : "uses FileGroup"
HandleRepoCommand --> SaveHierarchy : "saves hierarchy"
SaveHierarchy --[#Red,dashed]-> MaestroRepoDir : "writes hierarchy.json"
HandleRepoCommand --> LoadHierarchyOverrides : "loads manual overrides"
LoadHierarchyOverrides -[dashed]-> MaestroRepoDir : "reads hierarchy_overrides.json"
HandleRepoCommand --> MergeHierarchyOverrides : "merges overrides"
HandleRepoCommand --> PrintHierarchyTree : "prints to console"

' `repo hier edit` flow
HandleRepoCommand --> HandleRepoHierEdit : "edit hierarchy overrides"
HandleRepoHierEdit --[#Red,dashed]-> MaestroRepoDir : "creates hierarchy_overrides.json template"
HandleRepoHierEdit --> Subprocess : "invokes external editor"
Editor <--> HandleRepoHierEdit

' `repo rules`, `repo conventions` flow
HandleRepoCommand ..> HandleRepoRulesShow
HandleRepoCommand ..> HandleRepoRulesEdit
HandleRepoCommand ..> HandleRepoRulesInject
HandleRepoCommand ..> HandleRepoConventionsShow
HandleRepoCommand ..> HandleRepoConventionsDetect
HandleRepoRulesShow -[dashed]-> DocsRepoRulesMd : "reads rules"
HandleRepoRulesEdit --> Subprocess : "invokes external editor"
Editor <--> HandleRepoRulesEdit
HandleRepoRulesEdit --[#Red,dashed]-> DocsRepoRulesMd : "writes rules"

' Utility functions
CommandsRepo --> MaestroUtils : "uses for console output"
CommandsRepo --> PackageModule : "uses PackageInfo, FileGroup"

' Persistence Details
WriteRepoArtifacts --> Subprocess : "uses tempfile, os.replace for atomic writes"
WriteRepoArtifacts --> FileSystem : "creates directories"

@enduml
