@startuml cmd_discuss_deep
!include _shared.puml

' Core Command Modules
' MODULE: MaestroMain, "maestro/main.py"
rectangle "main()" as MainEntry <<Function>>

' MODULE: CommandsDiscuss, "maestro/commands/discuss.py"
rectangle "add_discuss_parser()" as AddDiscussParser <<Function>>
rectangle "handle_discuss_command()" as HandleDiscussCommand <<Function>>
rectangle "handle_track_discuss()" as HandleTrackDiscuss <<Function>>
rectangle "handle_phase_discuss()" as HandlePhaseDiscuss <<Function>>
rectangle "handle_task_discuss()" as HandleTaskDiscuss <<Function>>
rectangle "choose_mode()" as ChooseMode <<Function>>
rectangle "run_discussion_with_router()" as RunDiscussionWithRouter <<Function>>
rectangle "apply_patch_operations()" as ApplyPatchOperations <<Function>>
rectangle "find_phase_file_for_task()" as FindPhaseFileForTask <<Function>>
rectangle "save_discussion_artifacts()" as SaveDiscussionArtifacts <<Function>>
rectangle "update_artifact_status()" as UpdateArtifactStatus <<Function>>

' AI Integration Modules
' MODULE: AiManager, "maestro/ai/manager.py"
rectangle "AiEngineManager" as AiEngineManagerClass <<Class>>

' MODULE: AiDiscussionRouter, "maestro/ai/discussion_router.py"
rectangle "DiscussionRouter" as DiscussionRouterClass <<Class>>
rectangle "run_discussion()" as RunDiscussion <<Function>>

' MODULE: AiContracts, "maestro/ai/contracts.py"
rectangle "JsonContract" as JsonContractClass <<Class>>
rectangle "TrackContract" as TrackContract <<Class>>
rectangle "PhaseContract" as PhaseContract <<Class>>
rectangle "TaskContract" as TaskContract <<Class>>
rectangle "GlobalContract" as GlobalContract <<Class>>
rectangle "ContractType" as ContractTypeEnum <<Enum>>

' MODULE: AiActions, "maestro/ai/actions.py"
rectangle "ActionProcessor" as ActionProcessorClass <<Class>>
rectangle "PatchOperation" as PatchOperationClass <<Class>>
rectangle "PatchOperationType" as PatchOperationTypeEnum <<Enum>>
rectangle "validate_actions()" as ValidateActions <<Function>>
rectangle "execute_actions()" as ExecuteActions <<Function>>

' Data Storage and Markdown Writers
' MODULE: DataMarkdown, "maestro/data/markdown_parser.py"
rectangle "parse_config_md()" as ParseConfigMd <<Function>>

' MODULE: DataMarkdownWriter, "maestro/data/markdown_writer.py"
rectangle "insert_track_block()" as InsertTrackBlock <<Function>>
rectangle "insert_phase_block()" as InsertPhaseBlock <<Function>>
rectangle "insert_task_block()" as InsertTaskBlock <<Function>>
rectangle "update_track_metadata()" as UpdateTrackMetadata <<Function>>
rectangle "update_phase_metadata()" as UpdatePhaseMetadata <<Function>>
rectangle "update_task_metadata()" as UpdateTaskMetadata <<Function>>
    ' ... others (replace, remove)

' MODULE: DiscussionSessionModule, "maestro/discussion.py"
rectangle "DiscussionSession" as DiscussionSessionClass <<Class>>
rectangle "create_discussion_session()" as CreateDiscussionSession <<Function>>
rectangle "resume_discussion()" as ResumeDiscussion <<Function>>
rectangle "run_editor_mode()" as RunEditorMode <<Function>>
rectangle "run_terminal_mode()" as RunTerminalMode <<Function>>

' MODULE: WorkSessionModule, "maestro/work_session.py"
rectangle "create_session()" as CreateSession <<Function>>

' MODULE: BreadcrumbModule, "maestro/breadcrumb.py"
rectangle "get_breadcrumb_summary()" as GetBreadcrumbSummary <<Function>>

' External Dependencies
rectangle "User's $EDITOR" as Editor <<Actor>>
rectangle "File System" as FileSystem <<Actor>>
rectangle "subprocess module" as Subprocess <<Actor>>

' Persistent Stores
rectangle "docs/config.md" as DocsConfigMd <<Database>>
rectangle "docs/todo.md" as DocsTodoMd <<Database>>
rectangle "docs/phases/<id>.md" as DocsPhasesMd <<Database>>
rectangle ".maestro/ai/artifacts/\n(*.txt transcripts, *.json results)" as MaestroAiArtifacts <<Database>>
rectangle "docs/state/work_sessions.json" as WorkSessionsJson <<Database>>


' --- Relationships and Call Flow ---

' CLI Command Setup
MainEntry --> AddDiscussParser : "Adds 'discuss' command and args"

' Command Dispatch based on context
HandleDiscussCommand --up-> CommandsDiscuss.HandleTrackDiscuss : "if --track provided"
HandleDiscussCommand --up-> CommandsDiscuss.HandlePhaseDiscuss : "if --phase provided"
HandleDiscussCommand --up-> CommandsDiscuss.HandleTaskDiscuss : "if --task provided"
HandleDiscussCommand --> CommandsDiscuss.RunDiscussionWithRouter : "general discussion"

' AI Discussion Routing and Execution
CommandsDiscuss.RunDiscussionWithRouter --> AiManager.AiEngineManagerClass : "initializes AI engine manager"
CommandsDiscuss.RunDiscussionWithRouter --> AiDiscussionRouter.DiscussionRouterClass : "initializes discussion router"
CommandsDiscuss.RunDiscussionWithRouter --> AiContracts.JsonContractClass : "selects appropriate contract"
CommandsDiscuss.RunDiscussionWithRouter --> AiDiscussionRouter.RunDiscussion : "runs AI discussion loop"
AiDiscussionRouter.RunDiscussion --> AiManager.AiEngineManagerClass.run_once : "interacts with AI"
AiDiscussionRouter.RunDiscussion --> AiContracts.JsonContractClass : "validates AI response"
AiDiscussionRouter.RunDiscussion --> AiActions.PatchOperationClass : "produces PatchOperation objects"

CommandsDiscuss.RunDiscussionWithRouter --> CommandsDiscuss.ChooseMode : "determines discussion mode"
CommandsDiscuss.ChooseMode --> DataMarkdown.ParseConfigMd : "reads config for default mode"

' Artifacts Management
CommandsDiscuss.RunDiscussionWithRouter --> CommandsDiscuss.SaveDiscussionArtifacts : "saves discussion artifacts"
SaveDiscussionArtifacts --[#Red,dashed]-> MaestroAiArtifacts : "writes transcript and results"
CommandsDiscuss.RunDiscussionWithRouter --> CommandsDiscuss.UpdateArtifactStatus : "updates status"
UpdateArtifactStatus --[#Red,dashed]-> MaestroAiArtifacts : "updates results JSON"

' Patch Application Flow
CommandsDiscuss.HandleDiscussCommand --> CommandsDiscuss.ApplyPatchOperations : "applies changes after confirmation"
CommandsDiscuss.HandleTrackDiscuss --> CommandsDiscuss.ApplyPatchOperations
CommandsDiscuss.HandlePhaseDiscuss --> CommandsDiscuss.ApplyPatchOperations
CommandsDiscuss.HandleTaskDiscuss --> CommandsDiscuss.ApplyPatchOperations

ApplyPatchOperations --> DataMarkdownWriter.InsertTrackBlock --[#Red,dashed]-> DocsTodoMd : "adds new tracks"
ApplyPatchOperations --> DataMarkdownWriter.InsertPhaseBlock --[#Red,dashed]-> DocsTodoMd : "adds new phases"
ApplyPatchOperations --> DataMarkdownWriter.InsertTaskBlock --[#Red,dashed]-> DocsPhasesMd : "adds new tasks"
ApplyPatchOperations --> DataMarkdownWriter.UpdateTrackMetadata --[#Red,dashed]-> DocsTodoMd : "updates track status"
ApplyPatchOperations --> DataMarkdownWriter.UpdatePhaseMetadata --[#Red,dashed]-> DocsTodoMd : "updates phase status"
ApplyPatchOperations --> DataMarkdownWriter.UpdateTaskMetadata --[#Red,dashed]-> DocsPhasesMd : "updates task status"
ApplyPatchOperations --> CommandsDiscuss.FindPhaseFileForTask : "finds phase file for task ops"
CommandsDiscuss.FindPhaseFileForTask --> DocsPhasesMd : "searches for task in phase files"

' Discussion Session (Older/Alternative path)
CommandsDiscuss.RunDiscussionWithSession --> DiscussionSessionModule.DiscussionSessionClass : "manages session"
DiscussionSessionModule.DiscussionSessionClass --> WorkSessionModule.CreateSession : "creates work session"
WorkSessionModule.CreateSession --[#Red,dashed]-> WorkSessionsJson : "writes work session data"
DiscussionSessionModule.DiscussionSessionClass --> BreadcrumbModule.GetBreadcrumbSummary : "gets summary"
DiscussionSessionModule.DiscussionSessionClass --> AiActions.ActionProcessorClass : "validates/executes actions"
AiActions.ActionProcessorClass <.. PatchOperationClass : "processes operations"

' Data Flows
PatchOperationClass <.. PatchOperationTypeEnum : "uses operation types"
JsonContractClass <.. ContractTypeEnum : "uses contract types"
ContractTypeEnum <.. CommandsDiscuss.HandleDiscussCommand : "determines context"

' Persistence Details
DocsConfigMd <--> FileSystem
DocsTodoMd <--> FileSystem
DocsPhasesMd <--> FileSystem
MaestroAiArtifacts <--> FileSystem
WorkSessionsJson <--> FileSystem

@enduml
