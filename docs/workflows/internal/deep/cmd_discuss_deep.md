# Command: `discuss`

## 1. Command Surface

*   **Command:** `discuss`
*   **Aliases:** `d`
*   **Handler Binding:** `maestro.main.main` dispatches to `maestro.commands.discuss.handle_discuss_command` (for general discussions), `handle_track_discuss`, `handle_phase_discuss`, or `handle_task_discuss` based on context.

## 2. Entrypoint(s)

*   **Primary Dispatcher:** `maestro.commands.discuss.handle_discuss_command(args: argparse.Namespace)` (or specific context handlers: `handle_track_discuss`, `handle_phase_discuss`, `handle_task_discuss`)
*   **File Path:** `/home/sblo/Dev/Maestro/maestro/commands/discuss.py`

## 3. Call Chain (ordered)

The `discuss` command is highly contextual and uses a router for AI interaction.

### General Flow (`handle_discuss_command`, `handle_track_discuss`, `handle_phase_discuss`, `handle_task_discuss`)

1.  `maestro.main.main()` â†’ (`handle_discuss_command` or context-specific handler)
    *   **Purpose:** Entry point for the `discuss` command.
2.  `maestro.commands.discuss.choose_mode(mode_arg)`
    *   **Purpose:** Determines the discussion interface mode (editor or terminal) based on arguments, config, or environment variables.
    *   **Internal Call Chain:** `maestro.data.parse_config_md("docs/config.md")`.
3.  `maestro.commands.discuss.run_discussion_with_router(initial_prompt, contract_type, engine, mode)`
    *   **Purpose:** Orchestrates the core AI interaction.
    *   **Internal Call Chain:**
        1.  `maestro.ai.manager.AiEngineManager()`: Initializes AI manager.
        2.  `maestro.ai.discussion_router.DiscussionRouter(manager)`: Initializes discussion router.
        3.  Selection of `JsonContract` (e.g., `TrackContract`, `PhaseContract`, etc.) based on `contract_type`.
        4.  `DiscussionRouter.run_discussion(...)`: The AI conversational loop.
            *   This involves repeated calls to `AiEngineManager.run_once` (to interact with the AI engine) and internal parsing/validation of AI responses against the selected `JsonContract`.
            *   It returns a list of `PatchOperation` objects.
4.  `maestro.commands.discuss.save_discussion_artifacts(...)`
    *   **Purpose:** Persists the discussion details (transcript, AI-generated operations) to `.maestro/ai/artifacts/`.
5.  **Preview of Proposed Changes:**
    *   Iterates through returned `patch_operations` and prints a human-readable summary.
6.  **User Confirmation / Dry Run:**
    *   If not `dry_run`, prompts the user for confirmation (`input()`).
7.  `maestro.commands.discuss.apply_patch_operations(patch_operations)`
    *   **Purpose:** Executes the AI-generated changes.
    *   **Internal Call Chain:** Iterates through `PatchOperation`s and calls appropriate `maestro.data.markdown_writer` functions (e.g., `insert_track_block`, `update_task_metadata`).
8.  `maestro.commands.discuss.update_artifact_status(session_id, status, applied_operations)`
    *   **Purpose:** Updates the status of the saved discussion artifacts.
9.  `maestro.modules.utils.print_header(...)`, `print()`
    *   **Purpose:** Provides formatted console output.

### `run_discussion_with_session` (Older/Alternative Flow, not main discuss entry)

This function, though present, appears to be an older approach or for specific internal use cases, as the main `handle_discuss_command` and specific context handlers (`handle_track_discuss`, etc.) route directly to `run_discussion_with_router`.

1.  `DiscussionSession.run_editor_mode()` or `DiscussionSession.run_terminal_mode()`
    *   **Purpose:** Runs the actual interactive AI discussion.
2.  `maestro.ai.ActionProcessor()`
    *   **Purpose:** Validates and executes actions generated by the discussion.
3.  `ActionProcessor.validate_actions(actions, context.allowed_actions)`
4.  `ActionProcessor.execute_actions(actions)`
5.  `maestro.breadcrumb.get_breadcrumb_summary(discussion_session.work_session.session_id)`
    *   **Purpose:** Provides a summary of the work session.

## 4. Core Data Model Touchpoints

*   **Reads:**
    *   `docs/config.md`: For default discussion mode.
    *   `docs/todo.md`, `docs/phases/*.md`: To extract context for AI or apply changes.
    *   Environment variables: `EDITOR`, `VISUAL`.
*   **Writes:**
    *   `docs/todo.md`, `docs/phases/*.md`: Modified by `apply_patch_operations` based on AI proposals.
    *   `.maestro/ai/artifacts/*.txt`, `.maestro/ai/artifacts/*.json`: For saving discussion transcripts and JSON operation results.
    *   `docs/state/work_sessions.json`: Managed by `maestro.work_session` (via `create_discussion_session`).
*   **Schema:** The AI-generated operations must conform to the `JsonContract` schema specific to the discussion context (Global, Track, Phase, Task). `PatchOperation` objects are the internal representation.

## 5. Configuration & Globals

*   `os.environ.get('EDITOR', 'vim')`, `os.environ.get('VISUAL')`: User's preferred editor.
*   `docs/config.md`: Source for default `discussion_mode`.
*   `.maestro/ai/artifacts/`: Directory for discussion artifacts.
*   `maestro.ai.manager.AiEngineManager`: Provides an abstracted interface to AI engines.

## 6. Validation & Assertion Gates

*   **Contract-Based Validation:** `DiscussionRouter` uses `JsonContract`s to strictly validate AI's JSON output.
*   **Action Validation:** `ActionProcessor.validate_actions` ensures AI-generated actions are valid for the given context.
*   **User Confirmation:** Critical before applying changes.
*   **File Existence:** Checked by `apply_patch_operations` and other file I/O.
*   **Argument Validation:** `argparse` and internal checks for required context (`track_id`, etc.).

## 7. Side Effects

*   Invokes AI engines, potentially for multiple turns.
*   Modifies project Markdown files (`docs/todo.md`, `docs/phases/*.md`).
*   Creates persistent discussion artifacts (`.maestro/ai/artifacts/`).
*   Opens user's editor for `editor` mode discussions.
*   Creates work session records.
*   Prints extensive, formatted output to the console.

## 8. Error Semantics

*   `print_error` and `sys.exit(1)` for critical failures.
*   `DecodeError` (from `JsonContract` validation) are handled internally by the `DiscussionRouter`.
*   Errors during `apply_patch_operations` can lead to partial application or user notification.

## 9. Existing Tests & Coverage Gaps

*   **Tests:**
    *   `maestro/tests/commands/test_discuss.py` for CLI command behavior.
    *   `maestro/tests/ai/test_discussion_router.py` for AI conversational flow and contract validation.
    *   Unit tests for `apply_patch_operations` covering all `PatchOperationType`s.
    *   Integration tests covering the entire flow from initial prompt to applied changes, possibly with mocked AI responses.
    *   Tests for artifact saving and status updates.
*   **Coverage Gaps:**
    *   Comprehensive testing of all `JsonContract` types and their specific validation rules.
    *   Robustness testing for complex or conflicting `PatchOperation` sequences.
    *   Testing of `choose_mode` logic under various environment configurations.
    *   Testing of the `editor` mode of discussion.
    *   Ensure graceful recovery from AI errors or unexpected output formats.
