@startuml subsystem_session_store
!include _shared.puml

' MODULE: SessionModel, "maestro/session_model.py"
rectangle "Session" as SessionClass <<Class>>
        --

rectangle "Subtask" as SubtaskClass <<Class>>
        --

rectangle "PlanNode" as PlanNodeClass <<Class>>
        --

rectangle "load_session(path)" as LoadSession <<Function>>
rectangle "save_session(session, path)" as SaveSession <<Function>>

    RECTANGLE(SessionStatuses, "SESSION_STATUSES") #LightBlue
    RECTANGLE(SubtaskStatuses, "SUBTASK_STATUSES") #LightBlue

' MODULE: StandardLib, "Standard Libraries"
rectangle "json.load()" as JsonLoad <<Function>>
rectangle "json.dump()" as JsonDump <<Function>>
rectangle "open()" as Open <<Function>>

rectangle "Session JSON File" as SessionJsonFile <<Data Store>>
rectangle "Operating System (FS)" as OperatingSystem <<Data Store>>

' Relationships between classes
SessionClass "1" *-- "0..*" SubtaskClass : contains
SessionClass "1" *-- "0..*" PlanNodeClass : manages

' Load Session Flow
LoadSession --> Open : "Reads file"
LoadSession --> JsonLoad : "Parses JSON"
LoadSession --> SessionClass.from_dict : "Deserializes to Session obj"
SessionClass.from_dict --> SubtaskClass.from_dict : "Deserializes subtasks"
SessionClass.from_dict --> PlanNodeClass.from_dict : "Deserializes plan nodes"

JsonLoad -[dashed]-> SessionJsonFile : "Reads content"
Open -[dashed]-> OperatingSystem : "Accesses file system"

' Save Session Flow
SaveSession --> SessionClass.to_dict : "Serializes Session obj to dict"
SessionClass.to_dict --> SubtaskClass.to_dict : "Serializes subtasks"
SessionClass.to_dict --> PlanNodeClass.to_dict : "Serializes plan nodes"
SaveSession --> JsonDump : "Writes dict as JSON"
SaveSession --> Open : "Opens file"

JsonDump --[#Red,dashed]-> SessionJsonFile : "Writes content"
Open --[#Red,dashed]-> OperatingSystem : "Accesses file system"

' Validation gates
SessionClass.from_dict -[#Blue]-> SessionJsonFile : "Implicit Key/Schema Validation"
SessionClass.from_dict -[#Blue]-> SessionJsonFile : "Backward Compatibility Logic"
LoadSession -[#Blue]-> SessionJsonFile : "File existence (FileNotFoundError)"
LoadSession -[#Blue]-> SessionJsonFile : "JSON format (json.JSONDecodeError)"

@enduml
