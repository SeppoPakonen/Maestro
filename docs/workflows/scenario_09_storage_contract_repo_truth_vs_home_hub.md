---
id: WF-09
title: "Storage Contract: Repo Truth vs. Home Hub (Read-only Rules)"
tags: [storage, truth, home-hub, readonly, paths, policy, contract]
entry_conditions: "Any Maestro command that reads or writes state is executed."
exit_conditions: "The command has correctly resolved paths and completed its read/write operations according to the rules."
artifacts_created:
  - "Potentially, project-local truth files under `./docs/maestro/`."
  - "Potentially, user-global files under `$HOME/.maestro/`."
failure_semantics: "Hard stop if an illegal write is attempted (e.g., writing to `./docs/maestro/` in read-only mode). Hard stop if the forbidden `./.maestro` path is encountered."
related_commands: ["repo", "resolve", "build", "work", "wsession"]
---

# WF-09: Storage Contract — Repo Truth vs. Home Hub

This workflow is the canonical “storage constitution” for Maestro. It defines where different classes of data live, what processes may write to them, and how read-only mode restricts behavior. All other workflows that involve state or file I/O must adhere to this contract.

## 1. Data Class Definitions

We classify all persistent data into one of the following categories.

### Truth (Canonical Project State)

This is the authoritative, version-controllable state of a project as understood by Maestro.

-   **Location:** `./docs/maestro/`
-   **Characteristics:**
    -   **Git-Friendly:** Designed to be committed to a Git repository. It is composed of multiple, human-readable files with a stable structure.
    -   **Parseable:** The structure must be valid and parseable. An invalid structure is a hard stop for any stateful workflow (`build`, `work`, etc.).
    -   **Source of All Derivations:** All derived artifacts are ultimately generated from this truth.

### Home Hub (User-Global Authoritative Registry & Read-only Output Store)

This is a user-specific, global directory managed by Maestro to track repositories and store outputs that should not live inside a project repository.

-   **Location:** `$HOME/.maestro/` (with specific subdirectories like `repo/` for outputs).
-   **Characteristics:**
    -   **User-Global:** Shared across all Maestro-enabled repositories for a given user.
    -   **Authoritative Registry:** Contains an index or registry of all repositories Maestro has encountered, allowing for cross-repo linking and operations.
    -   **Read-only Output Store:** Serves as the designated write location for commands running in read-only mode (e.g., `repo scan`).
    -   **Persistent Cache:** May contain caches that are allowed to persist across different repositories.

### Derived Artifacts

These are files generated by Maestro from either Truth or a direct scan of the repository.

-   **Location Policy:**
    -   **Repo-Local (Versioned):** If an artifact is intended to be versioned with the project (e.g., a build plan, a requirements file), it should be written to a suitable location within the repository (but **never** directly into `./docs/maestro/` unless it is part of the truth itself).
    -   **Home Hub (Read-only/Ephemeral):** If the artifact is the output of a read-only scan or is for temporary user review, it is written to `$HOME/.maestro/repo/`.

### Ephemeral / IPC (Inter-Process Communication)

These are temporary artifacts required for a single run of a Maestro command.

-   **Location Policy:**
    -   **Preferred:** `$HOME/.maestro/tmp/` or a system-provided temporary directory.
    -   **Allowed (with caution):** A repo-local temporary directory if its lifecycle is explicitly managed and it does not pollute the Git index.
-   **Cleanup:** These artifacts should be cleaned up at the end of the command execution. Lockfiles must be released, and temporary state files should be deleted.

## 2. Allowed Write Matrix

The permission to write to a location depends on the operational mode of the command.

| Operational Mode                  | May Write to `./docs/maestro/` | May Write to `$HOME/.maestro/` |
| --------------------------------- | ------------------------------ | ------------------------------ |
| **Stateful** (Project is adopted) | ✅ **Yes**                     | ✅ **Yes**                     |
| **Read-only** (e.g., `repo scan`) | ❌ **No**                      | ✅ **Yes**                     |

## 3. The Forbidden Path Rule: `./.maestro`

The path `./.maestro` is strictly forbidden.

-   **Status:** Its presence in any repository is a bug.
-   **Reason:** Early versions of Maestro used this path, but it was moved to `./docs/maestro/` to improve discoverability, Git-friendliness, and clarity.
-   **Action:** All code, documentation, and tests must use `./docs/maestro/` as the path for canonical project truth. Any logic referencing `./.maestro` must be corrected.

## 4. Decision Points

The storage logic is governed by two primary questions:

1.  **"Is this repository adopted?"**
    -   **Check:** Does the directory `./docs/maestro/` exist and contain a parseable project configuration?
    -   **Impact:** If yes, the repository is in "Stateful" mode. If no, commands that require truth (like `build`) will fail, while others may operate in a limited or "Read-only" capacity.

2.  **"Is read-only mode requested?"**
    -   **Check:** This is an operational mode, not necessarily a single CLI flag. It is determined by the command being run (e.g., `repo scan` is always read-only) or will be an explicit flag (`--read-only`). *(Policy, not yet fully implemented as a global flag)*.
    -   **Impact:** If yes, the "Read-only" column of the write matrix applies. Writes to `./docs/maestro/` are blocked.

## 5. Linking Rules (Home Hub Index)

The Home Hub acts as a central registry for Maestro.

-   **Purpose:** The directory `$HOME/.maestro/repo` contains an index of all repositories Maestro has analyzed.
-   **Schema (Proposed Minimal):** For each repo, it should store a stable identifier to map outputs and metadata.
    -   `repo_id`: A stable hash of a canonical repository identifier (e.g., the absolute path or remote URL).
    -   `canonical_path`: The absolute path to the repository on the user's filesystem.
    -   `metadata`: Timestamps of last scan, etc.
    -   `outputs/`: A directory to store read-only scan results for that repository.
-   **Use Case:** This allows future features like cross-repo analysis or linking conversions between different project checkouts.

## 6. Tests Implied by WF-09

This workflow contract implies a suite of tests to ensure compliance.

-   **Unit Tests:**
    -   A path resolution utility must never return `./.maestro`.
    -   A test attempting to write to `./docs/maestro/` in a simulated read-only mode must raise an exception.
    -   A test attempting to write to `./docs/maestro/` in a simulated stateful mode must succeed.
    -   A test attempting to write to `$HOME/.maestro/repo/` in either mode must succeed.

-   **Integration Tests:**
    -   Run a `repo scan` command on a project. Verify that the only filesystem changes occur within `$HOME/.maestro/`.
    -   Run a project adoption/initialization command (`maestro init`). Verify that `./docs/maestro/` is created and its contents are correctly added to Git.
